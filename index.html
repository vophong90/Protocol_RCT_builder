<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Wizard Äá» cÆ°Æ¡ng RCT</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <script> pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';</script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script>mermaid.initialize({ startOnLoad: false });</script>

  <style>
    body { font-family: Arial; padding: 20px; }
    .step { display: none; }
    .step.active { display: block; }
    .steps-nav { display: flex; gap: 10px; margin-bottom: 20px; }
    .steps-nav button {
      padding: 8px 12px;
      border: none;
      background-color: #ddd;
      cursor: pointer;
    }
    .steps-nav button.active {
      background-color: #4CAF50;
      color: white;
    }
    textarea, input[type="text"] {
      width: 100%;
      margin-top: 5px;
      margin-bottom: 10px;
      padding: 6px;
    }
  .gpt-suggest, .gpt-eval {
    white-space: pre-wrap;
    padding: 10px;
    border: 1px solid #ccc;
    margin-top: 5px;
  }
  .gpt-suggest { background: #eef; }
  .gpt-eval { background: #efe; }

  #variable-groups {
    display: flex;
    flex-direction: column;
    gap: 20px;
    margin-top: 20px;
  }
  .variable-group {
    display: flex;
    flex-direction: column;
    border: 1px solid #ccc;
    padding: 10px;
    border-radius: 8px;
  }
  .variable-group h4 {
    margin: 0;
  }
  .variable-group .description {
    font-style: italic;
    margin-bottom: 10px;
  }
  .variable-lists {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
  }
  .variable-list {
    flex: 1;
    min-width: 250px;
    min-height: 150px;
    border: 1px dashed #999;
    padding: 10px;
    border-radius: 6px;
    background: #fafafa;
  }
  .variable-list li {
  position: relative;
  padding: 4px 8px;
  padding-right: 40px;
  background: #eee;
  border: 1px solid #ccc;
  border-radius: 4px;
  margin-bottom: 6px;
  cursor: grab;
  min-height: 32px;
  line-height: 20px;
  overflow: visible;
}

 .variable-list li button {
  position: absolute;
  top: 4px;
  right: 6px;
  background: none;
  border: none;
  color: red;
  cursor: pointer;
  font-size: 16px;
  z-index: 2;
}


  .collection-block {
    border: 1px solid #ccc;
    padding: 15px;
    margin: 15px 0;
    border-radius: 6px;
    background-color: #f9f9f9;
  }

  .collection-block label {
    font-weight: bold;
    margin-top: 10px;
    display: block;
  }

  .collection-block input,
  .collection-block textarea {
    width: 100%;
    margin-bottom: 10px;
    padding: 6px;
    box-sizing: border-box;
  }
  .analysis-block {
    border: 1px solid #ccc;
    padding: 15px;
    margin: 15px 0;
    border-radius: 6px;
    background-color: #f9f9f9;
  }

  .analysis-block label {
    font-weight: bold;
    margin-top: 10px;
    display: block;
  }

  .analysis-block input,
  .analysis-block textarea {
    width: 100%;
    margin-bottom: 10px;
    padding: 6px;
    box-sizing: border-box;
  }
  #step-11 input,
  #step-11 textarea {
    width: 100%;
    margin-bottom: 10px;
    padding: 6px;
    box-sizing: border-box;
  }

  #step-11 label {
    font-weight: bold;
    margin-top: 10px;
    display: block;
  }
 input[type="text"], input[type="number"], select, textarea {
  border: 1px solid #ccc;
  border-radius: 6px;
  padding: 10px;
  font-size: 15px;
  font-family: 'Segoe UI', 'Roboto', sans-serif;
  background-color: #fff;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  transition: border-color 0.2s, box-shadow 0.2s;
 }

 input[type="text"]:focus, input[type="number"]:focus,
  select:focus, textarea:focus {
  border-color: #4CAF50;
  outline: none;
  box-shadow: 0 0 5px rgba(76, 175, 80, 0.5);
 }

</style>
</head>
<body>

  <h1>XÃ¢y dá»±ng Ä‘á» cÆ°Æ¡ng RCT â€“ Wizard Demo</h1>

  <!-- Thanh Ä‘iá»u hÆ°á»›ng -->
  <div class="steps-nav">
    <button onclick="goToStep(0)" id="nav-0">1. PICO</button>
    <button onclick="goToStep(1)" id="nav-1">2. CÃ¢u há»i</button>
    <button onclick="goToStep(2)" id="nav-2">3. Má»¥c tiÃªu</button>
    <button onclick="goToStep(3)" id="nav-3">4. Má»Ÿ Ä‘áº§u</button>
    <button onclick="goToStep(4)" id="nav-4">5. Tá»•ng quan</button>
    <button onclick="goToStep(5)" id="nav-5">6. Thiáº¿t káº¿</button>
    <button onclick="goToStep(6)" id="nav-6">7. Cá»¡ máº«u</button>
    <button onclick="goToStep(7)" id="nav-7">8. TiÃªu chÃ­</button>
    <button onclick="goToStep(8)" id="nav-8">9. Ngáº«u nhiÃªn</button>
    <button onclick="goToStep(9)" id="nav-9">10. Can thiá»‡p</button>
    <button onclick="goToStep(10)" id="nav-10">11. Biáº¿n sá»‘</button>
    <button onclick="goToStep(11)" id="nav-11">12. Thu tháº­p</button>
    <button onclick="goToStep(12)" id="nav-12">13. PhÃ¢n tÃ­ch</button>
    <button onclick="goToStep(13)" id="nav-13">14. Äáº¡o Ä‘á»©c</button>
    <button onclick="goToStep(14)" id="nav-14">15. Check logic</button>
    <button onclick="goToStep(15)" id="nav-15">16. SÆ¡ Ä‘á»“</button>
  </div>

  <!-- BÆ°á»›c 1: PICO -->
  <div class="step" id="step-0">
    <h2>BÆ°á»›c 1: PICO</h2>
    <label>P - DÃ¢n sá»‘ má»¥c tiÃªu:</label>
    <input type="text" id="pico-p" oninput="saveData()">

    <label>I - Can thiá»‡p:</label>
    <input type="text" id="pico-i" oninput="saveData()">

    <label>C - So sÃ¡nh:</label>
    <input type="text" id="pico-c" oninput="saveData()">
  
    <label>O - Káº¿t cá»¥c:</label>
    <input type="text" id="pico-o" oninput="saveData()">
    <br>
    <h3>Káº¿t quáº£ tá»« GPT:</h3>
    <label>ğŸ“‚ Táº£i tÃ i liá»‡u PDF há»— trá»£ (náº¿u cÃ³):</label>
    <input type="file" id="pico-file" accept=".pdf" multiple><br><br>
    <button onclick="generatePicoDescription()">ğŸ§  GPT viáº¿t mÃ´ táº£ tá»« PICO</button>
    <div id="pico-gpt-result" style="white-space: pre-wrap; background: #f4f4f4; padding: 10px; border: 1px solid #ccc;"></div>
    <br>
    <button disabled>â¬…ï¸</button>
    <button onclick="goToStep(1)">Tiáº¿p â¡ï¸</button>
    <br><br>
    <button onclick="resetWizard()" style="margin-bottom:20px; background:red; color:white; padding:8px 12px; border:none; border-radius:6px; cursor:pointer;">ğŸ—‘ XÃ³a toÃ n bá»™ dá»¯ liá»‡u vÃ  báº¯t Ä‘áº§u láº¡i</button>
  </div>

  <!-- BÆ°á»›c 2: CÃ¢u há»i nghiÃªn cá»©u -->
  <div class="step" id="step-1">
    <h2>BÆ°á»›c 2: CÃ¢u há»i nghiÃªn cá»©u</h2>
    <label for="question">Nháº­p cÃ¢u há»i:</label>
    <textarea id="question" oninput="saveData()"></textarea><br><br>
    <h3>Káº¿t quáº£ tá»« GPT:</h3>
    <label>ğŸ“‚ Táº£i tÃ i liá»‡u PDF há»— trá»£ (náº¿u cÃ³):</label>
    <input type="file" id="question-file" accept=".pdf" multiple><br>
    <button onclick="generateResearchQuestionFromGPT()">ğŸ§  GPT gá»£i Ã½ cÃ¢u há»i tá»« tÃ i liá»‡u</button>
    <div id="question-gpt-suggestion" style="white-space: pre-wrap; background: #eef; padding: 10px; border: 1px solid #99c;"></div>
    <button onclick="evaluateResearchQuestion()">ğŸ§ GPT Ä‘Ã¡nh giÃ¡ cÃ¢u há»i</button>
    <div id="question-gpt-evaluation" style="white-space: pre-wrap; background: #efe; padding: 10px; border: 1px solid #9c9;"></div>
    
    <br><br>
    <button onclick="goToStep(0)">â¬…ï¸ Quay láº¡i</button>
    <button onclick="goToStep(2)">Tiáº¿p â¡ï¸</button>
  </div>

  <!-- BÆ°á»›c 3: Má»¥c tiÃªu nghiÃªn cá»©u -->
  <div class="step" id="step-2">
    <h2>BÆ°á»›c 3: Má»¥c tiÃªu nghiÃªn cá»©u</h2>

    <label>Má»¥c tiÃªu chÃ­nh:</label>
    <input type="text" id="main-objective" oninput="saveData()">
    
    <label>Má»¥c tiÃªu phá»¥:</label>
    <div id="sub-objectives"></div>
    <button onclick="addSubObjective()">â• ThÃªm má»¥c tiÃªu phá»¥</button>
    <br><br>
    <h3>Káº¿t quáº£ tá»« GPT:</h3>
    <label>ğŸ“‚ Táº£i tÃ i liá»‡u PDF há»— trá»£ (náº¿u cÃ³):</label>
    <input type="file" id="objective-file" accept=".pdf" multiple><br>
    <button onclick="generateObjectivesFromGPT()">ğŸ§  GPT gá»£i Ã½ má»¥c tiÃªu tá»« tÃ i liá»‡u</button>
    <div id="objective-gpt-suggestion" style="white-space: pre-wrap; background: #eef; padding: 10px; border: 1px solid #99c;"></div>
    <button onclick="evaluateObjectives()">ğŸ§ GPT Ä‘Ã¡nh giÃ¡ má»¥c tiÃªu hiá»‡n táº¡i</button>
    <div id="objective-gpt-evaluation" style="white-space: pre-wrap; background: #efe; padding: 10px; border: 1px solid #9c9;"></div>
    <br>
    <button onclick="goToStep(1)">â¬…ï¸ Quay láº¡i</button>
    <button onclick="goToStep(3)">Tiáº¿p â¡ï¸</button>
  </div>

<!-- BÆ°á»›c 4: Má»Ÿ Ä‘áº§u - theo CaRS, tÃ¡ch 3 pháº§n -->
<div class="step" id="step-3">
  <h2>BÆ°á»›c 4: Má»Ÿ Ä‘áº§u (CaRS)</h2>

  <!-- TERRITORY -->
  <h3>1. Territory - Bá»‘i cáº£nh nghiÃªn cá»©u</h3>
  <label>Táº£i tÃ i liá»‡u PDF há»— trá»£ (náº¿u cÃ³):</label>
  <input type="file" id="file-territory" accept=".pdf">
  <br>
  <label>Nháº­p ná»™i dung Territory:</label>
  <textarea id="intro-territory" rows="5" style="width:100%"></textarea>
  <br>
  <button onclick="generateGPT_Territory()">ğŸ§  GPT gá»£i Ã½ Territory</button>
  <div id="suggest-territory" style="white-space: pre-wrap; background: #eef; padding: 10px; border: 1px solid #99c;"></div>
  <button onclick="evaluateGPT_Territory()">ğŸ§ GPT Ä‘Ã¡nh giÃ¡ Territory</button>
  <div id="eval-territory" style="white-space: pre-wrap; background: #efe; padding: 10px; border: 1px solid #9c9;"></div>

  <!-- NICHE -->
  <h3>2. Niche - Khoáº£ng trá»‘ng kiáº¿n thá»©c</h3>
  <label>Táº£i tÃ i liá»‡u PDF há»— trá»£ (náº¿u cÃ³):</label>
  <input type="file" id="file-niche" accept=".pdf">
  <br>
  <label>Nháº­p ná»™i dung Niche:</label>
  <textarea id="intro-niche" rows="5" style="width:100%"></textarea>
  <br>
  <button onclick="generateGPT_Niche()">ğŸ§  GPT gá»£i Ã½ Niche</button>  
  <div id="suggest-niche" style="white-space: pre-wrap; background: #eef; padding: 10px; border: 1px solid #99c;"></div>
  <button onclick="evaluateGPT_Niche()">ğŸ§ GPT Ä‘Ã¡nh giÃ¡ Niche</button>
  <div id="eval-niche" style="white-space: pre-wrap; background: #efe; padding: 10px; border: 1px solid #9c9;"></div>

  <!-- OCCUPY -->
  <h3>3. Occupy - CÃ¡ch nghiÃªn cá»©u chiáº¿m lÄ©nh khoáº£ng trá»‘ng</h3>
  <label>Táº£i tÃ i liá»‡u PDF há»— trá»£ (náº¿u cÃ³):</label>
  <input type="file" id="file-occupy" accept=".pdf">
  <br>
  <label>Nháº­p ná»™i dung Occupy:</label>
  <textarea id="intro-occupy" rows="5" style="width:100%"></textarea>
  <br>
  <button onclick="generateGPT_Occupy()">ğŸ§  GPT gá»£i Ã½ Occupy</button>
  <div id="suggest-occupy" style="white-space: pre-wrap; background: #eef; padding: 10px; border: 1px solid #99c;"></div>
  <button onclick="evaluateGPT_Occupy()">ğŸ§ GPT Ä‘Ã¡nh giÃ¡ Occupy</button>
  <div id="eval-occupy" style="white-space: pre-wrap; background: #efe; padding: 10px; border: 1px solid #9c9;"></div>

  <br>
  <button onclick="goToStep(2)">â¬…ï¸ Quay láº¡i</button>
  <button onclick="goToStep(4)">Tiáº¿p â¡ï¸</button>
</div>

<!-- BÆ°á»›c 5: Tá»•ng quan tÃ i liá»‡u -->
<div class="step" id="step-4">
  <h2>BÆ°á»›c 5: Tá»•ng quan tÃ i liá»‡u</h2>

  <!-- 1. Äáº¡i cÆ°Æ¡ng YHHÄ -->
  <h3>1. Äáº¡i cÆ°Æ¡ng YHHÄ</h3>
  <input type="file" id="file-yhhd-overview" accept=".pdf">
  <textarea id="text-yhhd-overview" rows="5" style="width:100%"></textarea>
  <button onclick="generateGPT_YHHD_Overview()">ğŸ§  GPT gá»£i Ã½</button>
  <div id="suggest-yhhd-overview" class="gpt-suggest"></div>
  <button onclick="evaluateGPT_YHHD_Overview()">ğŸ§ GPT Ä‘Ã¡nh giÃ¡</button>
  <div id="eval-yhhd-overview" class="gpt-eval"></div>

  <!-- 2. Dá»‹ch tá»… há»c vÃ  gÃ¡nh náº·ng bá»‡nh táº­t -->
  <h3>2. Dá»‹ch tá»… há»c vÃ  gÃ¡nh náº·ng bá»‡nh táº­t</h3>
  <input type="file" id="file-epidemiology" accept=".pdf">
  <textarea id="text-epidemiology" rows="5" style="width:100%"></textarea>
  <button onclick="generateGPT_Epidemiology()">ğŸ§  GPT gá»£i Ã½</button>
  <div id="suggest-epidemiology" class="gpt-suggest"></div>
  <button onclick="evaluateGPT_Epidemiology()">ğŸ§ GPT Ä‘Ã¡nh giÃ¡</button>
  <div id="eval-epidemiology" class="gpt-eval"></div>

  <!-- 3. Cháº©n Ä‘oÃ¡n YHHÄ -->
  <h3>3. Cháº©n Ä‘oÃ¡n YHHÄ</h3>
  <input type="file" id="file-diagnosis" accept=".pdf">
  <textarea id="text-diagnosis" rows="5" style="width:100%"></textarea>
  <button onclick="generateGPT_Diagnosis()">ğŸ§  GPT gá»£i Ã½</button>
  <div id="suggest-diagnosis" class="gpt-suggest"></div>
  <button onclick="evaluateGPT_Diagnosis()">ğŸ§ GPT Ä‘Ã¡nh giÃ¡</button>
  <div id="eval-diagnosis" class="gpt-eval"></div>

  <!-- 4. Äiá»u trá»‹ YHHÄ -->
  <h3>4. Äiá»u trá»‹ YHHÄ</h3>
  <input type="file" id="file-treatment" accept=".pdf">
  <textarea id="text-treatment" rows="5" style="width:100%"></textarea>
  <button onclick="generateGPT_Treatment()">ğŸ§  GPT gá»£i Ã½</button>
  <div id="suggest-treatment" class="gpt-suggest"></div>
  <button onclick="evaluateGPT_Treatment()">ğŸ§ GPT Ä‘Ã¡nh giÃ¡</button>
  <div id="eval-treatment" class="gpt-eval"></div>

  <!-- 5. Háº¡n cháº¿ cá»§a YHHÄ -->
  <h3>5. Háº¡n cháº¿ cá»§a YHHÄ trong quáº£n lÃ½ tÃ¬nh tráº¡ng/bá»‡nh</h3>
  <input type="file" id="file-limitation" accept=".pdf">
  <textarea id="text-limitation" rows="5" style="width:100%"></textarea>
  <button onclick="generateGPT_Limitation()">ğŸ§  GPT gá»£i Ã½</button>
  <div id="suggest-limitation" class="gpt-suggest"></div>
  <button onclick="evaluateGPT_Limitation()">ğŸ§ GPT Ä‘Ã¡nh giÃ¡</button>
  <div id="eval-limitation" class="gpt-eval"></div>

  <!-- 6. Äáº¡i cÆ°Æ¡ng YHCT -->
  <h3>6. Äáº¡i cÆ°Æ¡ng YHCT</h3>
  <input type="file" id="file-yhct-overview" accept=".pdf">
  <textarea id="text-yhct-overview" rows="5" style="width:100%"></textarea>
  <button onclick="generateGPT_YHCT_Overview()">ğŸ§  GPT gá»£i Ã½</button>
  <div id="suggest-yhct-overview" class="gpt-suggest"></div>
  <button onclick="evaluateGPT_YHCT_Overview()">ğŸ§ GPT Ä‘Ã¡nh giÃ¡</button>
  <div id="eval-yhct-overview" class="gpt-eval"></div>

  <!-- 7. Liá»‡u phÃ¡p can thiá»‡p trong nghiÃªn cá»©u -->
  <h3>7. Liá»‡u phÃ¡p can thiá»‡p trong nghiÃªn cá»©u</h3>
  <input type="file" id="file-intervention" accept=".pdf">
  <textarea id="text-intervention" rows="5" style="width:100%"></textarea>
  <button onclick="generateGPT_Intervention()">ğŸ§  GPT gá»£i Ã½</button>
  <div id="suggest-intervention" class="gpt-suggest"></div>
  <button onclick="evaluateGPT_Intervention()">ğŸ§ GPT Ä‘Ã¡nh giÃ¡</button>
  <div id="eval-intervention" class="gpt-eval"></div>

  <!-- 8. CÃ¡c nghiÃªn cá»©u cÃ¹ng loáº¡i trong & ngoÃ i nÆ°á»›c -->
  <h3>8. CÃ¡c nghiÃªn cá»©u cÃ¹ng loáº¡i trong & ngoÃ i nÆ°á»›c</h3>
  <input type="file" id="file-related-studies" accept=".pdf">
  <textarea id="text-related-studies" rows="5" style="width:100%"></textarea>
  <button onclick="generateGPT_RelatedStudies()">ğŸ§  GPT gá»£i Ã½</button>
  <div id="suggest-related-studies" class="gpt-suggest"></div>
  <button onclick="evaluateGPT_RelatedStudies()">ğŸ§ GPT Ä‘Ã¡nh giÃ¡</button>
  <div id="eval-related-studies" class="gpt-eval"></div>

  <!-- 9. CÃ¡c phÆ°Æ¡ng phÃ¡p má»›i phÃ¢n tÃ­ch/dá»¯ liá»‡u -->
  <h3>9. CÃ¡c phÆ°Æ¡ng phÃ¡p má»›i trong phÃ¢n tÃ­ch sá»‘ liá»‡u hay Ä‘Ã¡nh giÃ¡ sá»‘ liá»‡u</h3>
  <input type="file" id="file-new-methods" accept=".pdf">
  <textarea id="text-new-methods" rows="5" style="width:100%"></textarea>
  <button onclick="generateGPT_NewMethods()">ğŸ§  GPT gá»£i Ã½</button>
  <div id="suggest-new-methods" class="gpt-suggest"></div>
  <button onclick="evaluateGPT_NewMethods()">ğŸ§ GPT Ä‘Ã¡nh giÃ¡</button>
  <div id="eval-new-methods" class="gpt-eval"></div>

  <br><br>
  <button onclick="goToStep(3)">â¬…ï¸ Quay láº¡i</button>
  <button onclick="goToStep(5)">Tiáº¿p â¡ï¸</button>
</div>

<!-- BÆ°á»›c 6: Thiáº¿t káº¿ nghiÃªn cá»©u -->
<div class="step" id="step-5">
  <h2>BÆ°á»›c 6: Thiáº¿t káº¿ nghiÃªn cá»©u</h2>

  <label>ğŸ“˜ Loáº¡i RCT:</label>
  <select id="design-type" onchange="updateDesignFields(); saveData(); renderStudyFlowDiagram()">
    <option value="">-- chá»n --</option>
    <option value="parallel">Song song</option>
    <option value="cross-over">Báº¯t chÃ©o (cross-over)</option>
  </select>

  <label>ğŸ² PhÃ¢n bá»• ngáº«u nhiÃªn:</label>
  <select id="randomization" onchange="saveData()">
    <option value="">-- chá»n --</option>
    <option>Ngáº«u nhiÃªn Ä‘Æ¡n giáº£n</option>
    <option>Ngáº«u nhiÃªn phÃ¢n táº§ng</option>
    <option>Ngáº«u nhiÃªn block</option>
  </select>

  <label>ğŸ™ˆ LÃ m mÃ¹:</label>
  <select id="blinding" onchange="saveData()">
    <option value="">-- chá»n --</option>
    <option>KhÃ´ng mÃ¹</option>
    <option>LÃ m mÃ¹ Ä‘Æ¡n</option>
    <option>LÃ m mÃ¹ Ä‘Ã´i</option>
    <option>LÃ m mÃ¹ ba</option>
  </select>
  <br><br>
  <!-- Khá»‘i xuáº¥t hiá»‡n tÃ¹y theo loáº¡i thiáº¿t káº¿ -->
  <div id="design-extra-fields" style="margin-top: 15px;"></div>
  
  <h3>Káº¿t quáº£ tá»« GPT:</h3>
  <label>ğŸ“‚ Táº£i tÃ i liá»‡u PDF há»— trá»£ (náº¿u cÃ³):</label>
  <input type="file" id="file-design" accept="application/pdf"><br>
  <button onclick="generateGPT_Design()">ğŸ§  GPT gá»£i Ã½</button>
  <div id="suggest-design" class="gpt-suggest"></div>
  <button onclick="evaluateGPT_Design()">ğŸ§ GPT Ä‘Ã¡nh giÃ¡</button>
  <div id="eval-design" class="gpt-eval"></div>
  <br><br>
  <button onclick="goToStep(4)">â¬…ï¸ Quay láº¡i</button>
  <button onclick="goToStep(6)">Tiáº¿p â¡ï¸</button>
</div>

<!-- BÆ°á»›c 7: TÃ­nh cá»¡ máº«u -->
<div class="step" id="step-6">
  <h2>BÆ°á»›c 7: TÃ­nh cá»¡ máº«u</h2>

  <label>Chá»n loáº¡i cÃ´ng thá»©c:</label>
  <select id="sample-size-method" onchange="renderSampleSizeForm()">
    <option value="">-- Chá»n cÃ´ng thá»©c --</option>
    <option value="means">So sÃ¡nh 2 trung bÃ¬nh</option>
    <option value="noninferiority_means">Thá»­ nghiá»‡m khÃ´ng hÆ¡n kÃ©m (2 trung bÃ¬nh)</option>
    <option value="crossover_means">So sÃ¡nh trung bÃ¬nh (báº¯t chÃ©o)</option>
    <option value="proportions">So sÃ¡nh 2 tá»· lá»‡</option>
    <option value="noninferiority_prop"> Thá»­ nghiá»‡m khÃ´ng hÆ¡n kÃ©m (2 tá»· lá»‡)</option>
    <option value="crossover_props">So sÃ¡nh tá»· lá»‡ (báº¯t chÃ©o)</option>
    <option value="anova">So sÃ¡nh nhiá»u trung bÃ¬nh (ANOVA)</option>
    <option value="chisq">So sÃ¡nh nhiá»u tá»· lá»‡ (Chi-square)</option>
    <option value="survival">PhÃ¢n tÃ­ch sá»‘ng cÃ²n (Log-rank)</option>
    <option value="ancova">Repeated measures / ANCOVA</option>
  </select>

  <br><br>
  <div id="sample-size-form"></div>
  <div id="sample-size-formula" style="margin-top: 20px; font-style: italic;"></div>
  <div id="sample-size-reference" style="margin-top: 10px; color: gray; font-size: 0.9em;"></div>
  <button onclick="calculateSampleSize()">ğŸ§® TÃ­nh cá»¡ máº«u</button>
  <div id="sample-size-result" style="margin-top: 15px; font-weight: bold; color: green;"></div>
  <div id="sample-size-adjusted" style="margin-top: 5px; font-weight: bold; color: darkorange;"></div>
  <br><br>
  <h3>Káº¿t quáº£ tá»« GPT:</h3>
  <label>ğŸ“‚ Táº£i tÃ i liá»‡u PDF há»— trá»£ (náº¿u cÃ³):</label>
  <input type="file" id="file-sample-size" accept=".pdf"><br>
  <button onclick="generateSampleSizeSuggestion()">ğŸ§  GPT gá»£i Ã½ cÃ¡ch tÃ­nh</button>
  <div id="suggest-sample-size" style="white-space: pre-wrap; background: #eef; padding: 10px; border: 1px solid #99c;"></div>
  <button onclick="evaluateSampleSize()">ğŸ§ GPT Ä‘Ã¡nh giÃ¡ cá»¡ máº«u hiá»‡n táº¡i</button>
  <div id="eval-sample-size" style="white-space: pre-wrap; background: #efe; padding: 10px; border: 1px solid #9c9;"></div>
  <br>
  <button onclick="goToStep(5)">â¬…ï¸ Quay láº¡i</button>
  <button onclick="goToStep(7)">Tiáº¿p â¡ï¸</button>
</div>

<!-- BÆ°á»›c 8: TiÃªu chÃ­ chá»n vÃ  loáº¡i -->
<div class="step" id="step-7">
  <h2>BÆ°á»›c 8: TiÃªu chÃ­ chá»n vÃ  loáº¡i</h2>

  <h3>TiÃªu chÃ­ chá»n:</h3>
  <div id="inclusion-criteria"></div>
  <button onclick="addInclusionCriterion()">â• ThÃªm tiÃªu chÃ­ chá»n</button>

  <h3>TiÃªu chÃ­ loáº¡i:</h3>
  <div id="exclusion-criteria"></div>
  <button onclick="addExclusionCriterion()">â• ThÃªm tiÃªu chÃ­ loáº¡i</button>
  <br><br>
  <h3>Káº¿t quáº£ tá»« GPT:</h3>
  <label>ğŸ“‚ Táº£i tÃ i liá»‡u PDF há»— trá»£ (náº¿u cÃ³):</label>
  <input type="file" id="file-criteria" accept=".pdf"><br>
  <button onclick="generateCriteriaFromGPT()">ğŸ§  GPT gá»£i Ã½ tiÃªu chÃ­</button>
  <div id="criteria-gpt-suggestion" style="white-space: pre-wrap; background: #eef; padding: 10px; border: 1px solid #99c;"></div>
  <button onclick="evaluateCriteria()">ğŸ§ GPT Ä‘Ã¡nh giÃ¡ tiÃªu chÃ­ hiá»‡n táº¡i</button>
  <div id="criteria-gpt-evaluation" style="white-space: pre-wrap; background: #efe; padding: 10px; border: 1px solid #9c9;"></div>

  <br>
  <button onclick="goToStep(6)">â¬…ï¸ Quay láº¡i</button>
  <button onclick="goToStep(8)">Tiáº¿p â¡ï¸</button>
</div>

<!-- BÆ°á»›c 9: PhÃ¢n bá»• ngáº«u nhiÃªn -->
<div class="step" id="step-8">
  <h2>BÆ°á»›c 9: PhÃ¢n bá»• ngáº«u nhiÃªn</h2>
  <label>Sá»‘ lÆ°á»£ng nhÃ¡nh can thiá»‡p (tá»± Ä‘á»™ng láº¥y tá»« bÆ°á»›c 6):</label>
  <input type="number" id="num-arms-step9" readonly style="background-color:#f0f0f0;"><br><br>

  <label>Chá»n phÆ°Æ¡ng phÃ¡p phÃ¢n bá»•:</label>
  <select id="random-method" onchange="generateAutoRandomization(); saveData()">
    <option value="">-- Chá»n phÆ°Æ¡ng phÃ¡p --</option>
    <option value="simple">Ngáº«u nhiÃªn Ä‘Æ¡n giáº£n</option>
    <option value="block">Ngáº«u nhiÃªn theo khá»‘i</option>
    <option value="stratified">Ngáº«u nhiÃªn phÃ¢n táº§ng</option>
    <option value="minimization">Ngáº«u nhiÃªn hÃ³a tá»‘i thiá»ƒu</option>
  </select><br><br>
  <div id="random-options"></div>

  <label>MÃ´ táº£ ngáº«u nhiÃªn hÃ³a:</label>
  <textarea id="randomization-method" rows="5" oninput="saveData()"></textarea><br>
  
  <h3>Káº¿t quáº£ tá»« GPT:</h3>
  <label>ğŸ“‚ Táº£i tÃ i liá»‡u PDF há»— trá»£ (náº¿u cÃ³):</label>
  <input type="file" id="file-randomization" accept=".pdf"><br><br> 
  <button onclick="generateRandomizationSuggestion()">ğŸ§  GPT gá»£i Ã½ ná»™i dung</button>
  <div id="randomization-gpt-suggestion" style="white-space: pre-wrap; background: #eef; padding: 10px; border: 1px solid #99c;"></div>
  <button onclick="evaluateRandomization()">âœ… GPT Ä‘Ã¡nh giÃ¡ ná»™i dung Ä‘Ã£ nháº­p</button>
  <div id="randomization-gpt-evaluation" style="white-space: pre-wrap; background: #efe; padding: 10px; border: 1px solid #9c9;"></div>
  <br><br>
  <button onclick="goToStep(7)">â¬…ï¸ Quay láº¡i</button>
  <button onclick="goToStep(9)">Tiáº¿p â¡ï¸</button>
</div>

<!-- BÆ°á»›c 10: MÃ´ táº£ can thiá»‡p -->
<div class="step" id="step-9">
  <h2>BÆ°á»›c 10: MÃ´ táº£ Can thiá»‡p</h2>
  <div id="intervention-descriptions"></div>
  <br><br>
  <button onclick="goToStep(8)">â¬…ï¸ Quay láº¡i</button>
  <button onclick="goToStep(10)">Tiáº¿p â¡ï¸</button>
</div>

<!-- BÆ°á»›c 11: Biáº¿n sá»‘ nghiÃªn cá»©u -->
  <div class="step" id="step-10">
  <h2>BÆ°á»›c 11: Biáº¿n sá»‘ nghiÃªn cá»©u</h2>
  <p>Táº£i lÃªn file CSV chá»©a danh sÃ¡ch biáº¿n máº«u Ä‘Ã£ chuáº©n hÃ³a theo cÃ¡c trÆ°á»ng cáº§n thiáº¿t. Sau Ä‘Ã³, kÃ©o-tháº£ cÃ¡c biáº¿n vÃ o tá»«ng nhÃ³m bÃªn pháº£i Ä‘á»ƒ Ä‘Æ°a vÃ o nghiÃªn cá»©u.</p>
  <input type="file" id="variable-file" accept=".csv">
  <hr>
  <h3>â• ThÃªm biáº¿n má»›i:</h3>
  <div id="new-variable-form">
  <input type="text" placeholder="TÃªn biáº¿n" id="new-name">

  <select id="new-role" style="display:block; width:100%; margin-top:5px; margin-bottom:10px; padding:6px;">
    <option value="">-- Vai trÃ² --</option>
    <option value="primary">Káº¿t cá»¥c chÃ­nh</option>
    <option value="secondary">Káº¿t cá»¥c phá»¥</option>
    <option value="baseline">Biáº¿n ná»n</option>
    <option value="confounder">Biáº¿n nhiá»…u</option>
    <option value="mediator">Biáº¿n trung gian</option>
    <option value="moderator">Biáº¿n Ä‘iá»u biáº¿n</option>
    <option value="safety">Biáº¿n an toÃ n</option>
  </select>

  <select id="new-type" style="display:block; width:100%; margin-top:5px; margin-bottom:10px; padding:6px;">
    <option value="">-- Kiá»ƒu dá»¯ liá»‡u --</option>
    <option value="numeric">Sá»‘ liÃªn tá»¥c (numeric)</option>
    <option value="ordinal">Thá»© báº­c (ordinal)</option>
    <option value="categorical">PhÃ¢n loáº¡i (categorical)</option>
    <option value="binary">Nhá»‹ phÃ¢n (binary: cÃ³/khÃ´ng)</option>
    <option value="text">Chuá»—i vÄƒn báº£n (text)</option>
    <option value="date">NgÃ y thÃ¡ng (date)</option>

  </select>

  <input type="text" placeholder="ÄÆ¡n vá»‹" id="new-unit">
  <input type="text" placeholder="Thá»i Ä‘iá»ƒm Ä‘o" id="new-time">
  <input type="text" placeholder="CÃ¡ch Ä‘o lÆ°á»ng" id="new-measure">
  <input type="text" placeholder="Äá»‹nh nghÄ©a" id="new-definition">
  <input type="text" placeholder="Nguá»“n" id="new-source">

  <select id="new-format" style="display:block; width:100%; margin-top:5px; margin-bottom:10px; padding:6px;">
    <option value="">-- Äá»‹nh dáº¡ng --</option>
    <option value="float">Sá»‘ thá»±c (float)</option>
    <option value="integer">Sá»‘ nguyÃªn (integer)</option>
    <option value="string">Chuá»—i kÃ½ tá»± (string)</option>
    <option value="percent">Pháº§n trÄƒm (percent)</option>
    <option value="yes/no">CÃ³ / KhÃ´ng (yes / no)</option>
    <option value="mm/dd/yyyy">NgÃ y (mm/dd/yyyy)</option>
  </select>

  <input type="text" placeholder="Khoáº£ng giÃ¡ trá»‹" id="new-range">
  <input type="text" placeholder="MCID / NgÆ°á»¡ng" id="new-mcid">
  <br>
  <button onclick="addNewVariable()">âœ… ThÃªm vÃ o danh sÃ¡ch</button>
  <button onclick="exportVariables()">ğŸ’¾ Xuáº¥t file CSV biáº¿n Ä‘Ã£ cáº­p nháº­t</button>
</div>

  <div id="variable-groups"></div>
  <br><br>
  <button onclick="goToStep(9)">â¬…ï¸ Quay láº¡i</button>
  <button onclick="goToStep(11)">Tiáº¿p â¡ï¸</button>
</div>

<script>
let allVariables = [];
let selectedVariables = {};
const variableRoles = [
  {
    key: "primary",
    name: "Káº¿t cá»¥c chÃ­nh",
    required: true,
    description: "Biáº¿n sá»‘ chÃ­nh Ä‘á»ƒ Ä‘Ã¡nh giÃ¡ hiá»‡u quáº£ can thiá»‡p. Báº¯t buá»™c cÃ³."
  },
  {
    key: "secondary",
    name: "Káº¿t cá»¥c phá»¥",
    required: false,
    description: "Biáº¿n sá»‘ bá»• sung Ä‘á»ƒ Ä‘Ã¡nh giÃ¡ cÃ¡c khÃ­a cáº¡nh khÃ¡c cá»§a can thiá»‡p. NÃªn cÃ³."
  },
  {
    key: "baseline",
    name: "Biáº¿n ná»n",
    required: true,
    description: "Äáº·c Ä‘iá»ƒm ban Ä‘áº§u cá»§a ngÆ°á»i bá»‡nh dÃ¹ng Ä‘á»ƒ mÃ´ táº£ vÃ  phÃ¢n tÃ­ch. Báº¯t buá»™c cÃ³."
  },
  {
    key: "confounder",
    name: "Biáº¿n nhiá»…u",
    required: false,
    description: "Biáº¿n cÃ³ thá»ƒ áº£nh hÆ°á»Ÿng káº¿t quáº£ náº¿u khÃ´ng kiá»ƒm soÃ¡t. NÃªn cÃ³."
  },
  {
    key: "mediator",
    name: "Biáº¿n trung gian",
    required: false,
    description: "Biáº¿n giÃºp giáº£i thÃ­ch cÆ¡ cháº¿ tÃ¡c Ä‘á»™ng cá»§a can thiá»‡p Ä‘áº¿n káº¿t quáº£."
  },
  {
    key: "moderator",
    name: "Biáº¿n Ä‘iá»u biáº¿n",
    required: false,
    description: "Biáº¿n lÃ m thay Ä‘á»•i má»‘i liÃªn há»‡ giá»¯a can thiá»‡p vÃ  káº¿t quáº£ (vÃ­ dá»¥: tÆ°Æ¡ng tÃ¡c)."
  },
  {
    key: "safety",
    name: "Biáº¿n an toÃ n",
    required: false,
    description: "Biáº¿n pháº£n Ã¡nh tÃ¡c dá»¥ng phá»¥, biáº¿n cá»‘ báº¥t lá»£i hoáº·c váº¥n Ä‘á» an toÃ n trong nghiÃªn cá»©u."
  }
];

function createVariableDragUI() {
  const container = document.getElementById("variable-groups");
  container.innerHTML = "";

  variableRoles.forEach(role => {
    const availableList = (allVariables || []).filter(v => v.role === role.key);
    const selectedList = selectedVariables[role.key] || [];

    const block = document.createElement("div");
    block.className = "variable-group";

    // TiÃªu Ä‘á»
    const heading = document.createElement("h4");
    heading.textContent = role.name;
    block.appendChild(heading);

    // MÃ´ táº£
    const desc = document.createElement("div");
    desc.className = "description";
    desc.textContent = role.description;
    block.appendChild(desc);

    // Khá»‘i 2 danh sÃ¡ch
    const wrapper = document.createElement("div");
    wrapper.className = "variable-lists";

    // Danh sÃ¡ch cÃ³ thá»ƒ kÃ©o (chÆ°a chá»n)
    const availableUl = document.createElement("ul");
    availableUl.className = "variable-list variable-available";
    availableUl.dataset.role = role.key;
    availableUl.ondrop = drop;
    availableUl.ondragover = allowDrop;

    availableList.forEach(v => {
      const li = document.createElement("li");
      li.draggable = true;
      li.ondragstart = drag;
      li.dataset.name = v.name;
      li.dataset.role = v.role;
      li.textContent = `${v.name} (${v.type})`;
      const info = `
      TÃªn: ${v.name}
      Vai trÃ²: ${v.role}
      Kiá»ƒu dá»¯ liá»‡u: ${v.type}
      ÄÆ¡n vá»‹: ${v.unit}
      Thá»i Ä‘iá»ƒm Ä‘o: ${v.time}
      CÃ¡ch Ä‘o: ${v.measure}
      Äá»‹nh nghÄ©a: ${v.definition}
      Nguá»“n: ${v.source}
      Äá»‹nh dáº¡ng: ${v.format}
      Khoáº£ng giÃ¡ trá»‹: ${v.range}
      MCID/NgÆ°á»¡ng: ${v.mcid_or_cutoff}`.trim();
      li.title = info;        // ğŸ†• gáº¯n tooltip

      availableUl.appendChild(li);
    });

    // Danh sÃ¡ch Ä‘Ã£ chá»n
    const selectedUl = document.createElement("ul");
    selectedUl.className = "variable-list variable-selected";
    selectedUl.dataset.role = role.key;
    selectedUl.ondrop = drop;
    selectedUl.ondragover = allowDrop;

    selectedList.forEach(v => {
      const li = document.createElement("li");
      li.draggable = true;
      li.ondragstart = drag;
      li.dataset.name = v.name;
      li.dataset.role = v.role;
      li.style.position = "relative";

      // Táº¡o tháº» span chá»©a ná»™i dung vÄƒn báº£n
      const span = document.createElement("span");
      span.textContent = `${v.name} (${v.type})`;
      li.appendChild(span);

      const btn = document.createElement("button");
      btn.innerText = "ğŸ—‘";
      btn.style.position = "absolute";
      btn.style.top = "4px";
      btn.style.right = "6px";
      btn.style.background = "none";
      btn.style.border = "none";
      btn.style.color = "red";
      btn.style.cursor = "pointer";
      btn.style.fontSize = "16px";
      btn.onclick = (e) => removeVariable(e, v.name, v.role);

      li.appendChild(btn);
      const info = `
      TÃªn: ${v.name}
      Vai trÃ²: ${v.role}
      Kiá»ƒu dá»¯ liá»‡u: ${v.type}
      ÄÆ¡n vá»‹: ${v.unit}
      Thá»i Ä‘iá»ƒm Ä‘o: ${v.time}
      CÃ¡ch Ä‘o: ${v.measure}
      Äá»‹nh nghÄ©a: ${v.definition}
      Nguá»“n: ${v.source}
      Äá»‹nh dáº¡ng: ${v.format}
      Khoáº£ng giÃ¡ trá»‹: ${v.range}
      MCID/NgÆ°á»¡ng: ${v.mcid_or_cutoff}`.trim();
      li.title = info;        // ğŸ†• gáº¯n tooltip
      selectedUl.appendChild(li);
    });

    wrapper.appendChild(availableUl);
    wrapper.appendChild(selectedUl);
    block.appendChild(wrapper);
    container.appendChild(block);

    // Khu vá»±c GPT
    const pdfLabel = document.createElement("label");
    pdfLabel.innerText = "ğŸ“‚ Táº£i tÃ i liá»‡u PDF há»— trá»£:";
    block.appendChild(pdfLabel);

    const fileInput = document.createElement("input");
    fileInput.type = "file";
    fileInput.id = `file-variable-${role.key}`;
    fileInput.accept = ".pdf";
    block.appendChild(fileInput);

    block.appendChild(document.createElement("br"));

    // ğŸ‘‰ Táº¡o khá»‘i chá»©a 2 nÃºt
const btnRow = document.createElement("div");
btnRow.style.display = "flex";
btnRow.style.flexDirection = "row";
btnRow.style.gap = "10px"; // khoáº£ng cÃ¡ch giá»¯a 2 nÃºt
btnRow.style.marginTop = "8px";

// ğŸ‘‰ NÃºt GPT gá»£i Ã½
const suggestBtn = document.createElement("button");
suggestBtn.innerText = "ğŸ§  GPT gá»£i Ã½ biáº¿n";
suggestBtn.onclick = () => suggestVariablesForRole(role.key);
suggestBtn.style.display = "inline-flex";
suggestBtn.style.alignSelf = "flex-start";
suggestBtn.style.maxWidth = "fit-content";
suggestBtn.style.padding = "6px 12px";
suggestBtn.style.fontSize = "14px";
suggestBtn.style.border = "1px solid #bbb";
suggestBtn.style.borderRadius = "6px";
suggestBtn.style.backgroundColor = "#f0f0f0";
suggestBtn.style.color = "#333";
suggestBtn.style.cursor = "pointer";
suggestBtn.onmouseover = () => suggestBtn.style.backgroundColor = "#ddd";
suggestBtn.onmouseout = () => suggestBtn.style.backgroundColor = "#f0f0f0";
btnRow.appendChild(suggestBtn);

// ğŸ‘‰ NÃºt GPT Ä‘Ã¡nh giÃ¡
const evalBtn = document.createElement("button");
evalBtn.innerText = "ğŸ§ GPT Ä‘Ã¡nh giÃ¡ biáº¿n";
evalBtn.onclick = () => evaluateVariablesForRole(role.key);
evalBtn.style.display = "inline-flex";
evalBtn.style.alignSelf = "flex-start";
evalBtn.style.maxWidth = "fit-content";
evalBtn.style.padding = "6px 12px";
evalBtn.style.fontSize = "14px";
evalBtn.style.border = "1px solid #bbb";
evalBtn.style.borderRadius = "6px";
evalBtn.style.backgroundColor = "#f0f0f0";
evalBtn.style.color = "#333";
evalBtn.style.cursor = "pointer";
evalBtn.onmouseover = () => evalBtn.style.backgroundColor = "#ddd";
evalBtn.onmouseout = () => evalBtn.style.backgroundColor = "#f0f0f0";
btnRow.appendChild(evalBtn);

// ğŸ‘‰ ThÃªm dÃ£y nÃºt vÃ o block chÃ­nh
block.appendChild(btnRow);

// Khu vá»±c hiá»ƒn thá»‹ káº¿t quáº£ GPT
const suggestDiv = document.createElement("div");
suggestDiv.id = `suggest-variable-${role.key}`;
suggestDiv.style.cssText = "margin-top:10px; background:#eef; padding:10px; border:1px solid #99c; white-space:pre-wrap;";
block.appendChild(suggestDiv);

const evalDiv = document.createElement("div");
evalDiv.id = `eval-variable-${role.key}`;
evalDiv.style.cssText = "margin-top:10px; background:#efe; padding:10px; border:1px solid #9c9; white-space:pre-wrap;";
block.appendChild(evalDiv);

    // ThÃªm khá»‘i nÃ y vÃ o container chÃ­nh
    container.appendChild(block);
  });
}

function allowDrop(e) {
  e.preventDefault();
}

function drag(e) {
  e.dataTransfer.setData("text/plain", e.target.outerHTML);
  e.dataTransfer.setData("fromList", e.target.parentElement.classList.contains("variable-selected") ? "selected" : "available");
  e.dataTransfer.setData("role", e.target.dataset.role);
  e.dataTransfer.setData("name", e.target.dataset.name);
  e.target.classList.add("dragging");
}

function drop(e) {
  e.preventDefault();

  const from = e.dataTransfer.getData("fromList");
  const role = e.dataTransfer.getData("role");
  const name = e.dataTransfer.getData("name");

  if (!from || !role || !name) return;

  const v = (Array.isArray(allVariables) ? allVariables.find(x => x.name === name && x.role === role) : null) || {};
  if (!v.name) return;

  const targetList = e.target.closest(".variable-list");
  if (!targetList) return;

  if ([...targetList.querySelectorAll("li")].some(el => el.dataset.name === name)) return;

  const li = document.createElement("li");
  li.dataset.name = v.name;
  li.dataset.role = v.role;
  li.dataset.type = v.type || "";
  li.dataset.unit = v.unit || "";
  li.dataset.time = v.time || "";
  li.dataset.measure = v.measure || "";
  li.dataset.definition = v.definition || "";
  li.dataset.source = v.source || "";
  li.dataset.format = v.format || "";
  li.dataset.range = v.range || "";
  li.dataset.mcid = v.mcid_or_cutoff || "";

  li.draggable = true;
  li.ondragstart = drag;
  li.style.position = "relative";

  const span = document.createElement("span");
  span.textContent = `${v.name} (${v.type || ""})`;
  li.appendChild(span);

  const info = (
    `TÃªn: ${v.name}
Vai trÃ²: ${v.role}
Kiá»ƒu dá»¯ liá»‡u: ${v.type}
ÄÆ¡n vá»‹: ${v.unit}
Thá»i Ä‘iá»ƒm Ä‘o: ${v.time}
CÃ¡ch Ä‘o: ${v.measure}
Äá»‹nh nghÄ©a: ${v.definition}
Nguá»“n: ${v.source}
Äá»‹nh dáº¡ng: ${v.format}
Khoáº£ng giÃ¡ trá»‹: ${v.range}
MCID/NgÆ°á»¡ng: ${v.mcid_or_cutoff}`
  ).trim();
  li.title = info;

  const btn = document.createElement("button");
  btn.innerText = "ğŸ—‘";
  btn.style.position = "absolute";
  btn.style.top = "4px";
  btn.style.right = "6px";
  btn.style.background = "none";
  btn.style.border = "none";
  btn.style.color = "red";
  btn.style.cursor = "pointer";
  btn.style.fontSize = "16px";
  btn.onclick = (evt) => removeVariable(evt, v.name, v.role);
  li.appendChild(btn);

  targetList.appendChild(li);

  // Náº¿u kÃ©o tá»« available, xÃ³a khá»i danh sÃ¡ch nguá»“n
  if (from === "available") {
    const fromList = document.querySelector(`.variable-available[data-role="${role}"]`);
    const itemToRemove = [...fromList.querySelectorAll("li")].find(el => el.dataset.name === name);
    if (itemToRemove) itemToRemove.remove();
  }

  // Cáº­p nháº­t selectedVariables
  selectedVariables[role] = [...targetList.querySelectorAll("li")].map(el => ({
    name: el.dataset.name,
    role: el.dataset.role,
    type: el.dataset.type || "",
    unit: el.dataset.unit || "",
    time: el.dataset.time || "",
    measure: el.dataset.measure || "",
    definition: el.dataset.definition || "",
    source: el.dataset.source || "",
    format: el.dataset.format || "",
    range: el.dataset.range || "",
    mcid_or_cutoff: el.dataset.mcid || ""
  }));
  saveData();
};

// Äá»c file CSV biáº¿n máº«u
document.getElementById("variable-file").addEventListener("change", async (e) => {
  const file = e.target.files[0];
  if (!file) return;

  const text = await file.text();
  const result = Papa.parse(text.trim(), { header: true, skipEmptyLines: true });

  allVariables = result.data.map(row => ({
    name: row.name?.trim() || "",
    role: row.role?.trim() || "",
    type: row.type?.trim() || "",
    unit: row.unit || "",
    time: row.time || "",
    measure: row.measure || "",
    definition: row.definition || "",
    source: row.source || "",
    format: row.format || "",
    range: row.range || "",
    mcid_or_cutoff: row.mcid_or_cutoff || ""
  }));
  console.log("âœ… Loaded variables:", allVariables);
  createVariableDragUI();
});

</script>

<!-- BÆ°á»›c 12: MÃ´ táº£ thu tháº­p dá»¯ liá»‡u -->
<div class="step" id="step-11">
  <h2>BÆ°á»›c 12: MÃ´ táº£ cÃ¡ch thu tháº­p dá»¯ liá»‡u</h2>
  <label>ğŸ“ MÃ´ táº£ cÃ¡ch thu tháº­p dá»¯ liá»‡u:</label><br>
  <textarea id="collect-desc" rows="8" style="width:100%;" placeholder="VÃ­ dá»¥: Dá»¯ liá»‡u sáº½ Ä‘Æ°á»£c thu tháº­p táº¡i 3 thá»i Ä‘iá»ƒm..."></textarea>
  <div id="data-collection-list"></div>
  <br><br>
  <h3>Káº¿t quáº£ tá»« GPT:</h3>
  <label>ğŸ“‚ Táº£i tÃ i liá»‡u PDF há»— trá»£ (náº¿u cÃ³):</label>
  <input type="file" id="file-collect-pdf" accept=".pdf"><br><br>
  <button onclick="generateCollectSuggestion()">ğŸ§  GPT gá»£i Ã½ mÃ´ táº£ thu tháº­p</button>
  <div id="suggest-collect" style="margin-top:10px; background:#eef; padding:10px; border:1px solid #99c; white-space:pre-wrap;"></div>
  <button onclick="evaluateCollectDescription()">ğŸ§ GPT Ä‘Ã¡nh giÃ¡ mÃ´ táº£ Ä‘Ã£ nháº­p</button>
  <div id="eval-collect" style="margin-top:10px; background:#efe; padding:10px; border:1px solid #9c9; white-space:pre-wrap;"></div>

  <br>
  <button onclick="goToStep(10)">â¬…ï¸ Quay láº¡i</button>
  <button onclick="goToStep(12)">Tiáº¿p â¡ï¸</button>
</div>

<!-- BÆ°á»›c 13: PhÃ¢n tÃ­ch sá»‘ liá»‡u -->
<div class="step" id="step-12">
  <h2>BÆ°á»›c 13: PhÃ¢n tÃ­ch sá»‘ liá»‡u</h2>
  <label>ğŸ“ MÃ´ táº£ chiáº¿n lÆ°á»£c phÃ¢n tÃ­ch sá»‘ liá»‡u:</label><br>
  <textarea id="analysis-desc" rows="10" style="width:100%;" placeholder="VÃ­ dá»¥: Dá»¯ liá»‡u sáº½ Ä‘Æ°á»£c phÃ¢n tÃ­ch theo nguyÃªn táº¯c ITT..."></textarea>
  <div id="analysis-list"></div>
  <br><br>
  <h3>Káº¿t quáº£ tá»« GPT:</h3>
  <label>ğŸ“‚ Táº£i tÃ i liá»‡u PDF há»— trá»£ (náº¿u cÃ³):</label>
  <input type="file" id="file-analysis-pdf" accept=".pdf"><br><br>
  <button onclick="generateAnalysisPlan()">ğŸ§  GPT gá»£i Ã½ chiáº¿n lÆ°á»£c phÃ¢n tÃ­ch</button>
  <div id="suggest-analysis" style="margin-top:10px; background:#eef; padding:10px; white-space:pre-wrap; border:1px solid #99c;"></div>
  <button onclick="evaluateAnalysisPlan()">ğŸ§ GPT Ä‘Ã¡nh giÃ¡ ná»™i dung Ä‘Ã£ viáº¿t</button>
  <div id="eval-analysis" style="margin-top:10px; background:#efe; padding:10px; white-space:pre-wrap; border:1px solid #9c9;"></div>
  <br>
  <button onclick="goToStep(11)">â¬…ï¸ Quay láº¡i</button>
  <button onclick="goToStep(13)">Tiáº¿p â¡ï¸</button>
</div>

<!-- BÆ°á»›c 14: Äáº¡o Ä‘á»©c nghiÃªn cá»©u -->
<div class="step" id="step-13">
  <h2>BÆ°á»›c 14: Äáº¡o Ä‘á»©c nghiÃªn cá»©u</h2>
  <label>ğŸ“ MÃ´ táº£ pháº§n Ä‘áº¡o Ä‘á»©c nghiÃªn cá»©u:</label><br>
  <textarea id="ethics-desc" rows="10" style="width:100%;" placeholder="VÃ­ dá»¥: NghiÃªn cá»©u tuÃ¢n thá»§ TuyÃªn bá»‘ Helsinki..."></textarea><br><br>
  <h3>Káº¿t quáº£ tá»« GPT:</h3>
  <label>ğŸ“‚ Táº£i tÃ i liá»‡u PDF há»— trá»£ (náº¿u cÃ³):</label>
  <input type="file" id="file-ethics-pdf" accept=".pdf"><br><br>
  <button onclick="generateEthicsSection()">ğŸ§  GPT gá»£i Ã½ ná»™i dung Ä‘áº¡o Ä‘á»©c</button>
  <div id="suggest-ethics" style="margin-top:10px; background:#eef; padding:10px; white-space:pre-wrap; border:1px solid #99c;"></div>
  <button onclick="evaluateEthicsSection()">ğŸ§ GPT Ä‘Ã¡nh giÃ¡ ná»™i dung Ä‘Ã£ viáº¿t</button>
  <div id="eval-ethics" style="margin-top:10px; background:#efe; padding:10px; white-space:pre-wrap; border:1px solid #9c9;"></div>
  <br>
  <button onclick="goToStep(12)">â¬…ï¸ Quay láº¡i</button>
  <button onclick="goToStep(14)">Tiáº¿p â¡ï¸</button>
</div>

<!-- BÆ°á»›c 15: Kiá»ƒm tra logic tá»•ng thá»ƒ -->
<div class="step" id="step-14">
  <h2>BÆ°á»›c 15: Kiá»ƒm tra logic tá»•ng thá»ƒ</h2>
  <p>ğŸ§  GPT sáº½ kiá»ƒm tra toÃ n bá»™ Ä‘á» cÆ°Æ¡ng báº¡n Ä‘Ã£ nháº­p, gá»“m PICO, má»¥c tiÃªu, biáº¿n sá»‘, mÃ´ táº£ can thiá»‡p, phÃ¢n tÃ­ch, Ä‘áº¡o Ä‘á»©câ€¦ Ä‘á»ƒ phÃ¡t hiá»‡n mÃ¢u thuáº«n, thiáº¿u sÃ³t hoáº·c gá»£i Ã½ cáº£i tiáº¿n.</p>
  <button onclick="checkLogic()">ğŸ§  Kiá»ƒm tra logic toÃ n bá»™ Ä‘á» cÆ°Æ¡ng</button>
  <div id="logic-check-result" style="margin-top:15px; background:#ffe; padding:10px; white-space:pre-wrap; border:1px solid #cc0;"></div>
  <br>
  <button onclick="goToStep(13)">â¬…ï¸ Quay láº¡i</button>
  <button onclick="goToStep(15)">Tiáº¿p â¡ï¸</button>
</div>

<!-- BÆ°á»›c 16: SÆ¡ Ä‘á»“ tiáº¿n hÃ nh nghiÃªn cá»©u -->
<div class="step" id="step-15">
  <h2>BÆ°á»›c 16: SÆ¡ Ä‘á»“ tiáº¿n hÃ nh nghiÃªn cá»©u</h2>
  <pre id="studyflow-mermaid" class="mermaid" style="padding: 20px; border: 1px solid #ccc;"></pre>
  <br>
  <button onclick="renderStudyFlowDiagram()">ğŸ” Váº½ láº¡i sÆ¡ Ä‘á»“</button>
  <button onclick="downloadMermaidPNG()">ğŸ“· Táº£i PNG</button>
  <br><br>
  <button onclick="goToStep(14)">â¬…ï¸ Quay láº¡i</button>
  <button onclick="alert('ğŸ‰ ÄÃ£ hoÃ n táº¥t toÃ n bá»™ Ä‘á» cÆ°Æ¡ng!')">Káº¿t thÃºc âœ…</button>
</div>

<script>
// ====================== PHáº¦N 1: HÃ m cho cÃ¡c bÆ°á»›c ===========================

//Chung cho má»i bÆ°á»›c

async function extractTextFromPDF(file) {
  const arrayBuffer = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
  let fullText = '';

  for (let i = 1; i <= pdf.numPages; i++) {
    const page = await pdf.getPage(i);
    const content = await page.getTextContent();
    const strings = content.items.map(item => item.str);
    fullText += strings.join(' ') + '\n';
  }

  return fullText;
}

//BÆ°á»›c 1

async function generatePicoDescription() {
  const p = document.getElementById("pico-p").value.trim();
  const i = document.getElementById("pico-i").value.trim();
  const c = document.getElementById("pico-c").value.trim();
  const o = document.getElementById("pico-o").value.trim();
  const fileInput = document.getElementById("pico-file");
  const files = Array.from(fileInput.files);

  if (!p || !i || !c || !o) {
    alert("Vui lÃ²ng Ä‘iá»n Ä‘áº§y Ä‘á»§ thÃ´ng tin P, I, C, O trÆ°á»›c khi dÃ¹ng GPT.");
    return;
  }

  document.getElementById("pico-gpt-result").innerText = "Äang xá»­ lÃ½...";

  let fileText = "";
for (const file of files) {
  if (file.type === "application/pdf") {
    try {
      const text = await extractTextFromPDF(file);
      fileText += `--- Ná»™i dung tá»« file: ${file.name} ---\n${text}\n\n`;
    } catch (err) {
      console.error("Lá»—i Ä‘á»c file:", file.name, err);
    }
  }
}

  const prompt = fileText
    ? `TÃ i liá»‡u sau Ä‘Ã¢y Ä‘Æ°á»£c trÃ­ch tá»« bÃ i bÃ¡o ngÆ°á»i dÃ¹ng cung cáº¥p:\n\n${fileText}\n\n---\nDá»±a trÃªn ná»™i dung tÃ i liá»‡u trÃªn vÃ  thÃ´ng tin PICO sau, hÃ£y viáº¿t má»™t Ä‘oáº¡n mÃ´ táº£ nghiÃªn cá»©u RCT phÃ¹ há»£p:\n- P: ${p}\n- I: ${i}\n- C: ${c}\n- O: ${o}`
    : `TÃ´i Ä‘ang xÃ¢y dá»±ng má»™t Ä‘á» cÆ°Æ¡ng nghiÃªn cá»©u RCT vá»›i thÃ´ng tin PICO sau:\n- P: ${p}\n- I: ${i}\n- C: ${c}\n- O: ${o}\nHÃ£y viáº¿t má»™t Ä‘oáº¡n mÃ´ táº£ nghiÃªn cá»©u ngáº¯n gá»n, rÃµ rÃ ng.`;

  try {
  const response = await fetch("https://gpt-api-19xu.onrender.com/gpt.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ prompt })
  });

  const text = await response.text();
  const data = JSON.parse(text);

  document.getElementById("pico-gpt-result").innerText =
    data.choices?.[0]?.message?.content || "GPT khÃ´ng tráº£ vá» ná»™i dung.";
} catch (e) {
  document.getElementById("pico-gpt-result").innerText =
    "âŒ Lá»—i khi gá»i hoáº·c xá»­ lÃ½ GPT: " + e.message;
}


//BÆ°á»›c 2

async function generateResearchQuestionFromGPT() {
  const p = document.getElementById("pico-p").value.trim();
  const i = document.getElementById("pico-i").value.trim();
  const c = document.getElementById("pico-c").value.trim();
  const o = document.getElementById("pico-o").value.trim();
  const fileInput = document.getElementById("question-file");
  const files = Array.from(fileInput.files);

  if (!p || !i || !c || !o) {
    alert("Cáº§n Ä‘iá»n Ä‘áº§y Ä‘á»§ thÃ´ng tin PICO trÆ°á»›c khi GPT gá»£i Ã½.");
    return;
  }

  document.getElementById("question-gpt-suggestion").innerText = "Äang gá»£i Ã½ tá»« GPT...";

  let fileText = "";
  for (const file of files) {
    if (file.type === "application/pdf") {
      try {
        const text = await extractTextFromPDF(file);
        fileText += `--- Ná»™i dung tá»« file: ${file.name} ---\n${text}\n\n`;
      } catch (err) {
        console.error("Lá»—i khi Ä‘á»c PDF:", err);
      }
    }
  }

  const prompt = `${fileText ? "DÆ°á»›i Ä‘Ã¢y lÃ  ná»™i dung tá»« tÃ i liá»‡u PDF:\n" + fileText : ""}
ThÃ´ng tin PICO Ä‘Ã£ cÃ³:
- P: ${p}
- I: ${i}
- C: ${c}
- O: ${o}

Dá»±a vÃ o tÃ i liá»‡u vÃ  PICO trÃªn, hÃ£y viáº¿t má»™t cÃ¢u há»i nghiÃªn cá»©u RCT rÃµ rÃ ng, máº¡ch láº¡c, phÃ¹ há»£p Ä‘á»ƒ Ä‘Æ°a vÃ o Ä‘á» cÆ°Æ¡ng.`

const response = await fetch("https://gpt-api-19xu.onrender.com/gpt.php", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ prompt })
});

  const text = await response.text();
  try {
    const data = JSON.parse(text);
    const result = data.choices?.[0]?.message?.content || "GPT khÃ´ng pháº£n há»“i.";
    document.getElementById("question-gpt-suggestion").innerText = result;
  } catch (e) {
    document.getElementById("question-gpt-suggestion").innerText = "Lá»—i khi phÃ¢n tÃ­ch pháº£n há»“i: " + text;
  }

async function evaluateResearchQuestion() {
  const question = document.getElementById("question").value.trim();
  const p = document.getElementById("pico-p").value.trim();
  const i = document.getElementById("pico-i").value.trim();
  const c = document.getElementById("pico-c").value.trim();
  const o = document.getElementById("pico-o").value.trim();

  if (!question) {
    alert("Vui lÃ²ng nháº­p cÃ¢u há»i Ä‘á»ƒ Ä‘Ã¡nh giÃ¡.");
    return;
  }

  document.getElementById("question-gpt-evaluation").innerText = "GPT Ä‘ang Ä‘Ã¡nh giÃ¡...";

  const prompt = `ÄÃ¢y lÃ  má»™t cÃ¢u há»i nghiÃªn cá»©u mÃ  ngÆ°á»i dÃ¹ng Ä‘Ã£ viáº¿t:\n"${question}"\n\n
1. HÃ£y Ä‘Ã¡nh giÃ¡ cÃ¢u há»i nÃ y theo tiÃªu chÃ­ **FINER** (Feasible, Interesting, Novel, Ethical, Relevant).
2. Kiá»ƒm tra xem nÃ³ cÃ³ Ä‘á»§ yáº¿u tá»‘ PICO khÃ´ng? Náº¿u thiáº¿u pháº§n nÃ o thÃ¬ ghi rÃµ.
3. ÄÆ°a ra nháº­n xÃ©t vÃ  gá»£i Ã½ cáº£i thiá»‡n náº¿u cáº§n.`;

const response = await fetch("https://gpt-api-19xu.onrender.com/gpt.php", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ prompt })
});

  const text = await response.text();
  try {
    const data = JSON.parse(text);
    const result = data.choices?.[0]?.message?.content || "GPT khÃ´ng pháº£n há»“i.";
    document.getElementById("question-gpt-evaluation").innerText = result;
  } catch (e) {
    document.getElementById("question-gpt-evaluation").innerText = "Lá»—i pháº£n há»“i: " + text;
  }

//BÆ°á»›c 3 

function addSubObjective() {
  const container = document.createElement("div");
  container.style.display = "flex";
  container.style.gap = "10px";
  container.style.marginTop = "5px";

  const input = document.createElement("input");
  input.type = "text";
  input.className = "sub-objective";
  input.placeholder = "Nháº­p má»¥c tiÃªu phá»¥...";
  input.oninput = saveData;
  input.style.flex = "1";

  const btn = document.createElement("button");
  btn.innerText = "âŒ";
  btn.title = "XÃ³a má»¥c tiÃªu nÃ y";
  btn.style.background = "none";
  btn.style.border = "1px solid #ccc";
  btn.style.padding = "4px 10px";
  btn.style.borderRadius = "6px";
  btn.style.cursor = "pointer";
  btn.style.color = "red";
  btn.onclick = () => {
    container.remove();
    saveData();
  };

  container.appendChild(input);
  container.appendChild(btn);

  document.getElementById("sub-objectives").appendChild(container);
  saveData();
}


async function generateObjectivesFromGPT() {
  const p = document.getElementById("pico-p").value.trim();
  const i = document.getElementById("pico-i").value.trim();
  const c = document.getElementById("pico-c").value.trim();
  const o = document.getElementById("pico-o").value.trim();
  const fileInput = document.getElementById("objective-file");
  const files = Array.from(fileInput.files);

  if (!p || !i || !c || !o) {
    alert("Cáº§n nháº­p Ä‘á»§ PICO trÆ°á»›c khi GPT gá»£i Ã½ má»¥c tiÃªu.");
    return;
  }

  document.getElementById("objective-gpt-suggestion").innerText = "Äang gá»£i Ã½ tá»« GPT...";

  let fileText = "";
  for (const file of files) {
    if (file.type === "application/pdf") {
      try {
        const text = await extractTextFromPDF(file);
        fileText += `--- Ná»™i dung tá»« file: ${file.name} ---\n${text}\n\n`;
      } catch (err) {
        console.error("Lá»—i Ä‘á»c file PDF:", err);
      }
    }
  }

  const prompt = `${fileText ? "TÃ i liá»‡u ngÆ°á»i dÃ¹ng cung cáº¥p:\n" + fileText : ""}
ThÃ´ng tin tá»« bÆ°á»›c PICO:
- P: ${p}
- I: ${i}
- C: ${c}
- O: ${o}

Dá»±a vÃ o tÃ i liá»‡u vÃ  PICO trÃªn, hÃ£y viáº¿t má»¥c tiÃªu chÃ­nh vÃ  2â€“4 má»¥c tiÃªu phá»¥ phÃ¹ há»£p vá»›i má»™t Ä‘á» cÆ°Æ¡ng nghiÃªn cá»©u RCT. Má»¥c tiÃªu pháº£i rÃµ rÃ ng, Ä‘o lÆ°á»ng Ä‘Æ°á»£c, Ä‘á»§ thÃ nh pháº§n PICO. Dá»±a trÃªn kiáº¿n thá»©c y khoa hiá»‡n táº¡i vá» váº¥n Ä‘á» mÃ  tÃ´i Ä‘ang nghiÃªn cá»©u. Náº¿u cÃ³ táº£i lÃªn tÃ i liá»‡u, thÃ¬ pháº£i trÃ­ch dáº«n rÃµ á»Ÿ cuá»‘i cÃ¹ng lÃ  thÃ´ng tin gÃ¬ Ä‘Ã£ láº¥y tá»« tÃ i liá»‡u nÃ o`

const response = await fetch("https://gpt-api-19xu.onrender.com/gpt.php", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ prompt })
});

  const text = await response.text();
  try {
    const data = JSON.parse(text);
    const result = data.choices?.[0]?.message?.content || "GPT khÃ´ng tráº£ vá» káº¿t quáº£.";
    document.getElementById("objective-gpt-suggestion").innerText = result;
  } catch (e) {
    document.getElementById("objective-gpt-suggestion").innerText = "Lá»—i pháº£n há»“i: " + text;
  }

async function evaluateObjectives() {
  const main = document.getElementById("main-objective").value.trim();
  const subs = Array.from(document.querySelectorAll(".sub-objective")).map(el => el.value.trim()).filter(v => v);

  if (!main) {
    alert("Vui lÃ²ng nháº­p má»¥c tiÃªu chÃ­nh.");
    return;
  }

  const allObjectives = `Má»¥c tiÃªu chÃ­nh:\n- ${main}\n\nMá»¥c tiÃªu phá»¥:\n${subs.map(s => "- " + s).join("\n")}`;

  const prompt = `DÆ°á»›i Ä‘Ã¢y lÃ  cÃ¡c má»¥c tiÃªu nghiÃªn cá»©u mÃ  ngÆ°á»i dÃ¹ng Ä‘Ã£ viáº¿t:

${allObjectives}

1. ÄÃ¡nh giÃ¡ tá»«ng má»¥c tiÃªu theo tiÃªu chÃ­ **FINER** (Feasible, Interesting, Novel, Ethical, Relevant).
2. Kiá»ƒm tra xem tá»«ng má»¥c tiÃªu cÃ³ rÃµ rÃ ng vÃ  phÃ¹ há»£p **SMART** (Specific, Measurable, Achievable, Realistic, Time-bound).
3. Náº¿u cÃ³ má»¥c tiÃªu nÃ o chÆ°a Ä‘Ãºng hoáº·c quÃ¡ rá»™ng/mÆ¡ há»“, hÃ£y nÃªu rÃµ vÃ  Ä‘á» xuáº¥t cÃ¡ch viáº¿t láº¡i tá»‘t hÆ¡n.
4. Äá»‘i vá»›i má»¥c tiÃªu chÃ­nh, kiá»ƒm tra xem cÃ³ rÃµ rÃ ng vá» PICO khÃ´ng.`

  document.getElementById("objective-gpt-evaluation").innerText = "GPT Ä‘ang Ä‘Ã¡nh giÃ¡...";

const response = await fetch("https://gpt-api-19xu.onrender.com/gpt.php", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ prompt })
});

  const text = await response.text();
  try {
    const data = JSON.parse(text);
    const result = data.choices?.[0]?.message?.content || "GPT khÃ´ng pháº£n há»“i.";
    document.getElementById("objective-gpt-evaluation").innerText = result;
  } catch (e) {
    document.getElementById("objective-gpt-evaluation").innerText = "Lá»—i pháº£n há»“i: " + text;
  }


//BÆ°á»›c 4

async function generateGPT_Territory() {
  const output = document.getElementById("suggest-territory");
  const file = document.getElementById("file-territory").files[0];

  const p = document.getElementById("pico-p")?.value || "";
  const i = document.getElementById("pico-i")?.value || "";
  const c = document.getElementById("pico-c")?.value || "";
  const o = document.getElementById("pico-o")?.value || "";
  const question = document.getElementById("question")?.value || "";
  const mainObjective = document.getElementById("main-objective")?.value || "";

  if (!p || !i || !c || !o || !mainObjective) {
    alert("Vui lÃ²ng nháº­p Ä‘á»§ thÃ´ng tin PICO vÃ  má»¥c tiÃªu trÆ°á»›c khi GPT gá»£i Ã½.");
    return;
  }

  output.textContent = "Äang sinh ná»™i dung...";

  let fileText = "";
  if (file && file.type === "application/pdf") {
    try {
      fileText = await extractTextFromPDF(file);
    } catch (err) {
      console.error("Lá»—i Ä‘á»c PDF:", err);
    }
  }

  const prompt = `${fileText ? "TÃ i liá»‡u PDF:\n" + fileText + "\n\n" : ""}
ThÃ´ng tin Ä‘á» cÆ°Æ¡ng:
- P: ${p}
- I: ${i}
- C: ${c}
- O: ${o}
- CÃ¢u há»i: ${question}
- Má»¥c tiÃªu chÃ­nh: ${mainObjective}

HÃ£y viáº¿t pháº§n má»Ÿ Ä‘áº§u nghiÃªn cá»©u (Territory) theo mÃ´ hÃ¬nh CaRS, thá»ƒ hiá»‡n bá»‘i cáº£nh, táº§m quan trá»ng cá»§a lÄ©nh vá»±c Ä‘ang nghiÃªn cá»©u. NÃªn cÃ³ cÃ¡c sá»‘ liá»‡u dá»‹ch tá»… há»c vÃ  chá»‰ sá»‘ vá» gÃ¡nh náº·ng bá»‡nh táº­t Ä‘á»ƒ thá»ƒ hiá»‡n rÃµ váº¥n Ä‘á» nghiÃªn cá»©u lÃ  cáº¥p thiáº¿t. Náº¿u cÃ³ táº£i tÃ i liá»‡u lÃªn thÃ¬ khi sá»­ dá»¥ng thÃ´ng tin trong tÃ i liá»‡u nÃ o pháº£i Ä‘Ã¡nh sá»‘ trÃ­ch dáº«n vÃ  cuá»‘i cÃ¹ng pháº£i cho danh má»¥c tÃ i liá»‡u Ä‘Ã£ tham kháº£o theo AMA 11.`;

const response = await fetch("https://gpt-api-19xu.onrender.com/gpt.php", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ prompt })
});

  const text = await response.text();
  try {
    const data = JSON.parse(text);
    output.textContent = data.choices?.[0]?.message?.content || "GPT khÃ´ng tráº£ vá» ná»™i dung.";
  } catch (err) {
    output.textContent = "Lá»—i pháº£n há»“i: " + text;
  }

async function evaluateGPT_Territory() {
  const input = document.getElementById("intro-territory").value.trim();
  const output = document.getElementById("eval-territory");
  const file = document.getElementById("file-territory").files[0];

  output.innerText = "â³ Äang Ä‘Ã¡nh giÃ¡ Territory...";

  let fileText = "";
  if (file && file.type === "application/pdf") {
    try {
      fileText = await extractTextFromPDF(file);
    } catch (err) {
      console.error("Lá»—i Ä‘á»c PDF:", err);
    }
  }

  const prompt = `
ÄÃ¢y lÃ  pháº§n Territory (bá»‘i cáº£nh nghiÃªn cá»©u) trong má»™t Ä‘á» cÆ°Æ¡ng nghiÃªn cá»©u:

"${input}"

${fileText ? "TÃ i liá»‡u PDF liÃªn quan:\n" + fileText : ""}

HÃ£y Ä‘Ã¡nh giÃ¡ Ä‘oáº¡n Territory trÃªn theo cÃ¡c tiÃªu chÃ­ sau:
- ÄÃ£ nÃªu rÃµ lÄ©nh vá»±c nghiÃªn cá»©u vÃ  bá»‘i cáº£nh chung chÆ°a?
- CÃ³ sá»‘ liá»‡u, báº±ng chá»©ng há»— trá»£ khÃ´ng?
- CÃ³ dáº«n dáº¯t ngÆ°á»i Ä‘á»c vÃ o chá»§ Ä‘á» nghiÃªn cá»©u chÃ­nh khÃ´ng?
- CÃ³ logic, máº¡ch láº¡c vÃ  phÃ¹ há»£p vá»›i má»¥c tiÃªu nghiÃªn cá»©u khÃ´ng?

Tráº£ lá»i báº±ng tiáº¿ng Viá»‡t.
  `;

  try {
    const response = await fetch("https://gpt-api-19xu.onrender.com/gpt.php", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ prompt })
    });

    const text = await response.text();
    const data = JSON.parse(text);
    output.innerText = data.choices?.[0]?.message?.content || "GPT khÃ´ng tráº£ vá» ná»™i dung.";
  } catch (error) {
    output.innerText = "âŒ Lá»—i xá»­ lÃ½ pháº£n há»“i GPT: " + error.message;
  }

async function generateGPT_Niche() {
  const output = document.getElementById("suggest-niche");
  const file = document.getElementById("file-niche").files[0];

  const territory = document.getElementById("intro-territory")?.value || "";

  if (!territory.trim()) {
    alert("Cáº§n nháº­p hoáº·c sinh pháº§n Territory trÆ°á»›c khi viáº¿t Niche.");
    return;
  }

  output.textContent = "Äang sinh ná»™i dung...";

  let fileText = "";
  if (file && file.type === "application/pdf") {
    try {
      fileText = await extractTextFromPDF(file);
    } catch (err) {
      console.error("Lá»—i Ä‘á»c PDF:", err);
    }
  }

  const prompt = `${fileText ? "TÃ i liá»‡u PDF:\n" + fileText + "\n\n" : ""}
Pháº§n Territory Ä‘Ã£ viáº¿t:
${territory}

Dá»±a trÃªn pháº§n Territory vÃ  tÃ i liá»‡u, hÃ£y viáº¿t pháº§n Niche nÃªu rÃµ khoáº£ng trá»‘ng kiáº¿n thá»©c trong lÄ©nh vá»±c nghiÃªn cá»©u. Náº¿u lÄ©nh vá»±c nghiÃªn cá»©u lÃ  vá» má»™t can thiá»‡p cá»§a y há»c cá»• truyá»n trÃªn má»™t bá»‡nh lÃ½ cá»§a y há»c hiá»‡n Ä‘áº¡i, thÃ¬ pháº§n nÃ y nÃªn theo logic lÃ : (1) Y há»c hiá»‡n Ä‘áº¡i Ä‘ang cÃ²n nhá»¯ng thÃ¡ch thá»©c, háº¡n cháº¿ nÃ o trong quáº£n lÃ½ toÃ n diá»‡n bá»‡nh lÃ½/tÃ¬nh tráº¡ng Ä‘ang Ä‘á»‹nh nghiÃªn cá»©u, (2) Can thiá»‡p y há»c cá»• truyá»n dá»± Ä‘á»‹nh nghiÃªn cá»©u trong RCT nÃ y Ä‘Ã£ cÃ³ nhá»¯ng báº±ng chá»©ng nÃ o trÆ°á»›c Ä‘Ã¢y gá»£i Ã½ lÃ  cÃ³ hiá»‡u quáº£ chÆ°a, (3) nÃ³i rÃµ lÃ  cÃ¡c báº±ng chá»©ng hiá»‡n táº¡i cÃ²n yáº¿u ra sao Ä‘á»ƒ khiáº¿n pháº£i cÃ³ thÃªm báº±ng chá»©ng máº¡nh hÆ¡n. Náº¿u cÃ³ táº£i tÃ i liá»‡u lÃªn thÃ¬ khi sá»­ dá»¥ng thÃ´ng tin trong tÃ i liá»‡u nÃ o pháº£i Ä‘Ã¡nh sá»‘ trÃ­ch dáº«n vÃ  cuá»‘i cÃ¹ng pháº£i cho danh má»¥c tÃ i liá»‡u Ä‘Ã£ tham kháº£o theo AMA 11`;

const response = await fetch("https://gpt-api-19xu.onrender.com/gpt.php", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ prompt })
});

  const text = await response.text();
  try {
    const data = JSON.parse(text);
    output.textContent = data.choices?.[0]?.message?.content || "GPT khÃ´ng tráº£ vá» ná»™i dung.";
  } catch (err) {
    output.textContent = "Lá»—i pháº£n há»“i: " + text;
  }

async function evaluateGPT_Niche() {
  const input = document.getElementById("intro-niche").value.trim();
  const output = document.getElementById("eval-niche");
  const file = document.getElementById("file-niche").files[0];

  output.innerText = "â³ Äang Ä‘Ã¡nh giÃ¡ Niche...";

  let fileText = "";
  if (file && file.type === "application/pdf") {
    try {
      fileText = await extractTextFromPDF(file);
    } catch (err) {
      console.error("Lá»—i Ä‘á»c PDF:", err);
    }
  }

  const prompt = `
ÄÃ¢y lÃ  pháº§n Niche (khoáº£ng trá»‘ng kiáº¿n thá»©c) trong má»™t Ä‘á» cÆ°Æ¡ng nghiÃªn cá»©u:

"${input}"

${fileText ? "TÃ i liá»‡u PDF liÃªn quan:\n" + fileText : ""}

HÃ£y Ä‘Ã¡nh giÃ¡ Ä‘oáº¡n Niche trÃªn theo cÃ¡c tiÃªu chÃ­ sau:
- ÄÃ£ xÃ¡c Ä‘á»‹nh rÃµ váº¥n Ä‘á» chÆ°a Ä‘Æ°á»£c giáº£i quyáº¿t khÃ´ng?
- CÃ³ viá»‡n dáº«n hoáº·c mÃ´ táº£ khoáº£ng trá»‘ng trong y vÄƒn khÃ´ng?
- CÃ³ liÃªn káº¿t há»£p lÃ½ vá»›i pháº§n Territory khÃ´ng?
- Diá»…n Ä‘áº¡t cÃ³ logic vÃ  phÃ¹ há»£p vá»›i Ä‘á»‹nh hÆ°á»›ng nghiÃªn cá»©u khÃ´ng?

Tráº£ lá»i báº±ng tiáº¿ng Viá»‡t.
  `;

try {
  const response = await fetch("https://gpt-api-19xu.onrender.com/gpt.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ prompt })
  });

  const text = await response.text();
  const data = JSON.parse(text);
  output.innerText = data.choices?.[0]?.message?.content || "GPT khÃ´ng tráº£ vá» ná»™i dung.";
} catch (error) {
  output.innerText = "âŒ Lá»—i xá»­ lÃ½ hoáº·c pháº£n há»“i GPT: " + error.message;
}

async function generateGPT_Occupy() {
  const output = document.getElementById("suggest-occupy");
  const file = document.getElementById("file-occupy").files[0];

  const niche = document.getElementById("intro-niche")?.value || "";
  const objective = document.getElementById("main-objective")?.value || "";

  if (!niche.trim() || !objective.trim()) {
    alert("Cáº§n cÃ³ ná»™i dung Niche vÃ  má»¥c tiÃªu chÃ­nh trÆ°á»›c khi viáº¿t Occupy.");
    return;
  }

  output.textContent = "Äang sinh ná»™i dung...";

  let fileText = "";
  if (file && file.type === "application/pdf") {
    try {
      fileText = await extractTextFromPDF(file);
    } catch (err) {
      console.error("Lá»—i Ä‘á»c PDF:", err);
    }
  }

  const prompt = `${fileText ? "TÃ i liá»‡u PDF:\n" + fileText + "\n\n" : ""}
Pháº§n Niche Ä‘Ã£ viáº¿t:
${niche}

Má»¥c tiÃªu chÃ­nh cá»§a nghiÃªn cá»©u:
${objective}

Dá»±a trÃªn khoáº£ng trá»‘ng Ä‘Ã£ nÃªu, hÃ£y viáº¿t pháº§n Occupy trÃ¬nh bÃ y cÃ¡ch nghiÃªn cá»©u nÃ y sáº½ chiáº¿m lÄ©nh khoáº£ng trá»‘ng, dÃ¹ng phÆ°Æ¡ng phÃ¡p gÃ¬ vÃ  lÃ½ do há»£p lÃ½. Cáº§n lÃ m rÃµ nghiÃªn cá»©u nÃ y sáº½ kháº¯c phá»¥c cÃ¡i Niche Ä‘Ã£ nÃªu báº±ng cÃ¡ch nÃ o (phÆ°Æ¡ng phÃ¡p can thiá»‡p má»›i, bá»™ dá»¯ liá»‡u cháº¥t lÆ°á»£ng vÃ  sá»‘ lÆ°á»£ng cao hÆ¡n, hay phÆ°Æ¡ng phÃ¡p phÃ¢n tÃ­ch káº¿t quáº£ má»›i máº¡nh hÆ¡n...). Náº¿u cÃ³ táº£i tÃ i liá»‡u lÃªn thÃ¬ khi sá»­ dá»¥ng thÃ´ng tin trong tÃ i liá»‡u nÃ o pháº£i Ä‘Ã¡nh sá»‘ trÃ­ch dáº«n vÃ  cuá»‘i cÃ¹ng pháº£i cho danh má»¥c tÃ i liá»‡u Ä‘Ã£ tham kháº£o theo AMA 11.`;

const response = await fetch("https://gpt-api-19xu.onrender.com/gpt.php", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ prompt })
});

  const text = await response.text();
  try {
    const data = JSON.parse(text);
    output.textContent = data.choices?.[0]?.message?.content || "GPT khÃ´ng tráº£ vá» ná»™i dung.";
  } catch (err) {
    output.textContent = "Lá»—i pháº£n há»“i: " + text;
  }

async function evaluateGPT_Occupy() {
  const input = document.getElementById("intro-occupy").value.trim();
  const output = document.getElementById("eval-occupy");
  const file = document.getElementById("file-occupy").files[0];

  output.innerText = "â³ Äang Ä‘Ã¡nh giÃ¡ Occupy...";

  let fileText = "";
  if (file && file.type === "application/pdf") {
    try {
      fileText = await extractTextFromPDF(file);
    } catch (err) {
      console.error("Lá»—i Ä‘á»c PDF:", err);
    }
  }

  const prompt = `
ÄÃ¢y lÃ  pháº§n Occupy (cÃ¡ch nghiÃªn cá»©u chiáº¿m lÄ©nh khoáº£ng trá»‘ng) trong má»™t Ä‘á» cÆ°Æ¡ng nghiÃªn cá»©u:

"${input}"

${fileText ? "TÃ i liá»‡u PDF liÃªn quan:\n" + fileText : ""}

HÃ£y Ä‘Ã¡nh giÃ¡ Ä‘oáº¡n Occupy trÃªn theo cÃ¡c tiÃªu chÃ­ sau:
- ÄÃ£ nÃªu rÃµ cÃ¡ch nghiÃªn cá»©u sáº½ giáº£i quyáº¿t khoáº£ng trá»‘ng chÆ°a?
- CÃ³ logic liÃªn káº¿t vá»›i pháº§n Niche khÃ´ng?
- CÃ³ lÃ m rÃµ Ä‘Æ°á»£c vai trÃ² vÃ  sá»± cáº§n thiáº¿t cá»§a nghiÃªn cá»©u khÃ´ng?
- CÃ³ nÃªu Ä‘Æ°á»£c Ã½ tÆ°á»Ÿng, phÆ°Æ¡ng phÃ¡p hoáº·c hÆ°á»›ng giáº£i quyáº¿t cá»¥ thá»ƒ khÃ´ng?

Tráº£ lá»i báº±ng tiáº¿ng Viá»‡t.
  `;

try {
  const response = await fetch("https://gpt-api-19xu.onrender.com/gpt.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ prompt })
  });

  const text = await response.text();
  try {
    const data = JSON.parse(text);
    output.innerText = data.choices?.[0]?.message?.content || "GPT khÃ´ng tráº£ vá» ná»™i dung.";
  } catch (jsonError) {
    output.innerText = "âŒ Lá»—i phÃ¢n tÃ­ch JSON: " + text;
  }
} catch (fetchError) {
  output.innerText = "âŒ Lá»—i khi gá»i GPT: " + fetchError.message;
}


//BÆ°á»›c 5

function addLiteratureSection(title = "", content = "") {
  const container = document.getElementById("literature-sections");
  const div = document.createElement("div");
  div.className = "literature-section";
  div.innerHTML = `
    <input type="text" class="literature-title" placeholder="TiÃªu Ä‘á» má»¥c tá»•ng quan" value="${title}" oninput="saveData()">
    <textarea class="literature-content" placeholder="Ná»™i dung tá»•ng quan...">${content}</textarea>
    <button onclick="this.parentElement.remove(); saveData()">ğŸ—‘ XÃ³a má»¥c nÃ y</button>
    <hr>
  `;
  container.appendChild(div);
}

async function generateGPT_YHHD_Overview() {
  const p = document.getElementById("pico-p").value.trim();
  const i = document.getElementById("pico-i").value.trim();
  const c = document.getElementById("pico-c").value.trim();
  const o = document.getElementById("pico-o").value.trim();
  const question = document.getElementById("question").value.trim();
  const objective = document.getElementById("main-objective").value.trim();

  const fileInput = document.getElementById("file-yhhd-overview");
  const file = fileInput.files[0];
  let fileText = "";

  if (file && file.type === "application/pdf") {
    try {
      fileText = await extractTextFromPDF(file);
    } catch (err) {
      console.error("Lá»—i Ä‘á»c PDF:", err);
    }
  }

  const prompt = `Dá»±a trÃªn thÃ´ng tin sau:
- P: ${p}
- I: ${i}
- C: ${c}
- O: ${o}
- CÃ¢u há»i nghiÃªn cá»©u: ${question}
- Má»¥c tiÃªu chÃ­nh: ${objective}
- TÃ i liá»‡u tham kháº£o: ${fileText}

HÃ£y viáº¿t pháº§n tá»•ng quan vá» Ä‘áº¡i cÆ°Æ¡ng y há»c hiá»‡n Ä‘áº¡i liÃªn quan Ä‘áº¿n bá»‡nh/tÃ¬nh tráº¡ng Ä‘ang nghiÃªn cá»©u chá»‰ táº­p trung vÃ o khÃ¡i niá»‡m, Ä‘á»‹nh nghÄ©a, cáº§n pháº£i trÃ¬nh bÃ y rÃµ rÃ ng, cÃ³ dáº«n dáº¯t há»£p lÃ½ nhÆ° trong pháº§n tá»•ng quan tÃ i liá»‡u cá»§a má»™t Ä‘á» cÆ°Æ¡ng RCT. Náº¿u cÃ³ táº£i tÃ i liá»‡u lÃªn thÃ¬ khi sá»­ dá»¥ng thÃ´ng tin trong tÃ i liá»‡u nÃ o pháº£i Ä‘Ã¡nh sá»‘ trÃ­ch dáº«n vÃ  cuá»‘i cÃ¹ng pháº£i cho danh má»¥c tÃ i liá»‡u Ä‘Ã£ tham kháº£o theo AMA 11.`;

  const output = document.getElementById("suggest-yhhd-overview");
  output.textContent = "â³ Äang sinh ná»™i dung tá»« GPT...";

 try {
  const response = await fetch("https://gpt-api-19xu.onrender.com/gpt.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ prompt })
  });

  const text = await response.text();

  try {
    const data = JSON.parse(text);
    const result = data.choices?.[0]?.message?.content || "GPT khÃ´ng tráº£ vá» káº¿t quáº£.";
    output.textContent = result;
  } catch (e) {
    output.textContent = "âŒ Lá»—i xá»­ lÃ½ pháº£n há»“i GPT: " + text;
  }
} catch (error) {
  output.textContent = "âŒ Lá»—i khi gá»i GPT API: " + error.message;
}

async function evaluateGPT_YHHD_Overview() {
  const inputText = document.getElementById('text-yhhd-overview').value.trim();
  const output = document.getElementById('eval-yhhd-overview');

  const prompt = `ÄÃ¡nh giÃ¡ Ä‘oáº¡n vÄƒn sau vá» má»©c Ä‘á»™ phÃ¹ há»£p khi viáº¿t pháº§n *Äáº¡i cÆ°Æ¡ng Y há»c hiá»‡n Ä‘áº¡i* trong tá»•ng quan tÃ i liá»‡u cá»§a má»™t Ä‘á» cÆ°Æ¡ng RCT. Xem xÃ©t cÃ¡c tiÃªu chÃ­: Ä‘á»™ rÃµ rÃ ng, má»©c Ä‘á»™ tá»•ng quÃ¡t, sá»± liÃªn káº¿t Ä‘áº¿n váº¥n Ä‘á» nghiÃªn cá»©u vÃ  cáº­p nháº­t tÃ i liá»‡u.
---
${inputText}`;

  output.textContent = "â³ Äang Ä‘Ã¡nh giÃ¡ báº±ng GPT...";
  try {
  const response = await fetch("https://gpt-api-19xu.onrender.com/gpt.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ prompt })
  });

  const text = await response.text();

  try {
    const data = JSON.parse(text);
    const result = data.choices?.[0]?.message?.content || "GPT khÃ´ng tráº£ vá» pháº£n há»“i.";
    output.textContent = result;
  } catch (e) {
    output.textContent = "âŒ Lá»—i xá»­ lÃ½ JSON: " + text;
  }

} catch (error) {
  output.textContent = "âŒ Lá»—i khi gá»i GPT API: " + error.message;
}
  
async function generateGPT_Epidemiology() {
  const fileInput = document.getElementById('file-epidemiology');
  const output = document.getElementById('suggest-epidemiology');
  const file = fileInput.files[0];
  let fileText = "";

  if (file && file.type === "application/pdf") {
    output.textContent = "ğŸ“„ Äang Ä‘á»c ná»™i dung tá»« PDF...";
    fileText = await extractTextFromPDF(file);
  }

  const p = document.getElementById("pico-p").value.trim();
  const i = document.getElementById("pico-i").value.trim();
  const c = document.getElementById("pico-c").value.trim();
  const o = document.getElementById("pico-o").value.trim();

  const prompt = `Viáº¿t pháº§n tá»•ng quan dá»‹ch tá»… há»c vÃ  gÃ¡nh náº·ng bá»‡nh táº­t cá»§a bá»‡nh hoáº·c tÃ¬nh tráº¡ng nghiÃªn cá»©u, phÃ¹ há»£p vá»›i bá»‘i cáº£nh Ä‘á» cÆ°Æ¡ng RCT. LÆ°u Ã½ cáº§n minh chá»©ng máº¡nh máº½ báº±ng cÃ¡ch sá»‘ liá»‡u áº¥n tÆ°á»£ng, cÃ³ Ã½ nghÄ©a cao tá»« cÃ¡c nghiÃªn cá»©u Ä‘Ã£ cÃ´ng bá»‘ hoáº·c tá»« tÃ i liá»‡u ngÆ°á»i dÃ¹ng táº£i lÃªn. Náº¿u cÃ³ táº£i tÃ i liá»‡u lÃªn thÃ¬ khi sá»­ dá»¥ng thÃ´ng tin trong tÃ i liá»‡u nÃ o pháº£i Ä‘Ã¡nh sá»‘ trÃ­ch dáº«n vÃ  cuá»‘i cÃ¹ng pháº£i cho danh má»¥c tÃ i liá»‡u Ä‘Ã£ tham kháº£o theo AMA 11. 
ThÃ´ng tin nghiÃªn cá»©u:
- P: ${p}
- I: ${i}
- C: ${c}
- O: ${o}

${fileText ? "\nTÃ i liá»‡u PDF cung cáº¥p:\n" + fileText : ""}`;

  output.textContent = "â³ Äang sinh ná»™i dung tá»« GPT...";
  
try {
  const response = await fetch("https://gpt-api-19xu.onrender.com/gpt.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ prompt })
  });

  const text = await response.text();

  try {
    const data = JSON.parse(text);
    const result = data.choices?.[0]?.message?.content || "GPT khÃ´ng tráº£ vá» pháº£n há»“i.";
    output.textContent = result;
  } catch (e) {
    output.textContent = "âŒ Lá»—i xá»­ lÃ½ JSON: " + text;
  }

} catch (error) {
  output.textContent = "âŒ Lá»—i khi gá»i GPT API: " + error.message;
}

async function evaluateGPT_Epidemiology() {
  const inputText = document.getElementById('text-epidemiology').value.trim();
  const output = document.getElementById('eval-epidemiology');

  const prompt = `ÄÃ¡nh giÃ¡ Ä‘oáº¡n vÄƒn sau vá» má»©c Ä‘á»™ Ä‘áº§y Ä‘á»§ vÃ  há»£p lÃ½ khi trÃ¬nh bÃ y pháº§n *Dá»‹ch tá»… há»c vÃ  gÃ¡nh náº·ng bá»‡nh táº­t* trong tá»•ng quan tÃ i liá»‡u cá»§a Ä‘á» cÆ°Æ¡ng nghiÃªn cá»©u. Cáº§n nháº­n xÃ©t xem cÃ¡c sá»‘ liá»‡u Ä‘Ã£ há»£p lÃ½, áº¥n tÆ°á»£ng, cÃ³ trÃ­ch dáº«n tÃ i liá»‡u tham kháº£o rÃµ rÃ ng, lÃ m sÃ¡ng tá» Ä‘Æ°á»£c bá»‡nh/tÃ¬nh tráº¡ng Ä‘ang nghiÃªn cá»©u lÃ  váº¥n Ä‘á» cáº¥p thiáº¿t khÃ´ng:
---
${inputText}`;

  output.textContent = "â³ Äang Ä‘Ã¡nh giÃ¡ ná»™i dung...";
  try {
  const response = await fetch("https://gpt-api-19xu.onrender.com/gpt.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ prompt })
  });

  const text = await response.text();

  try {
    const data = JSON.parse(text);
    const result = data.choices?.[0]?.message?.content || "GPT khÃ´ng tráº£ vá» pháº£n há»“i.";
    output.textContent = result;
  } catch (e) {
    output.textContent = "âŒ Lá»—i xá»­ lÃ½ JSON: " + text;
  }

} catch (error) {
  output.textContent = "âŒ Lá»—i khi gá»i GPT API: " + error.message;
}

async function generateGPT_Diagnosis() {
  const fileInput = document.getElementById('file-diagnosis');
  const output = document.getElementById('suggest-diagnosis');
  const file = fileInput.files[0];
  let fileText = "";

  if (file && file.type === "application/pdf") {
    output.textContent = "ğŸ“„ Äang Ä‘á»c ná»™i dung tá»« PDF...";
    fileText = await extractTextFromPDF(file);
  }

  const p = document.getElementById("pico-p").value.trim();
  const i = document.getElementById("pico-i").value.trim();
  const c = document.getElementById("pico-c").value.trim();
  const o = document.getElementById("pico-o").value.trim();

  const prompt = `Dá»±a trÃªn cÃ¡c thÃ´ng tin sau, hÃ£y viáº¿t pháº§n tá»•ng quan vá» *cháº©n Ä‘oÃ¡n y há»c hiá»‡n Ä‘áº¡i* liÃªn quan Ä‘áº¿n bá»‡nh hoáº·c tÃ¬nh tráº¡ng Ä‘ang nghiÃªn cá»©u, phÃ¹ há»£p vá»›i má»™t Ä‘á» cÆ°Æ¡ng RCT. Náº¿u bá»‡nh/tÃ¬nh tráº¡ng cÃ³ tiÃªu chuáº©n cháº©n Ä‘oÃ¡n rÃµ rÃ ng do hiá»‡p há»™i chuyÃªn ngÃ nh uy tÃ­n Ä‘á» xuáº¥t thÃ¬ nÃªu rÃµ tiÃªu chuáº©n, kÃ¨m Ä‘á»™ nháº¡y Ä‘á»™ Ä‘áº·c hiá»‡u cá»§a tiÃªu chuáº©n (náº¿u cÃ³). Náº¿u khÃ´ng cÃ³ tiÃªu chuáº©n cháº©n Ä‘oÃ¡n rÃµ rÃ ng, thÃ¬ cáº§n Ä‘Ã¡nh giÃ¡ xem tiÃªu chuáº©n nÃ o thÆ°á»ng Ä‘Æ°á»£c dÃ¹ng Ä‘á»ƒ tuyá»ƒn chá»n máº«u trong cÃ¡c RCT lá»›n liÃªn quan Ä‘áº¿n bá»‡nh/tÃ¬nh tráº¡ng nÃ y. Náº¿u cÃ³ táº£i tÃ i liá»‡u lÃªn thÃ¬ khi sá»­ dá»¥ng thÃ´ng tin trong tÃ i liá»‡u nÃ o pháº£i Ä‘Ã¡nh sá»‘ trÃ­ch dáº«n vÃ  cuá»‘i cÃ¹ng pháº£i cho danh má»¥c tÃ i liá»‡u Ä‘Ã£ tham kháº£o theo AMA 11:
- P: ${p}
- I: ${i}
- C: ${c}
- O: ${o}

${fileText ? "\nTÃ i liá»‡u ngÆ°á»i dÃ¹ng cung cáº¥p:\n" + fileText : ""}`;

  output.textContent = "â³ Äang sinh ná»™i dung tá»« GPT...";

  try {
  const response = await fetch("https://gpt-api-19xu.onrender.com/gpt.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ prompt })
  });

  const text = await response.text();

  try {
    const data = JSON.parse(text);
    const result = data.choices?.[0]?.message?.content || "GPT khÃ´ng tráº£ vá» pháº£n há»“i.";
    output.textContent = result;
  } catch (e) {
    output.textContent = "âŒ Lá»—i xá»­ lÃ½ JSON: " + text;
  }

} catch (error) {
  output.textContent = "âŒ Lá»—i khi gá»i GPT API: " + error.message;
}

async function evaluateGPT_Diagnosis() {
  const inputText = document.getElementById('text-diagnosis').value.trim();
  const output = document.getElementById('eval-diagnosis');

  const prompt = `ÄÃ¡nh giÃ¡ Ä‘oáº¡n vÄƒn sau vá» Ä‘á»™ phÃ¹ há»£p, Ä‘áº§y Ä‘á»§ vÃ  tÃ­nh há»‡ thá»‘ng khi trÃ¬nh bÃ y pháº§n *cháº©n Ä‘oÃ¡n y há»c hiá»‡n Ä‘áº¡i* trong Ä‘á» cÆ°Æ¡ng nghiÃªn cá»©u RCT theo cÃ¡c tiÃªu chÃ­ lÃ  chi tiáº¿t, rÃµ rÃ ng, xÃºc tÃ­ch, cÃ³ minh chá»©ng Ä‘áº§y Ä‘á»§, cÃ³ Ä‘Æ°á»£c cá»™ng Ä‘á»“ng y khoa hiá»‡n hÃ nh cÃ´ng nháº­n khÃ´ng:
---
${inputText}`;

  output.textContent = "â³ Äang Ä‘Ã¡nh giÃ¡ ná»™i dung...";

  try {
  const response = await fetch("https://gpt-api-19xu.onrender.com/gpt.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ prompt })
  });

  const text = await response.text();

  try {
    const data = JSON.parse(text);
    const result = data.choices?.[0]?.message?.content || "GPT khÃ´ng tráº£ vá» pháº£n há»“i.";
    output.textContent = result;
  } catch (e) {
    output.textContent = "âŒ Lá»—i xá»­ lÃ½ JSON: " + text;
  }

} catch (error) {
  output.textContent = "âŒ Lá»—i khi gá»i GPT API: " + error.message;
}


async function generateGPT_Treatment() {
  const fileInput = document.getElementById('file-treatment');
  const output = document.getElementById('suggest-treatment');
  const file = fileInput.files[0];
  let fileText = "";

  if (file && file.type === "application/pdf") {
    output.textContent = "ğŸ“„ Äang Ä‘á»c ná»™i dung tá»« PDF...";
    fileText = await extractTextFromPDF(file);
  }

  const p = document.getElementById("pico-p").value.trim();
  const i = document.getElementById("pico-i").value.trim();
  const c = document.getElementById("pico-c").value.trim();
  const o = document.getElementById("pico-o").value.trim();

  const prompt = `Dá»±a trÃªn thÃ´ng tin sau, hÃ£y viáº¿t pháº§n tá»•ng quan vá» *Ä‘iá»u trá»‹ y há»c hiá»‡n Ä‘áº¡i* cho tÃ¬nh tráº¡ng Ä‘ang nghiÃªn cá»©u. Náº¿u cÃ³ guideline hÆ°á»›ng dáº«n cá»§a hiá»‡p há»™i chuyÃªn ngÃ nh uy tÃ­n thÃ¬ nÃªn theo guideline Ä‘Ã³. Cáº§n chÃº Ã½ Ä‘áº¿n tÃ­nh káº¿t há»£p liÃªn ngÃ nh vÃ  quáº£n lÃ½ toÃ n diá»‡n. Náº¿u cÃ³ táº£i tÃ i liá»‡u lÃªn thÃ¬ khi sá»­ dá»¥ng thÃ´ng tin trong tÃ i liá»‡u nÃ o pháº£i Ä‘Ã¡nh sá»‘ trÃ­ch dáº«n vÃ  cuá»‘i cÃ¹ng pháº£i cho danh má»¥c tÃ i liá»‡u Ä‘Ã£ tham kháº£o theo AMA 11:
- P: ${p}
- I: ${i}
- C: ${c}
- O: ${o}

${fileText ? "\nTÃ i liá»‡u ngÆ°á»i dÃ¹ng cung cáº¥p:\n" + fileText : ""}`;

  output.textContent = "â³ Äang sinh ná»™i dung tá»« GPT...";

  try {
  const response = await fetch("https://gpt-api-19xu.onrender.com/gpt.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ prompt })
  });

  const text = await response.text();

  try {
    const data = JSON.parse(text);
    const result = data.choices?.[0]?.message?.content || "GPT khÃ´ng tráº£ vá» pháº£n há»“i.";
    output.textContent = result;
  } catch (e) {
    output.textContent = "âŒ Lá»—i xá»­ lÃ½ JSON: " + text;
  }

} catch (error) {
  output.textContent = "âŒ Lá»—i khi gá»i GPT API: " + error.message;
}

async function evaluateGPT_Treatment() {
  const inputText = document.getElementById('text-treatment').value.trim();
  const output = document.getElementById('eval-treatment');

  const prompt = `ÄÃ¡nh giÃ¡ Ä‘oáº¡n vÄƒn sau vá» tÃ­nh Ä‘áº§y Ä‘á»§, chÃ­nh xÃ¡c vÃ  cáº­p nháº­t trong pháº§n *Ä‘iá»u trá»‹ y há»c hiá»‡n Ä‘áº¡i* cá»§a má»™t Ä‘á» cÆ°Æ¡ng RCT. Xem xÃ©t cÃ¡c khÃ­a cáº¡nh: phÃ¡c Ä‘á»“ Ä‘iá»u trá»‹ chÃ­nh, báº±ng chá»©ng hiá»‡u quáº£, tÃ­nh thá»±c hÃ nh vÃ  liÃªn quan Ä‘áº¿n PICO.
---
${inputText}`;

  output.textContent = "â³ Äang Ä‘Ã¡nh giÃ¡ ná»™i dung...";

  try {
  const response = await fetch("https://gpt-api-19xu.onrender.com/gpt.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ prompt })
  });

  const text = await response.text();

  try {
    const data = JSON.parse(text);
    const result = data.choices?.[0]?.message?.content || "GPT khÃ´ng tráº£ vá» pháº£n há»“i.";
    output.textContent = result;
  } catch (e) {
    output.textContent = "âŒ Lá»—i xá»­ lÃ½ JSON: " + text;
  }

} catch (error) {
  output.textContent = "âŒ Lá»—i khi gá»i GPT API: " + error.message;
}

async function generateGPT_Limitation() {
  const fileInput = document.getElementById('file-limitation');
  const output = document.getElementById('suggest-limitation');
  const file = fileInput.files[0];
  let fileText = "";

  if (file && file.type === "application/pdf") {
    output.textContent = "ğŸ“„ Äang Ä‘á»c ná»™i dung tá»« PDF...";
    fileText = await extractTextFromPDF(file);
  }

  const p = document.getElementById("pico-p").value.trim();
  const i = document.getElementById("pico-i").value.trim();
  const c = document.getElementById("pico-c").value.trim();
  const o = document.getElementById("pico-o").value.trim();

  const prompt = `Dá»±a trÃªn thÃ´ng tin sau, hÃ£y viáº¿t pháº§n tá»•ng quan vá» *cÃ¡c háº¡n cháº¿ cá»§a Y há»c hiá»‡n Ä‘áº¡i trong quáº£n lÃ½ tÃ¬nh tráº¡ng bá»‡nh nghiÃªn cá»©u*. Cáº§n cÃ³ cÃ¡c sá»‘ liá»‡u thá»±c táº¿ tá»« cÃ¡c RCT hay meta-analysis khÃ¡c Ä‘á»ƒ chá»©ng minh cÃ¡c liá»‡u phÃ¡p Ä‘iá»u trá»‹ hiá»‡n táº¡i cá»§a y há»c hiá»‡n Ä‘áº¡i vá» bá»‡nh/tÃ¬nh tráº¡ng trong nghiÃªn cá»©u nÃ y cÃ²n háº¡n cháº¿ á»Ÿ cÃ¡c khÃ­a cáº¡nh nhÆ° tá»· lá»‡ Ä‘áº¡t hiá»ƒu quáº£ chÆ°a quÃ¡ cao, cÃ²n nhiá»u bá»‡nh nhÃ¢n khÃ¡ng trá»‹ hoáº·c Ä‘Ã¡p á»©ng Ä‘iá»u trá»‹ khÃ´ng Ä‘áº§y Ä‘á»§, kÃ©m tuÃ¢n thá»§ do tÃ¡c dá»¥ng phá»¥, cÃ³ quÃ¡ nhiá»u biáº¿n chá»©ng cá»§a Ä‘iá»u trá»‹, hoáº·c chi phÃ­ Ä‘iá»u trá»‹ quÃ¡ cao. Náº¿u cÃ³ táº£i tÃ i liá»‡u lÃªn thÃ¬ khi sá»­ dá»¥ng thÃ´ng tin trong tÃ i liá»‡u nÃ o pháº£i Ä‘Ã¡nh sá»‘ trÃ­ch dáº«n vÃ  cuá»‘i cÃ¹ng pháº£i cho danh má»¥c tÃ i liá»‡u Ä‘Ã£ tham kháº£o theo AMA 11:
- P: ${p}
- I: ${i}
- C: ${c}
- O: ${o}

${fileText ? "\nTÃ i liá»‡u ngÆ°á»i dÃ¹ng cung cáº¥p:\n" + fileText : ""}`;

  output.textContent = "â³ Äang sinh ná»™i dung tá»« GPT...";

 try {
  const response = await fetch("https://gpt-api-19xu.onrender.com/gpt.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ prompt })
  });

  const text = await response.text();

  try {
    const data = JSON.parse(text);
    const result = data.choices?.[0]?.message?.content || "GPT khÃ´ng tráº£ vá» pháº£n há»“i.";
    output.textContent = result;
  } catch (e) {
    output.textContent = "âŒ Lá»—i xá»­ lÃ½ JSON: " + text;
  }

} catch (error) {
  output.textContent = "âŒ Lá»—i khi gá»i GPT API: " + error.message;
}

async function evaluateGPT_Limitation() {
  const inputText = document.getElementById('text-limitation').value.trim();
  const output = document.getElementById('eval-limitation');

  const prompt = `ÄÃ¡nh giÃ¡ Ä‘oáº¡n vÄƒn sau vá» tÃ­nh há»£p lÃ½, cá»¥ thá»ƒ vÃ  cáº­p nháº­t khi trÃ¬nh bÃ y *cÃ¡c háº¡n cháº¿ cá»§a Y há»c hiá»‡n Ä‘áº¡i* trong quáº£n lÃ½ tÃ¬nh tráº¡ng bá»‡nh nghiÃªn cá»©u. Xem xÃ©t cÃ¡c tiÃªu chÃ­: Ä‘á»™ Ä‘áº§y Ä‘á»§, dáº«n chá»©ng, vÃ  má»©c Ä‘á»™ liÃªn káº¿t vá»›i PICO.
---
${inputText}`;

  output.textContent = "â³ Äang Ä‘Ã¡nh giÃ¡ ná»™i dung...";

 try {
  const response = await fetch("https://gpt-api-19xu.onrender.com/gpt.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ prompt })
  });

  const text = await response.text();

  try {
    const data = JSON.parse(text);
    const result = data.choices?.[0]?.message?.content || "GPT khÃ´ng tráº£ vá» pháº£n há»“i.";
    output.textContent = result;
  } catch (e) {
    output.textContent = "âŒ Lá»—i xá»­ lÃ½ JSON: " + text;
  }

} catch (error) {
  output.textContent = "âŒ Lá»—i khi gá»i GPT API: " + error.message;
}

async function generateGPT_YHCT_Overview() {
  const fileInput = document.getElementById('file-yhct-overview');
  const output = document.getElementById('suggest-yhct-overview');
  const file = fileInput.files[0];
  let fileText = "";

  if (file && file.type === "application/pdf") {
    output.textContent = "ğŸ“„ Äang Ä‘á»c ná»™i dung tá»« PDF...";
    fileText = await extractTextFromPDF(file);
  }

  const p = document.getElementById("pico-p").value.trim();
  const i = document.getElementById("pico-i").value.trim();
  const c = document.getElementById("pico-c").value.trim();
  const o = document.getElementById("pico-o").value.trim();

  const prompt = `Dá»±a trÃªn thÃ´ng tin sau, hÃ£y viáº¿t pháº§n *tá»•ng quan vá» Y há»c cá»• truyá»n (YHCT)* liÃªn quan Ä‘áº¿n tÃ¬nh tráº¡ng bá»‡nh trong nghiÃªn cá»©u. Táº­p trung vÃ o cÃ¡c thÃ´ng tin chÃ­nh nhÆ° quan niá»‡m cá»§a y há»c cá»• truyá»n vá» bá»‡nh/tÃ¬nh tráº¡ng Ä‘ang nghiÃªn cá»©u Ä‘Æ°á»£c mÃ´ táº£ trong chá»©ng nÃ o cá»§a y há»c cá»• truyá»n, chá»©ng Ä‘Ã³ Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a lÃ  gÃ¬. CÃ¡c cá»• vÄƒn nhÆ° Tá»‘ váº¥n. Linh khu, Kim quá»¹ yáº¿u lÆ°á»£c, ThÆ°Æ¡ng hÃ n luáº­n, ChÆ° bá»‡nh nguyÃªn háº­u luáº­n, Cáº£nh Nháº¡c toÃ n thÆ°, Äan KhÃª tÃ¢m phÃ¡p...Ä‘Ã£ bÃ n luáº­n vá» chá»©ng nÃ y ra sao (náº¿u cÃ³). Náº¿u cÃ³ táº£i tÃ i liá»‡u lÃªn thÃ¬ khi sá»­ dá»¥ng thÃ´ng tin trong tÃ i liá»‡u nÃ o pháº£i Ä‘Ã¡nh sá»‘ trÃ­ch dáº«n vÃ  cuá»‘i cÃ¹ng pháº£i cho danh má»¥c tÃ i liá»‡u Ä‘Ã£ tham kháº£o theo AMA 11:
- P: ${p}
- I: ${i}
- C: ${c}
- O: ${o}

${fileText ? "\nTÃ i liá»‡u ngÆ°á»i dÃ¹ng cung cáº¥p:\n" + fileText : ""}`;

  output.textContent = "â³ Äang sinh ná»™i dung tá»« GPT...";

 try {
  const response = await fetch("https://gpt-api-19xu.onrender.com/gpt.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ prompt })
  });

  const text = await response.text();

  try {
    const data = JSON.parse(text);
    const result = data.choices?.[0]?.message?.content || "GPT khÃ´ng tráº£ vá» pháº£n há»“i.";
    output.textContent = result;
  } catch (e) {
    output.textContent = "âŒ Lá»—i xá»­ lÃ½ JSON: " + text;
  }

} catch (error) {
  output.textContent = "âŒ Lá»—i khi gá»i GPT API: " + error.message;
}

async function evaluateGPT_YHCT_Overview() {
  const inputText = document.getElementById('text-yhct-overview').value.trim();
  const output = document.getElementById('eval-yhct-overview');

  const prompt = `ÄÃ¡nh giÃ¡ Ä‘oáº¡n vÄƒn sau vá» tÃ­nh há»£p lÃ½, Ä‘Ãºng lÃ½ luáº­n vÃ  Ä‘áº§y Ä‘á»§ khi trÃ¬nh bÃ y pháº§n tá»•ng quan Y há»c cá»• truyá»n (YHCT) vá» tÃ¬nh tráº¡ng bá»‡nh nghiÃªn cá»©u. CÃ¡c tiÃªu chÃ­ cáº§n cÃ¢n nháº¯c: CÃ³ trÃ­ch dáº«n rÃµ rÃ ng khÃ´ng? cÃ³ nháº¯c Ä‘áº¿n cá»• vÄƒn khÃ´ng? cÃ³ nÃªu rÃµ Ä‘Æ°á»£c bá»‡nh/tÃ¬nh tráº¡ng nÃ y Ä‘á»‘i vá»›i y há»c cá»• truyá»n thÃ¬ liÃªn quan Ä‘áº¿n chá»©ng tráº¡ng nÃ o khÃ´ng? NÃªu rÃµ Ä‘iá»ƒm máº¡nh, Ä‘iá»ƒm yáº¿u náº¿u cÃ³:
---
${inputText}`;

  output.textContent = "â³ Äang Ä‘Ã¡nh giÃ¡ ná»™i dung...";

  try {
  const response = await fetch("https://gpt-api-19xu.onrender.com/gpt.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ prompt })
  });

  const text = await response.text();

  try {
    const data = JSON.parse(text);
    const result = data.choices?.[0]?.message?.content || "GPT khÃ´ng tráº£ vá» pháº£n há»“i.";
    output.textContent = result;
  } catch (e) {
    output.textContent = "âŒ Lá»—i xá»­ lÃ½ JSON: " + text;
  }

} catch (error) {
  output.textContent = "âŒ Lá»—i khi gá»i GPT API: " + error.message;
}

async function generateGPT_Intervention() {
  const fileInput = document.getElementById('file-intervention');
  const output = document.getElementById('suggest-intervention');
  const file = fileInput.files[0];
  let fileText = "";

  if (file && file.type === "application/pdf") {
    output.textContent = "ğŸ“„ Äang Ä‘á»c ná»™i dung tá»« PDF...";
    fileText = await extractTextFromPDF(file);
  }

  const p = document.getElementById("pico-p").value.trim();
  const i = document.getElementById("pico-i").value.trim();
  const c = document.getElementById("pico-c").value.trim();
  const o = document.getElementById("pico-o").value.trim();

  const prompt = `Dá»±a trÃªn thÃ´ng tin sau, hÃ£y mÃ´ táº£ chi tiáº¿t cÃ¡c *liá»‡u phÃ¡p can thiá»‡p* cá»§a y há»c cá»• truyá»n Ä‘ang Ä‘Æ°á»£c nghiÃªn cá»©u. Cáº§n Ä‘iá»ƒm qua háº§u háº¿t cÃ¡c liá»‡u phÃ¡p thÆ°á»ng dÃ¹ng trong y há»c cá»• truyá»n nhÆ° chÃ¢m cá»©u, xoa bÃ³p báº¥m huyá»‡t, cÃ¡c hÃ¬nh thá»©c táº­p luyá»‡n truyá»n thá»‘ng (khÃ­ cÃ´ng, yoga, thÃ¡i cá»±c quyá»n...), thuá»‘c thang, thuá»‘c thÃ nh pháº©m, thuá»‘c xÃ´ng, thuá»‘c dÃ¡n...Táº¥t cáº£ Ä‘á»u cáº§n cÃ³ minh chá»©ng rÃµ rÃ ng báº±ng cÃ¡c RCT hoáº·c cÃ¡c meta-analysis hoáº·c cÃ¡c guideline vá» y há»c cá»• truyá»n. Náº¿u cÃ³ táº£i tÃ i liá»‡u lÃªn thÃ¬ khi sá»­ dá»¥ng thÃ´ng tin trong tÃ i liá»‡u nÃ o pháº£i Ä‘Ã¡nh sá»‘ trÃ­ch dáº«n vÃ  cuá»‘i cÃ¹ng pháº£i cho danh má»¥c tÃ i liá»‡u Ä‘Ã£ tham kháº£o theo AMA 11:
- P: ${p}
- I: ${i}
- C: ${c}
- O: ${o}

${fileText ? "\nTÃ i liá»‡u ngÆ°á»i dÃ¹ng cung cáº¥p:\n" + fileText : ""}`;

  output.textContent = "â³ Äang sinh ná»™i dung tá»« GPT...";

  try {
  const response = await fetch("https://gpt-api-19xu.onrender.com/gpt.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ prompt })
  });

  const text = await response.text();

  try {
    const data = JSON.parse(text);
    const result = data.choices?.[0]?.message?.content || "GPT khÃ´ng tráº£ vá» pháº£n há»“i.";
    output.textContent = result;
  } catch (e) {
    output.textContent = "âŒ Lá»—i xá»­ lÃ½ JSON: " + text;
  }

} catch (error) {
  output.textContent = "âŒ Lá»—i khi gá»i GPT API: " + error.message;
}

async function evaluateGPT_Intervention() {
  const inputText = document.getElementById('text-intervention').value.trim();
  const output = document.getElementById('eval-intervention');

  const prompt = `ÄÃ¡nh giÃ¡ Ä‘oáº¡n vÄƒn sau vá» *tÃ­nh Ä‘áº§y Ä‘á»§, rÃµ rÃ ng vÃ  khoa há»c* trong mÃ´ táº£ cÃ¡c liá»‡u phÃ¡p can thiá»‡p (bao gá»“m tÃªn can thiá»‡p, liá»u lÆ°á»£ng, thá»i gian, Ä‘Æ°á»ng dÃ¹ng... náº¿u cÃ³). CÃ³ Ä‘iá»ƒm qua háº§u háº¿t cÃ¡c liá»‡u phÃ¡p thÆ°á»ng dÃ¹ng trong y há»c cá»• truyá»n nhÆ° chÃ¢m cá»©u, xoa bÃ³p báº¥m huyá»‡t, cÃ¡c hÃ¬nh thá»©c táº­p luyá»‡n truyá»n thá»‘ng (khÃ­ cÃ´ng, yoga, thÃ¡i cá»±c quyá»n...), thuá»‘c thang, thuá»‘c thÃ nh pháº©m, thuá»‘c xÃ´ng, thuá»‘c dÃ¡n hay chÆ°a?. Táº¥t cáº£ Ä‘Ã£ cÃ³ minh chá»©ng rÃµ rÃ ng báº±ng cÃ¡c RCT hoáº·c cÃ¡c meta-analysis hoáº·c cÃ¡c guideline vá» y há»c cá»• truyá»n chÆ°a?:
---
${inputText}`;

  output.textContent = "â³ Äang Ä‘Ã¡nh giÃ¡ ná»™i dung...";

  try {
  const response = await fetch("https://gpt-api-19xu.onrender.com/gpt.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ prompt })
  });

  const text = await response.text();

  try {
    const data = JSON.parse(text);
    const result = data.choices?.[0]?.message?.content || "GPT khÃ´ng tráº£ vá» pháº£n há»“i.";
    output.textContent = result;
  } catch (e) {
    output.textContent = "âŒ Lá»—i xá»­ lÃ½ JSON: " + text;
  }

} catch (error) {
  output.textContent = "âŒ Lá»—i khi gá»i GPT API: " + error.message;
}

async function generateGPT_RelatedStudies() {
  const fileInput = document.getElementById('file-related-studies');
  const output = document.getElementById('suggest-related-studies');
  const file = fileInput.files[0];
  let fileText = "";

  if (file && file.type === "application/pdf") {
    output.textContent = "ğŸ“„ Äang Ä‘á»c ná»™i dung tá»« PDF...";
    fileText = await extractTextFromPDF(file);
  }

  const p = document.getElementById("pico-p").value.trim();
  const i = document.getElementById("pico-i").value.trim();
  const c = document.getElementById("pico-c").value.trim();
  const o = document.getElementById("pico-o").value.trim();

  const prompt = `Dá»±a trÃªn thÃ´ng tin sau, hÃ£y viáº¿t pháº§n tá»•ng quan cÃ¡c *nghiÃªn cá»©u liÃªn quan trong vÃ  ngoÃ i nÆ°á»›c* Ä‘áº¿n chá»§ Ä‘á» nghiÃªn cá»©u hiá»‡n táº¡i. MÃ´ táº£ ngáº¯n gá»n tá»«ng nghiÃªn cá»©u, chá»‰ ra Æ°u Ä‘iá»ƒm, háº¡n cháº¿ vÃ  sá»± khÃ¡c biá»‡t so vá»›i nghiÃªn cá»©u hiá»‡n táº¡i. Náº¿u cÃ³ táº£i tÃ i liá»‡u lÃªn thÃ¬ khi sá»­ dá»¥ng thÃ´ng tin trong tÃ i liá»‡u nÃ o pháº£i Ä‘Ã¡nh sá»‘ trÃ­ch dáº«n vÃ  cuá»‘i cÃ¹ng pháº£i cho danh má»¥c tÃ i liá»‡u Ä‘Ã£ tham kháº£o theo AMA 11:
- P: ${p}
- I: ${i}
- C: ${c}
- O: ${o}

${fileText ? "\nTÃ i liá»‡u ngÆ°á»i dÃ¹ng cung cáº¥p:\n" + fileText : ""}`;

  output.textContent = "â³ Äang sinh ná»™i dung tá»« GPT...";

  try {
  const response = await fetch("https://gpt-api-19xu.onrender.com/gpt.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ prompt })
  });

  const text = await response.text();

  try {
    const data = JSON.parse(text);
    const result = data.choices?.[0]?.message?.content || "GPT khÃ´ng tráº£ vá» pháº£n há»“i.";
    output.textContent = result;
  } catch (e) {
    output.textContent = "âŒ Lá»—i xá»­ lÃ½ JSON: " + text;
  }

} catch (error) {
  output.textContent = "âŒ Lá»—i khi gá»i GPT API: " + error.message;
}

async function evaluateGPT_RelatedStudies() {
  const inputText = document.getElementById('text-related-studies').value.trim();
  const output = document.getElementById('eval-related-studies');

  const prompt = `ÄÃ¡nh giÃ¡ Ä‘oáº¡n vÄƒn sau vá» *tÃ­nh cáº­p nháº­t, sá»± liÃªn quan vÃ  phÃ¢n tÃ­ch há»£p lÃ½* khi trÃ¬nh bÃ y cÃ¡c nghiÃªn cá»©u liÃªn quan trong vÃ  ngoÃ i nÆ°á»›c, lÆ°u Ã½ lÃ  cáº§n Ä‘Ã¡nh giÃ¡ xem liá»‡u Ä‘Ã£ nÃªu báº­t Ä‘Æ°á»£c nhá»¯ng háº¡n cháº¿ cá»§a cÃ¡c nghiÃªn cá»©u trÆ°á»›c Ä‘Ã¢y mÃ  cÃ³ thá»ƒ kháº¯c phá»¥c Ä‘Æ°á»£c trong nghiÃªn cá»©u nÃ y chÆ°a:
---
${inputText}`;

  output.textContent = "â³ Äang Ä‘Ã¡nh giÃ¡ ná»™i dung...";

 try {
  const response = await fetch("https://gpt-api-19xu.onrender.com/gpt.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ prompt })
  });

  const text = await response.text();

  try {
    const data = JSON.parse(text);
    const result = data.choices?.[0]?.message?.content || "GPT khÃ´ng tráº£ vá» pháº£n há»“i.";
    output.textContent = result;
  } catch (e) {
    output.textContent = "âŒ Lá»—i xá»­ lÃ½ JSON: " + text;
  }

} catch (error) {
  output.textContent = "âŒ Lá»—i khi gá»i GPT API: " + error.message;
}

async function generateGPT_NewMethods() {
  const fileInput = document.getElementById('file-new-methods');
  const output = document.getElementById('suggest-new-methods');
  const file = fileInput.files[0];
  let fileText = "";

  if (file && file.type === "application/pdf") {
    output.textContent = "ğŸ“„ Äang trÃ­ch xuáº¥t ná»™i dung tá»« PDF...";
    fileText = await extractTextFromPDF(file);
  }

  const p = document.getElementById("pico-p").value.trim();
  const i = document.getElementById("pico-i").value.trim();
  const c = document.getElementById("pico-c").value.trim();
  const o = document.getElementById("pico-o").value.trim();

  const prompt = `Dá»±a vÃ o thÃ´ng tin sau, hÃ£y viáº¿t pháº§n mÃ´ táº£ cÃ¡c *phÆ°Æ¡ng phÃ¡p phÃ¢n tÃ­ch sá»‘ liá»‡u má»›i hoáº·c cÃ¡ch Ä‘Ã¡nh giÃ¡ káº¿t cá»¥c má»›i hoáº·c cÃ´ng cá»¥ Ä‘o lÆ°á»ng má»›i* cÃ³ thá»ƒ Ã¡p dá»¥ng cho nghiÃªn cá»©u nÃ y. Giáº£i thÃ­ch táº¡i sao nÃªn dÃ¹ng, vÃ  lá»£i Ã­ch so vá»›i cÃ¡ch cÅ©. Cáº§n cÃ³ trÃ­ch dáº«n tÃ i liá»‡u tham kháº£o vÃ  Ä‘Ã¡nh sá»‘ tÃ i liá»‡u tham kháº£o rÃµ rÃ ng, minh báº¡ch. Náº¿u cÃ³ táº£i tÃ i liá»‡u lÃªn thÃ¬ khi sá»­ dá»¥ng thÃ´ng tin trong tÃ i liá»‡u nÃ o pháº£i Ä‘Ã¡nh sá»‘ trÃ­ch dáº«n vÃ  cuá»‘i cÃ¹ng pháº£i cho danh má»¥c tÃ i liá»‡u Ä‘Ã£ tham kháº£o theo AMA 11:
- P: ${p}
- I: ${i}
- C: ${c}
- O: ${o}

${fileText ? "\nTÃ i liá»‡u ngÆ°á»i dÃ¹ng cung cáº¥p:\n" + fileText : ""}`;

  output.textContent = "â³ Äang sinh ná»™i dung tá»« GPT...";

  try {
  const response = await fetch("https://gpt-api-19xu.onrender.com/gpt.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ prompt })
  });

  const text = await response.text();

  try {
    const data = JSON.parse(text);
    const result = data.choices?.[0]?.message?.content || "GPT khÃ´ng tráº£ vá» pháº£n há»“i.";
    output.textContent = result;
  } catch (e) {
    output.textContent = "âŒ Lá»—i xá»­ lÃ½ JSON: " + text;
  }

} catch (error) {
  output.textContent = "âŒ Lá»—i khi gá»i GPT API: " + error.message;
}

async function evaluateGPT_NewMethods() {
  const inputText = document.getElementById('text-new-methods').value.trim();
  const output = document.getElementById('eval-new-methods');

  const prompt = `HÃ£y Ä‘Ã¡nh giÃ¡ Ä‘oáº¡n vÄƒn sau vá» *tÃ­nh sÃ¡ng táº¡o, logic vÃ  phÃ¹ há»£p* khi trÃ¬nh bÃ y cÃ¡c phÆ°Æ¡ng phÃ¡p phÃ¢n tÃ­ch má»›i hoáº·c cÃ¡ch Ä‘Ã¡nh giÃ¡ káº¿t cá»¥c má»›i trong nghiÃªn cá»©u:
---
${inputText}`;

  output.textContent = "â³ Äang Ä‘Ã¡nh giÃ¡ ná»™i dung...";

  try {
  const response = await fetch("https://gpt-api-19xu.onrender.com/gpt.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ prompt })
  });

  const text = await response.text();

  try {
    const data = JSON.parse(text);
    const result = data.choices?.[0]?.message?.content || "GPT khÃ´ng tráº£ vá» pháº£n há»“i.";
    output.textContent = result;
  } catch (e) {
    output.textContent = "âŒ Lá»—i xá»­ lÃ½ JSON: " + text;
  }

} catch (error) {
  output.textContent = "âŒ Lá»—i khi gá»i GPT API: " + error.message;
}

//BÆ°á»›c 6
function updateDesignFields() {
  const type = document.getElementById("design-type").value;
  const container = document.getElementById("design-extra-fields");
  container.innerHTML = "";

  if (type === "parallel") {
    container.innerHTML = `
      <label>â±ï¸ Thá»i gian can thiá»‡p (tuáº§n):</label>
      <input type="number" id="intervention-weeks" min="1" oninput="saveData()"><br><br>

      <label>ğŸ”¢ Sá»‘ nhÃ³m can thiá»‡p:</label>
      <input type="number" id="num-arms" min="2" value="2" oninput="renderArms(); saveData()" style="width: 80px;"><br><br>

      <div id="arms-container"></div>
    `;
    renderArms(false); // khÃ´ng save liá»n
  }

  else if (type === "cross-over") {
    container.innerHTML = `
      <label>â±ï¸ Giai Ä‘oáº¡n 1 (tuáº§n):</label>
      <input type="number" id="crossover-phase1" min="1" oninput="saveData()"><br><br>

      <label>ğŸ’‰ Can thiá»‡p nhÃ³m 1 â€“ GÄ1:</label>
      <input type="text" id="crossover-g1-phase1" oninput="saveData()"><br><br>

      <label>ğŸ’‰ Can thiá»‡p nhÃ³m 2 â€“ GÄ1:</label>
      <input type="text" id="crossover-g2-phase1" oninput="saveData()"><br><br>

      <label>ğŸ§¼ Thá»i gian rá»­a trÃ´i (washout, tuáº§n):</label>
      <input type="number" id="crossover-washout" min="1" oninput="saveData()"><br><br>
      
      <label>â±ï¸ Giai Ä‘oáº¡n 1 (tuáº§n):</label>
      <input type="number" id="crossover-phase1" min="1" oninput="saveData()"><br><br>

      <label>ğŸ’‰ Can thiá»‡p nhÃ³m 1 â€“ GÄ2:</label>
      <input type="text" id="crossover-g1-phase2" oninput="saveData()"><br><br>

      <label>ğŸ’‰ Can thiá»‡p nhÃ³m 2 â€“ GÄ2:</label>
      <input type="text" id="crossover-g2-phase2" oninput="saveData()"><br><br>
    `;

    // Äáº£m báº£o cÃ³ hidden num-arms = 2
    const input = document.createElement("input");
    input.type = "hidden";
    input.id = "num-arms";
    input.value = "2";
    container.appendChild(input);

    const div = document.createElement("div");
    div.id = "arms-container";
    container.appendChild(div);
  }

  saveData();
}

function renderArms(save = true) {
  const type = document.getElementById("design-type")?.value;
  if (type !== "parallel") return;  // âŒ KhÃ´ng lÃ m gÃ¬ náº¿u khÃ´ng pháº£i song song

  const num = parseInt(document.getElementById("num-arms").value) || 0;
  const container = document.getElementById("arms-container");
  if (!container) return;
  container.innerHTML = "";

  for (let i = 0; i < num; i++) {
    const div = document.createElement("div");
    div.innerHTML = `
      <label>NhÃ³m ${i + 1}:</label>
      <input type="text" class="arm-description" placeholder="TÃªn nhÃ³m / mÃ´ táº£ ngáº¯n" oninput="saveData()">
    `;
    container.appendChild(div);
  }

  if (save) saveData();
}

function updateNumArms() {
  const n = document.getElementById("num-arms").value;
  localStorage.setItem("num-arms", n);
  renderArms();
  saveData();
}

async function generateGPT_Design() {
  const p = document.getElementById("pico-p")?.value || "";
  const i = document.getElementById("pico-i")?.value || "";
  const c = document.getElementById("pico-c")?.value || "";
  const o = document.getElementById("pico-o")?.value || "";
  const mainObjective = document.getElementById("main-objective")?.value || "";

  const designType = document.getElementById("design-type").value;
  const randomization = document.getElementById("randomization").value;
  const blinding = document.getElementById("blinding").value;
  const file = document.getElementById("file-design").files[0];

  const phase1 = document.getElementById("crossover-phase1")?.value || "";
  const phase2 = document.getElementById("crossover-phase2")?.value || "";
  const washout = document.getElementById("crossover-washout")?.value || "";
  const interventionWeeks = document.getElementById("intervention-weeks")?.value || "";

  const output = document.getElementById("suggest-design");
  output.innerText = "â³ GPT Ä‘ang sinh ná»™i dung...";

  let fileText = "";
  if (file && file.type === "application/pdf") {
    try {
      fileText = await extractTextFromPDF(file);
    } catch (err) {
      console.error("Lá»—i Ä‘á»c PDF:", err);
    }
  }

  const designLabel = (designType === "parallel") ? "thiáº¿t káº¿ song song" :
                      (designType === "cross-over") ? "thiáº¿t káº¿ báº¯t chÃ©o (cross-over)" :
                      "thiáº¿t káº¿ chÆ°a xÃ¡c Ä‘á»‹nh";

  const prompt = `${fileText ? "Ná»™i dung tá»« tÃ i liá»‡u PDF:\n" + fileText + "\n\n" : ""}
DÆ°á»›i Ä‘Ã¢y lÃ  thÃ´ng tin cá»§a Ä‘á» cÆ°Æ¡ng nghiÃªn cá»©u RCT:
- P: ${p}
- I: ${i}
- C: ${c}
- O: ${o}
- Má»¥c tiÃªu chÃ­nh: ${mainObjective}
- Thiáº¿t káº¿ Ä‘Æ°á»£c chá»n: ${designLabel}
- Loáº¡i phÃ¢n bá»• ngáº«u nhiÃªn: ${randomization}
- LÃ m mÃ¹: ${blinding}
- Thá»i gian can thiá»‡p: ${interventionWeeks || "chÆ°a xÃ¡c Ä‘á»‹nh"}
${designType === "cross-over" ? `- Thá»i gian phase 1: ${phase1}
- Thá»i gian washout: ${washout}
- Thá»i gian phase 2: ${phase2}` : ""}

HÃ£y gá»£i Ã½ má»™t mÃ´ táº£ Ä‘áº§y Ä‘á»§ vÃ  há»£p lÃ½ cho pháº§n Thiáº¿t káº¿ nghiÃªn cá»©u. MÃ´ táº£ cáº§n nÃªu rÃµ:
1. Thiáº¿t káº¿ cÃ³ phÃ¹ há»£p vá»›i má»¥c tiÃªu vÃ  bá»‡nh lÃ½ khÃ´ng?
2. PhÃ¢n bá»• ngáº«u nhiÃªn vÃ  lÃ m mÃ¹ chá»n cÃ³ há»£p lÃ½ khÃ´ng?
3. Thá»i gian can thiá»‡p cÃ³ Ä‘á»§ cho hiá»‡u quáº£ vÃ  washout (náº¿u cÃ³)?
4. Náº¿u thiáº¿t káº¿ chÆ°a tá»‘i Æ°u, gá»£i Ã½ thay Ä‘á»•i tá»‘t hÆ¡n.`;

try {
  const response = await fetch("https://gpt-api-19xu.onrender.com/gpt.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ prompt })
  });

  const text = await response.text();

  try {
    const data = JSON.parse(text);
    const result = data.choices?.[0]?.message?.content || "GPT khÃ´ng tráº£ vá» pháº£n há»“i.";
    output.textContent = result;
  } catch (e) {
    output.textContent = "âŒ Lá»—i xá»­ lÃ½ JSON: " + text;
  }

} catch (error) {
  output.textContent = "âŒ Lá»—i khi gá»i GPT API: " + error.message;
}

async function evaluateGPT_Design() {
  const desc = document.getElementById("suggest-design").innerText.trim();
  const p = document.getElementById("pico-p")?.value || "";
  const i = document.getElementById("pico-i")?.value || "";
  const c = document.getElementById("pico-c")?.value || "";
  const o = document.getElementById("pico-o")?.value || "";
  const mainObjective = document.getElementById("main-objective")?.value || "";

  const designType = document.getElementById("design-type").value;
  const randomization = document.getElementById("randomization").value;
  const blinding = document.getElementById("blinding").value;
  const interventionWeeks = document.getElementById("intervention-weeks")?.value || "";

  const phase1 = document.getElementById("crossover-phase1")?.value || "";
  const phase2 = document.getElementById("crossover-phase2")?.value || "";
  const washout = document.getElementById("crossover-washout")?.value || "";

  const output = document.getElementById("eval-design");
  output.innerText = "â³ GPT Ä‘ang Ä‘Ã¡nh giÃ¡...";

  if (!desc) {
    alert("KhÃ´ng cÃ³ ná»™i dung Ä‘á»ƒ Ä‘Ã¡nh giÃ¡.");
    return;
  }

  const prompt = `ÄÃ¢y lÃ  pháº§n mÃ´ táº£ thiáº¿t káº¿ nghiÃªn cá»©u RCT:\n"${desc}"\n\n
ThÃ´ng tin Ä‘á» cÆ°Æ¡ng liÃªn quan:
- P: ${p}
- I: ${i}
- C: ${c}
- O: ${o}
- Má»¥c tiÃªu chÃ­nh: ${mainObjective}
- Loáº¡i thiáº¿t káº¿: ${designType}
- Ngáº«u nhiÃªn hÃ³a: ${randomization}
- LÃ m mÃ¹: ${blinding}
- Thá»i gian can thiá»‡p: ${interventionWeeks}
${designType === "cross-over" ? `- Phase 1: ${phase1}
- Washout: ${washout}
- Phase 2: ${phase2}` : ""}

ğŸ‘‰ HÃ£y Ä‘Ã¡nh giÃ¡:
1. Thiáº¿t káº¿ mÃ´ táº£ cÃ³ phÃ¹ há»£p vá»›i má»¥c tiÃªu nghiÃªn cá»©u khÃ´ng?
2. Loáº¡i hÃ¬nh thiáº¿t káº¿ cÃ³ phÃ¹ há»£p vá»›i bá»‡nh lÃ½ vÃ  káº¿t cá»¥c nghiÃªn cá»©u khÃ´ng?
3. CÃ¡ch lÃ m mÃ¹, phÃ¢n bá»• ngáº«u nhiÃªn cÃ³ há»£p lÃ½ khÃ´ng?
4. Thá»i gian can thiá»‡p cÃ³ phÃ¹ há»£p vÃ  Ä‘á»§ cho hiá»‡u quáº£ can thiá»‡p khÃ´ng?
5. Náº¿u cÃ³ Ä‘iá»ƒm chÆ°a há»£p lÃ½, hÃ£y chá»‰ rÃµ vÃ  gá»£i Ã½ cÃ¡ch cáº£i thiá»‡n.`;

try {
  const response = await fetch("https://gpt-api-19xu.onrender.com/gpt.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ prompt })
  });

  const text = await response.text();

  try {
    const data = JSON.parse(text);
    const result = data.choices?.[0]?.message?.content || "GPT khÃ´ng tráº£ vá» pháº£n há»“i.";
    output.textContent = result;
  } catch (e) {
    output.textContent = "âŒ Lá»—i xá»­ lÃ½ JSON: " + text;
  }

} catch (error) {
  output.textContent = "âŒ Lá»—i khi gá»i GPT API: " + error.message;
}

//BÆ°á»›c 7

function renderSampleSizeForm() {
  const method = document.getElementById("sample-size-method").value;
  const form = document.getElementById("sample-size-form");
  const formula = document.getElementById("sample-size-formula");
  const reference = document.getElementById("sample-size-reference");

  form.innerHTML = "";
  formula.innerHTML = "";
  reference.innerHTML = "";

  if (!method) return;

  const alphaPowerHTML = `
    <label>Alpha:</label>
    <select id="alpha">
      <option value="0.05">0.05</option>
      <option value="0.01">0.01</option>
    </select>

    <label>Power:</label>
    <select id="power">
      <option value="0.80">80%</option>
      <option value="0.90">90%</option>
    </select>
    <br><br>
  `;

  const dropoutHTML = `
    <label>Tá»· lá»‡ máº¥t máº«u dá»± kiáº¿n (%):</label>
    <input type="number" id="dropout-rate" step="1" min="0" max="100" oninput="checkDropoutWarning()">
    <span id="dropout-warning" style="color: red; font-weight: bold;"></span>
  `;

  let hasReference = false;

  if (method === "means") {
    form.innerHTML = `
      ${alphaPowerHTML}
      <label>Äá»™ lá»‡ch chuáº©n (Ïƒ):</label>
      <input type="number" id="sigma" step="0.01">
      <label>Hiá»‡u sá»‘ ká»³ vá»ng (Î”):</label>
      <input type="number" id="delta" step="0.01">
      ${dropoutHTML}
    `;
    formula.innerHTML = `
      n = 2 Ã— [(Z<sub>1âˆ’Î±/2</sub> + Z<sub>1âˆ’Î²</sub>) Ã— Ïƒ / Î”]<sup>2</sup>
    `;
    hasReference = true;

  } else if (method === "noninferiority_means") {
    form.innerHTML = `
      ${alphaPowerHTML}
      <label>Hiá»‡u sá»‘ ká»³ vá»ng (Î¼<sub>T</sub> - Î¼<sub>C</sub>):</label>
      <input type="number" id="delta-mean" step="0.01">
      <label>BiÃªn khÃ´ng kÃ©m hÆ¡n (Î”):</label>
      <input type="number" id="delta-margin" step="0.01">
      <label>Äá»™ lá»‡ch chuáº©n (Ïƒ):</label>
      <input type="number" id="std-dev" step="0.01">
      ${dropoutHTML}
    `;
    formula.innerHTML = `
      n = 2 Ã— (Z<sub>1âˆ’Î±</sub> + Z<sub>1âˆ’Î²</sub>)<sup>2</sup> Ã— Ïƒ<sup>2</sup> / (Î” âˆ’ Î´)<sup>2</sup>
    `;
    hasReference = true;

  } else if (method === "proportions") {
    form.innerHTML = `
      ${alphaPowerHTML}
      <label>Tá»· lá»‡ nhÃ³m 1 (Pâ‚):</label>
      <input type="number" id="p1" step="0.01" min="0" max="1">
      <label>Tá»· lá»‡ nhÃ³m 2 (Pâ‚‚):</label>
      <input type="number" id="p2" step="0.01" min="0" max="1">
      ${dropoutHTML}
    `;
    formula.innerHTML = `
      n = [(Z<sub>1âˆ’Î±/2</sub>âˆš(2P(1âˆ’P)) + Z<sub>1âˆ’Î²</sub>âˆš(Pâ‚(1âˆ’Pâ‚) + Pâ‚‚(1âˆ’Pâ‚‚))]<sup>2</sup> / (Pâ‚ âˆ’ Pâ‚‚)<sup>2</sup><br>
      P = (Pâ‚ + Pâ‚‚)/2
    `;
    hasReference = true;

  } else if (method === "noninferiority_prop") {
    form.innerHTML = `
      ${alphaPowerHTML}
      <label>Tá»· lá»‡ nhÃ³m chá»©ng (p<sub>C</sub>):</label>
      <input type="number" id="pc" step="0.01" min="0" max="1">
      <label>Tá»· lá»‡ nhÃ³m can thiá»‡p (p<sub>T</sub>):</label>
      <input type="number" id="pt" step="0.01" min="0" max="1">
      <label>BiÃªn khÃ´ng kÃ©m hÆ¡n (Î”):</label>
      <input type="number" id="delta-margin" step="0.01">
      ${dropoutHTML}
    `;
    formula.innerHTML = `
      n = [ (Z<sub>1âˆ’Î±</sub>âˆš(2pÌ„(1âˆ’pÌ„)) + Z<sub>1âˆ’Î²</sub>âˆš(p<sub>C</sub>(1âˆ’p<sub>C</sub>) + p<sub>T</sub>(1âˆ’p<sub>T</sub>)) ]<sup>2</sup> / (p<sub>T</sub> âˆ’ p<sub>C</sub> âˆ’ Î”)<sup>2</sup>
    `;
    hasReference = true;

  } else if (method === "anova") {
    form.innerHTML = `
      ${alphaPowerHTML}
      <label>Sá»‘ nhÃ³m (k):</label>
      <input type="number" id="k" min="2">
      <label>Äá»™ lá»‡ch chuáº©n (Ïƒ):</label>
      <input type="number" id="sigma" step="0.01">
      <label>Hiá»‡u á»©ng mong muá»‘n (f):</label>
      <input type="number" id="effect-f" step="0.01">
      ${dropoutHTML}
    `;
    formula.innerHTML = `
      n = [(Z<sub>1âˆ’Î²</sub> + Z<sub>1âˆ’Î±</sub>)<sup>2</sup> Ã— (k âˆ’ 1)] / (k Ã— f<sup>2</sup>)
    `;
    hasReference = true;

  } else if (method === "chisq") {
    form.innerHTML = `
      ${alphaPowerHTML}
      <label>Sá»‘ nhÃ³m (k):</label>
      <input type="number" id="k-chisq" min="2">
      <label>Tá»· lá»‡ trung bÃ¬nh (P):</label>
      <input type="number" id="p-chisq" step="0.01" min="0" max="1">
      <label>Hiá»‡u á»©ng mong muá»‘n (w):</label>
      <input type="number" id="effect-w" step="0.01">
      ${dropoutHTML}
    `;
    formula.innerHTML = `
      n = (Z<sub>1âˆ’Î²</sub> + Z<sub>1âˆ’Î±</sub>)<sup>2</sup> / w<sup>2</sup><br>
      w: chá»‰ sá»‘ hiá»‡u á»©ng Cohen (0.1 nhá», 0.3 vá»«a, 0.5 lá»›n)
    `;
    hasReference = true;

  } else if (method === "survival") {
    form.innerHTML = `
      ${alphaPowerHTML}
      <label>Tá»· lá»‡ sá»‘ng nhÃ³m chá»©ng (Sâ‚€):</label>
      <input type="number" id="s0" step="0.01" min="0" max="1">
      <label>Tá»· lá»‡ sá»‘ng nhÃ³m can thiá»‡p (Sâ‚):</label>
      <input type="number" id="s1" step="0.01" min="0" max="1">
      <label>Thá»i gian theo dÃµi (t):</label>
      <input type="number" id="t" step="0.1" min="0">
      ${dropoutHTML}
    `;
    formula.innerHTML = `
      n = [ (Z<sub>1âˆ’Î±/2</sub> + Z<sub>1âˆ’Î²</sub>)<sup>2</sup> Ã— (1/Sâ‚€ + 1/Sâ‚) ] / (log(Sâ‚) âˆ’ log(Sâ‚€))<sup>2</sup>
    `;
    hasReference = true;

  } else if (method === "ancova") {
    form.innerHTML = `
      ${alphaPowerHTML}
      <label>Hiá»‡u sá»‘ trung bÃ¬nh (Î”):</label>
      <input type="number" id="delta-mean" step="0.01">
      <label>Äá»™ lá»‡ch chuáº©n (Ïƒ):</label>
      <input type="number" id="std-dev" step="0.01">
      <label>Há»‡ sá»‘ R<sup>2</sup>:</label>
      <input type="number" id="rsquared" step="0.01" min="0" max="1">
      ${dropoutHTML}
    `;
    formula.innerHTML = `
      n = 2 Ã— (Z<sub>1âˆ’Î±</sub> + Z<sub>1âˆ’Î²</sub>)<sup>2</sup> Ã— Ïƒ<sup>2</sup> Ã— (1 âˆ’ R<sup>2</sup>) / Î”<sup>2</sup>
    `;
    hasReference = true;
 
 } else if (method === "crossover_means") {
    form.innerHTML = `
      ${alphaPowerHTML}
      <label>Äá»™ lá»‡ch chuáº©n cá»§a hiá»‡u sá»‘ (Ïƒ<sub>d</sub>):</label>
      <input type="number" id="sigma_d" step="0.01">
      <label>Hiá»‡u sá»‘ mong muá»‘n phÃ¡t hiá»‡n (Î”):</label>
      <input type="number" id="delta_crossover" step="0.01">
      ${dropoutHTML}
    `;
    formula.innerHTML = `
      n = [(Z<sub>1âˆ’Î±/2</sub> + Z<sub>1âˆ’Î²</sub>) Ã— Ïƒ<sub>d</sub> / Î”]<sup>2</sup><br>
      (n lÃ  sá»‘ ngÆ°á»i tham gia cáº§n thiáº¿t)
    `;
    hasReference = true;

  } else if (method === "crossover_props") {
    form.innerHTML = `
      ${alphaPowerHTML}
      <label>P<sub>10</sub> (xáº£y ra á»Ÿ A, khÃ´ng á»Ÿ B):</label>
      <input type="number" id="p10" step="0.01" min="0" max="1">
      <label>P<sub>01</sub> (xáº£y ra á»Ÿ B, khÃ´ng á»Ÿ A):</label>
      <input type="number" id="p01" step="0.01" min="0" max="1">
      ${dropoutHTML}
    `;
    formula.innerHTML = `
      n = [(Z<sub>1âˆ’Î±/2</sub> + Z<sub>1âˆ’Î²</sub>)<sup>2</sup> Ã— (P<sub>10</sub>(1 âˆ’ P<sub>10</sub>) + P<sub>01</sub>(1 âˆ’ P<sub>01</sub>))] / (P<sub>10</sub> âˆ’ P<sub>01</sub>)<sup>2</sup>
    `;
    hasReference = true;
}
  if (hasReference) {
    reference.innerHTML = `Nguá»“n: Chow SC, Shao J, Wang H. <i>Sample Size Calculations in Clinical Research</i>. 3rd ed. CRC Press, 2018.`;
  }
}

function calculateSampleSize() {
  const method = document.getElementById("sample-size-method").value;
  const alpha = parseFloat(document.getElementById("alpha")?.value || "0.05");
  const power = parseFloat(document.getElementById("power")?.value || "0.8");
  const zAlpha = alpha === 0.01 ? 2.58 : 1.96;
  const zBeta = power === 0.9 ? 1.28 : 0.84;
  let n = 0;
  let resultText = "";

  if (method === "means") {
    const sigma = parseFloat(document.getElementById("sigma").value);
    const delta = parseFloat(document.getElementById("delta").value);
    n = 2 * Math.pow((zAlpha + zBeta) * sigma / delta, 2);
    resultText = `Cá»¡ máº«u má»—i nhÃ³m â‰ˆ <b>${Math.ceil(n)}</b>`;

  } else if (method === "proportions") {
    const p1 = parseFloat(document.getElementById("p1").value);
    const p2 = parseFloat(document.getElementById("p2").value);
    const p = (p1 + p2) / 2;
    const term1 = zAlpha * Math.sqrt(2 * p * (1 - p));
    const term2 = zBeta * Math.sqrt(p1 * (1 - p1) + p2 * (1 - p2));
    n = Math.pow(term1 + term2, 2) / Math.pow(p1 - p2, 2);
    resultText = `Cá»¡ máº«u má»—i nhÃ³m â‰ˆ <b>${Math.ceil(n)}</b>`;

  } else if (method === "anova") {
    const k = parseInt(document.getElementById("k").value);
    const f = parseFloat(document.getElementById("effect-f").value);
    n = ((zAlpha + zBeta) ** 2 * (k - 1)) / (k * f * f);
    resultText = `Cá»¡ máº«u má»—i nhÃ³m â‰ˆ <b>${Math.ceil(n)}</b>`;

  } else if (method === "chisq") {
    const w = parseFloat(document.getElementById("effect-w").value);
    n = Math.pow(zAlpha + zBeta, 2) / Math.pow(w, 2);
    resultText = `Tá»•ng cá»¡ máº«u cáº§n thiáº¿t â‰ˆ <b>${Math.ceil(n)}</b>`;

  } else if (method === "noninferiority_means") {
    const deltaObs = parseFloat(document.getElementById("delta-mean").value);
    const deltaMargin = parseFloat(document.getElementById("delta-margin").value);
    const std = parseFloat(document.getElementById("std-dev").value);
    const diff = deltaMargin - deltaObs;
    n = 2 * Math.pow((zAlpha + zBeta) * std / diff, 2);
    resultText = `Cá»¡ máº«u má»—i nhÃ³m â‰ˆ <b>${Math.ceil(n)}</b>`;

  } else if (method === "noninferiority_prop") {
    const pt = parseFloat(document.getElementById("pt").value);
    const pc = parseFloat(document.getElementById("pc").value);
    const delta = parseFloat(document.getElementById("delta-margin").value);
    const pbar = (pt + pc) / 2;
    const term1 = zAlpha * Math.sqrt(2 * pbar * (1 - pbar));
    const term2 = zBeta * Math.sqrt(pc * (1 - pc) + pt * (1 - pt));
    const diff = pt - pc - delta;
    n = Math.pow(term1 + term2, 2) / Math.pow(diff, 2);
    resultText = `Cá»¡ máº«u má»—i nhÃ³m â‰ˆ <b>${Math.ceil(n)}</b>`;

  } else if (method === "ancova") {
    const delta = parseFloat(document.getElementById("delta-mean").value);
    const sigma = parseFloat(document.getElementById("std-dev").value);
    const rsq = parseFloat(document.getElementById("rsquared").value);
    n = 2 * Math.pow(zAlpha + zBeta, 2) * sigma * sigma * (1 - rsq) / (delta * delta);
    resultText = `Cá»¡ máº«u má»—i nhÃ³m â‰ˆ <b>${Math.ceil(n)}</b>`;

  } else if (method === "survival") {
    const s0 = parseFloat(document.getElementById("s0").value);
    const s1 = parseFloat(document.getElementById("s1").value);
    const t = parseFloat(document.getElementById("t").value);
    const logDiff = Math.log(s1) - Math.log(s0);
    const term = (1 / s0 + 1 / s1);
    n = Math.pow(zAlpha + zBeta, 2) * term / Math.pow(logDiff, 2);
    resultText = `Tá»•ng cá»¡ máº«u cáº§n thiáº¿t â‰ˆ <b>${Math.ceil(n)}</b>`;

  } else if (method === "crossover_means") {
    const alpha = parseFloat(document.getElementById("alpha").value);
    const power = parseFloat(document.getElementById("power").value);
    const zAlpha = getZ(alpha / 2);
    const zBeta = getZ(1 - power);
    const sigma_d = parseFloat(document.getElementById("sigma_d").value);
    const delta = parseFloat(document.getElementById("delta_crossover").value);

    n = Math.pow((zAlpha + zBeta) * sigma_d / delta, 2);
    n = Math.ceil(n);

    resultText = `ğŸ“Š Thiáº¿t káº¿ báº¯t chÃ©o â€“ So sÃ¡nh trung bÃ¬nh:<br>
    Cá»¡ máº«u má»—i nhÃ¡nh cáº§n: <b>${n}</b> ngÆ°á»i`;

  } else if (method === "crossover_props") {
    const alpha = parseFloat(document.getElementById("alpha").value);
    const power = parseFloat(document.getElementById("power").value);
    const zAlpha = getZ(alpha / 2);
    const zBeta = getZ(1 - power);
    const p10 = parseFloat(document.getElementById("p10").value);
    const p01 = parseFloat(document.getElementById("p01").value);

    const numerator = Math.pow(zAlpha + zBeta, 2) * (p10 * (1 - p10) + p01 * (1 - p01));
    const denominator = Math.pow(p10 - p01, 2);

    n = numerator / denominator;
    n = Math.ceil(n);

    resultText = `ğŸ“‰ Thiáº¿t káº¿ báº¯t chÃ©o â€“ So sÃ¡nh tá»· lá»‡:<br>
    Cá»¡ máº«u má»—i nhÃ¡nh cáº§n: <b>${n}</b> ngÆ°á»i`;
  } else {
    resultText = "ğŸ”§ ChÆ°a há»— trá»£ tÃ­nh cho loáº¡i cÃ´ng thá»©c nÃ y.";
  }

  // Hiá»ƒn thá»‹ káº¿t quáº£ gá»‘c
  const resultDiv = document.getElementById("sample-size-result");
  resultDiv.innerHTML = resultText;

  // TÃ­nh hiá»‡u chá»‰nh náº¿u cÃ³ dropout
  const dropoutRate = parseFloat(document.getElementById("dropout-rate")?.value || "0");
  const adjustedDiv = document.getElementById("sample-size-adjusted");
  if (!isNaN(n) && dropoutRate > 0 && dropoutRate < 100) {
    const nAdj = Math.ceil(n / (1 - dropoutRate / 100));
    adjustedDiv.innerHTML = `ğŸ¯ Cá»¡ máº«u hiá»‡u chá»‰nh sau khi tÃ­nh máº¥t máº«u ${dropoutRate}%: <b>${nAdj}</b>`;
    window.calculatedSampleSize = nAdj;
  } else {
    adjustedDiv.innerHTML = "";
    window.calculatedSampleSize = "";
 }
 saveData();
}

function checkDropoutWarning() {
  const val = parseFloat(document.getElementById("dropout-rate")?.value || 0);
  const warning = document.getElementById("dropout-warning");
  if (val > 10) {
    warning.textContent = "âš ï¸ KhÃ´ng nÃªn máº¥t máº«u quÃ¡ 10% vÃ¬ cÃ³ thá»ƒ áº£nh hÆ°á»Ÿng Ä‘áº¿n Ä‘á»™ tin cáº­y cá»§a káº¿t quáº£.";
  } else {
    warning.textContent = "";
  }
}

async function generateSampleSizeSuggestion() {
  const output = document.getElementById("suggest-sample-size");
  const fileInput = document.getElementById("file-sample-size");
  const file = fileInput.files[0];
  const method = document.getElementById("sample-size-method").value.trim();
  let fileText = "";

  if (file && file.type === "application/pdf") {
    output.textContent = "ğŸ“„ Äang Ä‘á»c file PDF...";
    fileText = await extractTextFromPDF(file);
  }

  const p = document.getElementById("pico-p").value.trim();
  const i = document.getElementById("pico-i").value.trim();
  const c = document.getElementById("pico-c").value.trim();
  const o = document.getElementById("pico-o").value.trim();
  const question = document.getElementById("question").value.trim();
  const mainObjective = document.getElementById("main-objective").value.trim();
  const subObjectives = Array.from(document.querySelectorAll(".sub-objective")).map(el => el.value.trim()).join("; ");

  const prompt = `Dá»±a vÃ o cÃ¡c thÃ´ng tin sau, hÃ£y Ä‘á» xuáº¥t cÃ¡ch tÃ­nh cá»¡ máº«u phÃ¹ há»£p (nÃªu rÃµ giáº£ Ä‘á»‹nh, cÃ´ng thá»©c, thÃ´ng sá»‘ cáº§n thiáº¿t). Náº¿u cÃ³ táº£i tÃ i liá»‡u lÃªn thÃ¬ Æ°u tiÃªn sá»­ dá»¥ng sá»‘ liá»‡u cáº§n thiáº¿t cho tÃ­nh cá»¡ máº«u tá»« trong tÃ i liá»‡u, vÃ  pháº£i bÃ¡o cÃ¡o vÃ o cuá»‘i cÃ¹ng lÃ  sá»­ dá»¥ng tÃ i liá»‡u nÃ o Ä‘á»“ng thá»i pháº£i cho danh má»¥c tÃ i liá»‡u Ä‘Ã£ tham kháº£o theo AMA 11:

- P: ${p}
- I: ${i}
- C: ${c}
- O: ${o}
- CÃ¢u há»i nghiÃªn cá»©u: ${question}
- Má»¥c tiÃªu chÃ­nh: ${mainObjective}
- Má»¥c tiÃªu phá»¥: ${subObjectives}
- PhÆ°Æ¡ng phÃ¡p Ä‘á»‹nh trÆ°á»›c (náº¿u cÃ³): ${method}
${fileText ? "\nTÃ i liá»‡u PDF ngÆ°á»i dÃ¹ng cung cáº¥p:\n" + fileText : ""}`;

  output.textContent = "â³ Äang sinh gá»£i Ã½ tá»« GPT...";

  try {
  const response = await fetch("https://gpt-api-19xu.onrender.com/gpt.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ prompt })
  });

  const text = await response.text();

  try {
    const data = JSON.parse(text);
    const result = data.choices?.[0]?.message?.content || "GPT khÃ´ng tráº£ vá» pháº£n há»“i.";
    output.textContent = result;
  } catch (e) {
    output.textContent = "âŒ Lá»—i xá»­ lÃ½ JSON: " + text;
  }

} catch (error) {
  output.textContent = "âŒ Lá»—i khi gá»i GPT API: " + error.message;
}

async function evaluateSampleSize() {
  const output = document.getElementById("eval-sample-size");
  const method = document.getElementById("sample-size-method").value.trim();
  const alpha = document.getElementById("alpha")?.value || "";
  const power = document.getElementById("power")?.value || "";
  const dropout = document.getElementById("dropout-rate")?.value || "";

  const p = document.getElementById("pico-p").value.trim();
  const i = document.getElementById("pico-i").value.trim();
  const c = document.getElementById("pico-c").value.trim();
  const o = document.getElementById("pico-o").value.trim();
  const mainObjective = document.getElementById("main-objective").value.trim();

  let methodParams = "";

  // Thu tháº­p cÃ¡c biáº¿n Ä‘áº§u vÃ o tuá»³ loáº¡i phÆ°Æ¡ng phÃ¡p
  switch (method) {
    case "means":
      methodParams = `
      - Äá»™ lá»‡ch chuáº©n (Ïƒ): ${document.getElementById("sigma").value}
      - Hiá»‡u sá»‘ ká»³ vá»ng (Î”): ${document.getElementById("delta").value}`;
      break;

    case "proportions":
      methodParams = `
      - Tá»· lá»‡ nhÃ³m 1 (P1): ${document.getElementById("p1").value}
      - Tá»· lá»‡ nhÃ³m 2 (P2): ${document.getElementById("p2").value}`;
      break;

    case "anova":
      methodParams = `
      - Sá»‘ nhÃ³m: ${document.getElementById("k").value}
      - Äá»™ lá»‡ch chuáº©n (Ïƒ): ${document.getElementById("sigma").value}
      - Hiá»‡u á»©ng f: ${document.getElementById("effect-f").value}`;
      break;

    case "chisq":
      methodParams = `
      - Sá»‘ nhÃ³m (k): ${document.getElementById("k-chisq").value}
      - Tá»· lá»‡ trung bÃ¬nh (P): ${document.getElementById("p-chisq").value}
      - Chá»‰ sá»‘ hiá»‡u á»©ng w: ${document.getElementById("effect-w").value}`;
      break;

    case "noninferiority_means":
      methodParams = `
      - Hiá»‡u sá»‘ quan sÃ¡t (Î¼T âˆ’ Î¼C): ${document.getElementById("delta-mean").value}
      - BiÃªn khÃ´ng kÃ©m hÆ¡n (Î”): ${document.getElementById("delta-margin").value}
      - Äá»™ lá»‡ch chuáº©n (Ïƒ): ${document.getElementById("std-dev").value}`;
      break;

    case "noninferiority_prop":
      methodParams = `
      - Tá»· lá»‡ nhÃ³m chá»©ng (pC): ${document.getElementById("pc").value}
      - Tá»· lá»‡ nhÃ³m can thiá»‡p (pT): ${document.getElementById("pt").value}
      - BiÃªn khÃ´ng kÃ©m hÆ¡n (Î”): ${document.getElementById("delta-margin").value}`;
      break;

    case "ancova":
      methodParams = `
      - Hiá»‡u sá»‘ trung bÃ¬nh (Î”): ${document.getElementById("delta-mean").value}
      - Äá»™ lá»‡ch chuáº©n (Ïƒ): ${document.getElementById("std-dev").value}
      - R bÃ¬nh phÆ°Æ¡ng: ${document.getElementById("rsquared").value}`;
      break;
  }

  const prompt = `
NgÆ°á»i dÃ¹ng Ä‘ang thiáº¿t káº¿ nghiÃªn cá»©u vá»›i thÃ´ng tin nhÆ° sau:
- P (Population): ${p}
- I (Intervention): ${i}
- C (Comparison): ${c}
- O (Outcome): ${o}
- Má»¥c tiÃªu chÃ­nh: ${mainObjective}

CÃ´ng thá»©c tÃ­nh cá»¡ máº«u Ä‘Æ°á»£c chá»n: ${method}
ThÃ´ng sá»‘ Ä‘áº§u vÃ o:
- Alpha: ${alpha}
- Power: ${power}
- Drop-out rate dá»± kiáº¿n: ${dropout}%
${methodParams}

YÃªu cáº§u:
1. ÄÃ¡nh giÃ¡ xem cÃ´ng thá»©c chá»n cÃ³ phÃ¹ há»£p vá»›i káº¿t cá»¥c chÃ­nh (O), má»¥c tiÃªu vÃ  loáº¡i thiáº¿t káº¿ hay khÃ´ng.
2. PhÃ¢n tÃ­ch tá»«ng thÃ´ng sá»‘ Ä‘áº§u vÃ o Ä‘Ã£ há»£p lÃ½ chÆ°a (Ïƒ, Î”, p1/p2, RÂ²...), cÃ³ phÃ¹ há»£p vá»›i giÃ¡ trá»‹ thÆ°á»ng gáº·p vÃ  cÃ³ dá»±a trÃªn báº±ng chá»©ng hay MCID khÃ´ng?
3. Drop-out rate nhÆ° trÃªn cÃ³ áº£nh hÆ°á»Ÿng nghiÃªm trá»ng khÃ´ng?
4. Náº¿u cÃ³ sai lá»‡ch hoáº·c Ä‘iá»ƒm cáº§n cáº£i thiá»‡n, hÃ£y chá»‰ rÃµ vÃ  Ä‘á» xuáº¥t Ä‘iá»u chá»‰nh.`.trim();

  output.textContent = "â³ GPT Ä‘ang phÃ¢n tÃ­ch...";

try {
  const response = await fetch("https://gpt-api-19xu.onrender.com/gpt.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ prompt })
  });

  const text = await response.text();

  try {
    const data = JSON.parse(text);
    const result = data.choices?.[0]?.message?.content || "GPT khÃ´ng tráº£ vá» pháº£n há»“i.";
    output.textContent = result;
  } catch (e) {
    output.textContent = "âŒ Lá»—i xá»­ lÃ½ JSON: " + text;
  }

} catch (error) {
  output.textContent = "âŒ Lá»—i khi gá»i GPT API: " + error.message;
}

//BÆ°á»›c 8

function addInclusionCriterion(text = "") {
  const div = document.createElement("div");
  div.innerHTML = `
    <input type="text" class="inclusion-item" value="${text}" placeholder="Nháº­p tiÃªu chÃ­ chá»n..." oninput="saveData()">
    <button onclick="this.parentElement.remove(); saveData()">ğŸ—‘</button>
  `;
  document.getElementById("inclusion-criteria").appendChild(div);
}

function addExclusionCriterion(text = "") {
  const div = document.createElement("div");
  div.innerHTML = `
    <input type="text" class="exclusion-item" value="${text}" placeholder="Nháº­p tiÃªu chÃ­ loáº¡i..." oninput="saveData()">
    <button onclick="this.parentElement.remove(); saveData()">ğŸ—‘</button>
  `;
  document.getElementById("exclusion-criteria").appendChild(div);
}

async function generateCriteriaFromGPT() {
  const output = document.getElementById("criteria-gpt-suggestion");
  output.innerText = "ğŸ”„ Äang gá»£i Ã½ tá»« GPT...";

  const file = document.getElementById("file-criteria")?.files?.[0];
  let fileText = "";

  // Äá»c file PDF náº¿u cÃ³
  if (file && file.type === "application/pdf") {
    try {
      fileText = await extractTextFromPDF(file);
    } catch (err) {
      console.error("â— Lá»—i Ä‘á»c PDF:", err);
    }
  }

  // TrÃ­ch xuáº¥t thÃ´ng tin tá»« form
  const pico = {
    p: document.getElementById("pico-p")?.value || "",
    i: document.getElementById("pico-i")?.value || "",
    c: document.getElementById("pico-c")?.value || "",
    o: document.getElementById("pico-o")?.value || ""
  };

  const mainObjective = document.getElementById("main-objective")?.value || "";
  const subObjectives = Array.from(document.querySelectorAll(".sub-objective")).map(el => el.value).filter(v => v).join("; ");

  const interventions = Array.from(document.querySelectorAll(".arm-description")).map((el, i) => `NhÃ³m ${i + 1}: ${el.value}`).join("\n");

  const context = `
PICO:
- P (DÃ¢n sá»‘): ${pico.p}
- I (Can thiá»‡p): ${pico.i}
- C (So sÃ¡nh): ${pico.c}
- O (Káº¿t cá»¥c): ${pico.o}

Má»¥c tiÃªu chÃ­nh: ${mainObjective}
Má»¥c tiÃªu phá»¥: ${subObjectives}

MÃ´ táº£ can thiá»‡p:
${interventions}
  `.trim();

  // Táº¡o prompt gá»­i GPT
  const prompt = `${fileText ? "TÃ i liá»‡u PDF:\n" + fileText + "\n\n" : ""}
ThÃ´ng tin tá»« cÃ¡c bÆ°á»›c trÆ°á»›c:
${context}

HÃ£y Ä‘á» xuáº¥t cÃ¡c tiÃªu chÃ­ **chá»n** vÃ  **loáº¡i** phÃ¹ há»£p cho má»™t nghiÃªn cá»©u RCT. TrÃ¬nh bÃ y rÃµ rÃ ng, phÃ¢n biá»‡t rÃµ hai nhÃ³m tiÃªu chÃ­. Cáº§n nÃªu rÃµ lÃ½ do táº¡i sao cÃ³ tiÃªu chÃ­ Ä‘Ã³. CÃ¢n nháº¯c Ä‘áº¿n tÃ­nh phÃ¹ há»£p vá»›i bá»‡nh/tÃ¬nh tráº¡ng trong nghiÃªn cá»©u, cÃ¡c tiÃªu chuáº©n thÆ°á»ng Ä‘Æ°á»£c sá»­ dá»¥ng trong cÃ¡c nghiÃªn cá»©u cÃ¹ng loáº¡i, sá»± phÃ¹ há»£p vá»›i má»¥c tiÃªu nghiÃªn cá»©u. Náº¿u cÃ³ táº£i tÃ i liá»‡u lÃªn thÃ¬ khi sá»­ dá»¥ng thÃ´ng tin trong tÃ i liá»‡u nÃ o pháº£i Ä‘Ã¡nh sá»‘ trÃ­ch dáº«n vÃ  cuá»‘i cÃ¹ng pháº£i cho danh má»¥c tÃ i liá»‡u Ä‘Ã£ tham kháº£o theo AMA 11`;

try {
  const response = await fetch("https://gpt-api-19xu.onrender.com/gpt.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ prompt })
  });

  const text = await response.text();

  try {
    const data = JSON.parse(text);
    const result = data.choices?.[0]?.message?.content || "GPT khÃ´ng tráº£ vá» pháº£n há»“i.";
    output.textContent = result;
  } catch (e) {
    output.textContent = "âŒ Lá»—i xá»­ lÃ½ JSON: " + text;
  }

} catch (error) {
  output.textContent = "âŒ Lá»—i khi gá»i GPT API: " + error.message;
}

async function evaluateCriteria() {
  const output = document.getElementById("criteria-gpt-evaluation");
  output.innerText = "ğŸ” Äang Ä‘Ã¡nh giÃ¡...";

  const inclusion = [...document.querySelectorAll("#inclusion-criteria input")]
    .map(e => e.value.trim()).filter(Boolean);
  const exclusion = [...document.querySelectorAll("#exclusion-criteria input")]
    .map(e => e.value.trim()).filter(Boolean);

  const criteriaText = `TiÃªu chÃ­ chá»n:\n${inclusion.join("\n")}\n\nTiÃªu chÃ­ loáº¡i:\n${exclusion.join("\n")}`;

  const prompt = `HÃ£y Ä‘Ã¡nh giÃ¡ cÃ¡c tiÃªu chÃ­ chá»n vÃ  loáº¡i sau cho nghiÃªn cá»©u RCT. 
Xem xÃ©t tÃ­nh phÃ¹ há»£p, cá»¥ thá»ƒ, khoa há»c vÃ  cÃ³ loáº¡i trá»« Ä‘á»§ cÃ¡c yáº¿u tá»‘ gÃ¢y nhiá»…u khÃ´ng. ThÃªm pháº§n giáº£i thÃ­ch lÃ½ do sá»± phÃ¹ há»£p cá»§a tá»«ng tiÃªu chÃ­ vá»›i nghiÃªn cá»©u nÃ y:

${criteriaText}`;

try {
  const response = await fetch("https://gpt-api-19xu.onrender.com/gpt.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ prompt })
  });

  const text = await response.text();

  try {
    const data = JSON.parse(text);
    const result = data.choices?.[0]?.message?.content || "GPT khÃ´ng tráº£ vá» pháº£n há»“i.";
    output.textContent = result;
  } catch (e) {
    output.textContent = "âŒ Lá»—i xá»­ lÃ½ JSON: " + text;
  }

} catch (error) {
  output.textContent = "âŒ Lá»—i khi gá»i GPT API: " + error.message;
}

//BÆ°á»›c 9

function renderRandomOptions() {
  const method = document.getElementById("random-method").value;
  const container = document.getElementById("random-options");
  container.innerHTML = "";

  if (method === "block") {
    container.innerHTML = `
      <label>KÃ­ch thÆ°á»›c block:</label>
      <input type="number" id="block-size" min="2" step="2" oninput="saveData()">
    `;
  } else if (method === "stratified") {
    container.innerHTML = `
      <label>Biáº¿n phÃ¢n táº§ng (vÃ­ dá»¥: tuá»•i, giá»›i):</label>
      <input type="text" id="strata-variables" placeholder="Nháº­p tÃªn biáº¿n phÃ¢n táº§ng, cÃ¡ch nhau báº±ng dáº¥u pháº©y" oninput="saveData()">
    `;
  } else if (method === "adaptive") {
    container.innerHTML = `
      <label>Thuáº­t toÃ¡n thÃ­ch á»©ng:</label>
      <select id="adaptive-type" onchange="saveData()">
        <option value="minimization">Minimization</option>
        <option value="covariate">Covariate-Adaptive</option>
      </select>
    `;
  }
}

function loadRandomizationInfo() {
  // Láº¥y sá»‘ nhÃ¡nh can thiá»‡p tá»« bÆ°á»›c 6 (thiáº¿t káº¿ nghiÃªn cá»©u)
  const n = localStorage.getItem("num-arms");
  if (n) {
    document.getElementById("num-arms-step9").value = n;
  }
}

function generateAutoRandomization() {
  const method = document.getElementById("random-method").value;
  const arms = document.getElementById("num-arms-step9").value;
  let description = "";

  if (!method || !arms) return;

  switch (method) {
    case "simple":
      description = `PhÆ°Æ¡ng phÃ¡p ngáº«u nhiÃªn Ä‘Æ¡n giáº£n Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ phÃ¢n bá»• ngÆ°á»i tham gia vÃ o ${arms} nhÃ³m vá»›i xÃ¡c suáº¥t báº±ng nhau. Danh sÃ¡ch ngáº«u nhiÃªn Ä‘Æ°á»£c táº¡o ra báº±ng mÃ¡y tÃ­nh thÃ´ng qua pháº§n má»m thá»‘ng kÃª (vÃ­ dá»¥: R, Stata hoáº·c random.org) báº±ng cÃ¡ch sinh chuá»—i sá»‘ ngáº«u nhiÃªn khÃ´ng láº·p. Má»—i ngÆ°á»i tham gia sau khi Ä‘á»§ tiÃªu chuáº©n sáº½ Ä‘Æ°á»£c gÃ¡n vÃ o má»™t nhÃ³m dá»±a trÃªn thá»© tá»± xuáº¥t hiá»‡n trong danh sÃ¡ch ngáº«u nhiÃªn nÃ y. TrÃ¬nh tá»± phÃ¢n bá»• Ä‘Æ°á»£c giá»¯ kÃ­n báº±ng phong bÃ¬ opaque, Ä‘Ã¡nh sá»‘ thá»© tá»±, niÃªm phong, chá»‰ Ä‘Æ°á»£c má»Ÿ khi ngÆ°á»i tham gia Ä‘Æ°á»£c Ä‘Æ°a vÃ o nghiÃªn cá»©u Ä‘á»ƒ Ä‘áº£m báº£o tÃ­nh che giáº¥u phÃ¢n nhÃ³m.`;
      break;
    case "block":
      description = `PhÃ¢n bá»• ngáº«u nhiÃªn theo khá»‘i Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ Ä‘áº£m báº£o sá»‘ lÆ°á»£ng ngÆ°á»i tham gia Ä‘Æ°á»£c phÃ¢n bá»‘ Ä‘á»u giá»¯a ${arms} nhÃ³m trong suá»‘t quÃ¡ trÃ¬nh thu nháº­n. CÃ¡c khá»‘i cÃ³ kÃ­ch thÆ°á»›c cá»‘ Ä‘á»‹nh (vÃ­ dá»¥: 4, 6 hoáº·c 8) Ä‘Æ°á»£c táº¡o ra ngáº«u nhiÃªn báº±ng pháº§n má»m thá»‘ng kÃª. TrÃ¬nh tá»± phÃ¢n bá»• trong má»—i khá»‘i Ä‘Æ°á»£c hoÃ¡n vá»‹ ngáº«u nhiÃªn Ä‘á»ƒ trÃ¡nh dá»± Ä‘oÃ¡n. Danh sÃ¡ch toÃ n bá»™ chuá»—i phÃ¢n bá»• theo khá»‘i Ä‘Æ°á»£c táº¡o trÆ°á»›c vÃ  lÆ°u giá»¯ bá»Ÿi má»™t ngÆ°á»i thá»© ba khÃ´ng tham gia vÃ o viá»‡c thu nháº­n. TrÃ¬nh tá»± Ä‘Æ°á»£c che giáº¥u báº±ng há»‡ thá»‘ng mÃ£ hÃ³a hoáº·c phong bÃ¬ mÃ¹, Ä‘áº£m báº£o ngÆ°á»i nghiÃªn cá»©u khÃ´ng biáº¿t trÆ°á»›c nhÃ³m phÃ¢n bá»•.`;
      break;
    case "stratified":
      description = `PhÆ°Æ¡ng phÃ¡p ngáº«u nhiÃªn phÃ¢n táº§ng Ä‘Æ°á»£c Ã¡p dá»¥ng nháº±m Ä‘áº£m báº£o cÃ¢n báº±ng cÃ¡c yáº¿u tá»‘ ná»n quan trá»ng (vÃ­ dá»¥: giá»›i tÃ­nh, Ä‘á»™ tuá»•i, má»©c Ä‘á»™ bá»‡nh) giá»¯a ${arms} nhÃ³m. CÃ¡c táº§ng phÃ¢n loáº¡i Ä‘Æ°á»£c xÃ¡c Ä‘á»‹nh trÆ°á»›c khi tiáº¿n hÃ nh phÃ¢n bá»•. Trong má»—i táº§ng, ngÆ°á»i tham gia sáº½ Ä‘Æ°á»£c phÃ¢n bá»‘ vÃ o cÃ¡c nhÃ³m thÃ´ng qua phÆ°Æ¡ng phÃ¡p ngáº«u nhiÃªn theo khá»‘i hoáº·c ngáº«u nhiÃªn Ä‘Æ¡n giáº£n, sá»­ dá»¥ng pháº§n má»m chuyÃªn dá»¥ng. Danh sÃ¡ch ngáº«u nhiÃªn Ä‘Æ°á»£c táº¡o riÃªng cho tá»«ng táº§ng vÃ  lÆ°u giá»¯ bá»Ÿi ngÆ°á»i khÃ´ng tham gia thu nháº­n Ä‘á»ƒ Ä‘áº£m báº£o che giáº¥u phÃ¢n nhÃ³m.`;
      break;
    case "minimization":
      description = `PhÆ°Æ¡ng phÃ¡p ngáº«u nhiÃªn hÃ³a tá»‘i thiá»ƒu (minimization) Ä‘Æ°á»£c Ã¡p dá»¥ng Ä‘á»ƒ tá»‘i Æ°u hÃ³a sá»± cÃ¢n báº±ng giá»¯a cÃ¡c nhÃ³m nghiÃªn cá»©u dá»±a trÃªn cÃ¡c yáº¿u tá»‘ ná»n (nhÆ° giá»›i tÃ­nh, Ä‘á»™ tuá»•i, má»©c Ä‘á»™ bá»‡nh). Táº¡i thá»i Ä‘iá»ƒm phÃ¢n bá»• má»—i ngÆ°á»i tham gia, pháº§n má»m so sÃ¡nh cÃ¡c Ä‘áº·c Ä‘iá»ƒm cá»§a ngÆ°á»i Ä‘Ã³ vá»›i cÃ¡c nhÃ³m hiá»‡n táº¡i vÃ  gÃ¡n vÃ o nhÃ³m sao cho sá»± máº¥t cÃ¢n Ä‘á»‘i lÃ  nhá» nháº¥t. Má»™t yáº¿u tá»‘ ngáº«u nhiÃªn (vÃ­ dá»¥: xÃ¡c suáº¥t 0,8) Ä‘Æ°á»£c tÃ­ch há»£p Ä‘á»ƒ trÃ¡nh phÃ¢n bá»• hoÃ n toÃ n mang tÃ­nh quyáº¿t Ä‘á»‹nh. TrÃ¬nh tá»± phÃ¢n bá»• Ä‘Æ°á»£c thá»±c hiá»‡n bá»Ÿi há»‡ thá»‘ng Ä‘iá»‡n tá»­ Ä‘á»™c láº­p hoáº·c ngÆ°á»i thá»© ba, Ä‘áº£m báº£o che giáº¥u phÃ¢n nhÃ³m.`;
      break;
  }

  document.getElementById("randomization-method").value = description;
  saveData();
}

async function generateRandomizationSuggestion() {
  const output = document.getElementById("randomization-gpt-suggestion");
  output.innerText = "ğŸ”„ Äang táº¡o gá»£i Ã½ tá»« GPT...";

  const saved = JSON.parse(localStorage.getItem("rctWizardData") || "{}");
  const method = document.getElementById("random-method").value || saved.design?.randomMethod || "ChÆ°a chá»n";
  const numArms = localStorage.getItem("num-arms") || "ChÆ°a rÃµ";

  const design = saved.design || {};
  const designType = design.type || "ChÆ°a khai bÃ¡o";

  let crossoverInfo = "";
  if (designType === "cross-over") {
    const cr = design.crossover || {};
    crossoverInfo = `
Thiáº¿t káº¿ báº¯t chÃ©o:
- Giai Ä‘oáº¡n 1: ${cr.phase1 || "..."} tuáº§n
- Rá»­a trÃ´i: ${cr.washout || "..."} tuáº§n
- NhÃ³m 1: Giai Ä‘oáº¡n 1 = ${cr.g1_phase1 || "A"}, Giai Ä‘oáº¡n 2 = ${cr.g1_phase2 || "B"}
- NhÃ³m 2: Giai Ä‘oáº¡n 1 = ${cr.g2_phase1 || "B"}, Giai Ä‘oáº¡n 2 = ${cr.g2_phase2 || "A"}
`;
  }

  const context = `
P: ${saved.pico?.p || ""}
I: ${saved.pico?.i || ""}
C: ${saved.pico?.c || ""}
O: ${saved.pico?.o || ""}
Má»¥c tiÃªu chÃ­nh: ${saved.mainObjective || ""}
Thiáº¿t káº¿ nghiÃªn cá»©u: ${designType}
${crossoverInfo}
`;

  const file = document.getElementById("file-randomization")?.files?.[0];
  let fileText = "";
  if (file && file.type === "application/pdf") {
    try {
      fileText = await extractTextFromPDF(file);
    } catch (err) {
      console.error("Lá»—i Ä‘á»c file PDF:", err);
    }
  }

  const prompt = `
TÃ´i Ä‘ang xÃ¢y dá»±ng má»™t nghiÃªn cá»©u RCT vá»›i cÃ¡c thÃ´ng tin sau:
${context}
Sá»‘ nhÃ³m can thiá»‡p: ${numArms}
PhÆ°Æ¡ng phÃ¡p phÃ¢n bá»• ngáº«u nhiÃªn Ä‘Ã£ chá»n: ${method}
${fileText ? "TÃ i liá»‡u PDF liÃªn quan:\n" + fileText : ""}

HÃ£y mÃ´ táº£ chi tiáº¿t cÃ¡ch ngáº«u nhiÃªn hÃ³a phÃ¹ há»£p vá»›i thiáº¿t káº¿ nghiÃªn cá»©u nÃ y (Ä‘áº£m báº£o nhÆ° mÃ´ táº£ trong cÃ¡c Ä‘á» cÆ°Æ¡ng nghiÃªn cá»©u RCT chuáº©n má»±c vÃ  lÃ m sao Ä‘á»ƒ mang tÃ­nh tÃ¡i láº­p Ä‘Æ°á»£c), gá»“m:
- TÃªn vÃ  loáº¡i phÆ°Æ¡ng phÃ¡p
- Quy trÃ¬nh thá»±c hiá»‡n chi tiáº¿t, Ä‘Ãºng chuáº©n Ä‘á» cÆ°Æ¡ng nghiÃªn cá»©u RCT
- Äáº£m báº£o áº©n phÃ¢n bá»• (náº¿u cÃ³)
- Pháº§n má»m hoáº·c thuáº­t toÃ¡n nÃªn sá»­ dá»¥ng
- Æ¯u nhÆ°á»£c Ä‘iá»ƒm (náº¿u cÃ³)
`;

try {
  const response = await fetch("https://gpt-api-19xu.onrender.com/gpt.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ prompt })
  });

  const text = await response.text();

  try {
    const data = JSON.parse(text);
    const result = data.choices?.[0]?.message?.content || "GPT khÃ´ng tráº£ vá» pháº£n há»“i.";
    output.textContent = result;
  } catch (e) {
    output.textContent = "âŒ Lá»—i xá»­ lÃ½ JSON: " + text;
  }

} catch (error) {
  output.textContent = "âŒ Lá»—i khi gá»i GPT API: " + error.message;
}

async function evaluateRandomization() {
  const output = document.getElementById("randomization-gpt-evaluation");
  output.innerText = "ğŸ” Äang Ä‘Ã¡nh giÃ¡ tá»« GPT...";

  const method = document.getElementById("random-method")?.value || "ChÆ°a chá»n";
  const numArms = document.getElementById("num-arms-step9")?.value || "ChÆ°a rÃµ";
  const userText = document.getElementById("randomization-method")?.value || "";

  const saved = JSON.parse(localStorage.getItem("rctWizardData") || "{}");
  const designType = saved.design?.type || "ChÆ°a khai bÃ¡o";
  const objective = saved.mainObjective || "";

  let crossoverInfo = "";
  if (designType === "cross-over") {
    const cr = saved.design?.crossover || {};
    crossoverInfo = `
Thiáº¿t káº¿ báº¯t chÃ©o:
- Giai Ä‘oáº¡n 1: ${cr.phase1 || "..."} tuáº§n
- Rá»­a trÃ´i: ${cr.washout || "..."} tuáº§n
- NhÃ³m 1: Giai Ä‘oáº¡n 1 = ${cr.g1_phase1 || "A"}, Giai Ä‘oáº¡n 2 = ${cr.g1_phase2 || "B"}
- NhÃ³m 2: Giai Ä‘oáº¡n 1 = ${cr.g2_phase1 || "B"}, Giai Ä‘oáº¡n 2 = ${cr.g2_phase2 || "A"}
`;
  }

  const prompt = `
Báº¡n lÃ  chuyÃªn gia Ä‘Ã¡nh giÃ¡ thiáº¿t káº¿ nghiÃªn cá»©u RCT.

DÆ°á»›i Ä‘Ã¢y lÃ  thÃ´ng tin nghiÃªn cá»©u:
- Thiáº¿t káº¿: ${designType}
- Má»¥c tiÃªu chÃ­nh: ${objective}
- Sá»‘ nhÃ³m: ${numArms}
- PhÆ°Æ¡ng phÃ¡p ngáº«u nhiÃªn Ä‘Ã£ chá»n: ${method}
${crossoverInfo}

MÃ´ táº£ do ngÆ°á»i dÃ¹ng viáº¿t:
${userText}

HÃ£y Ä‘Ã¡nh giÃ¡ Ä‘oáº¡n mÃ´ táº£ trÃªn cÃ³ Ä‘Ã¡p á»©ng cÃ¡c yÃªu cáº§u khoa há»c cá»§a má»™t nghiÃªn cá»©u RCT khÃ´ng, gá»“m:
- Äá»§ chi tiáº¿t
- ÄÃºng ká»¹ thuáº­t ngáº«u nhiÃªn hÃ³a
- CÃ³ áº©n phÃ¢n bá»• khÃ´ng
- PhÃ¹ há»£p vá»›i thiáº¿t káº¿ nghiÃªn cá»©u
- CÃ³ nguy cÆ¡ sai lá»‡ch hay thiáº¿u sÃ³t nÃ o cáº§n sá»­a
`;

try {
  const response = await fetch("https://gpt-api-19xu.onrender.com/gpt.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ prompt })
  });

  const text = await response.text();

  try {
    const data = JSON.parse(text);
    const result = data.choices?.[0]?.message?.content || "GPT khÃ´ng tráº£ vá» pháº£n há»“i.";
    output.textContent = result;
  } catch (e) {
    output.textContent = "âŒ Lá»—i xá»­ lÃ½ JSON: " + text;
  }

} catch (error) {
  output.textContent = "âŒ Lá»—i khi gá»i GPT API: " + error.message;
}

//BÆ°á»›c 10

function renderInterventionBlocks() {
  const container = document.getElementById("intervention-descriptions");
  container.innerHTML = "";

  const saved = JSON.parse(localStorage.getItem("rctWizardData") || "{}");
  const designType = saved.design?.type || "parallel";

  if (designType === "parallel") {
    const n = parseInt(localStorage.getItem("num-arms") || "0");
    const names = (saved.design?.arms || []).slice(0, n);

    for (let i = 0; i < n; i++) {
      const groupName = names[i] || `NhÃ³m ${i + 1}`;
      const textareaId = `intervention-desc-${i}`;
      const fileId = `file-intervention-${i}`;
      const suggestId = `suggest-intervention-${i}`;
      const evalId = `eval-intervention-${i}`;

      container.innerHTML += `
        <div class="intervention-block" style="border:1px solid #ccc; padding:10px; margin-bottom:20px;">
          <h3>${groupName}</h3>
          <textarea id="${textareaId}" rows="5" placeholder="Nháº­p mÃ´ táº£ can thiá»‡p nhÃ³m nÃ y..." oninput="saveData()"></textarea><br><br>
          <label>Táº£i tÃ i liá»‡u PDF há»— trá»£:</label>
          <input type="file" id="${fileId}" accept=".pdf"><br><br>
          <button onclick="generateGroupIntervention(${i})">ğŸ§  GPT gá»£i Ã½ mÃ´ táº£ nhÃ³m</button>
          <button onclick="evaluateGroupIntervention(${i})">ğŸ§ GPT Ä‘Ã¡nh giÃ¡ mÃ´ táº£</button>
          <div id="${suggestId}" style="margin-top:10px; background:#eef; padding:10px; white-space:pre-wrap; border:1px solid #99c;"></div>
          <div id="${evalId}" style="margin-top:10px; background:#efe; padding:10px; white-space:pre-wrap; border:1px solid #9c9;"></div>
        </div>
      `;
    }
  } else if (designType === "cross-over") {
    const descs = saved.design?.crossover || {};
    const blocks = [
      { label: "Giai Ä‘oáº¡n 1 â€“ NhÃ³m 1", id: "desc-g1-phase1", value: descs.g1_phase1 || "" },
      { label: "Giai Ä‘oáº¡n 1 â€“ NhÃ³m 2", id: "desc-g2-phase1", value: descs.g2_phase1 || "" },
      { label: "Giai Ä‘oáº¡n 2 â€“ NhÃ³m 1", id: "desc-g1-phase2", value: descs.g1_phase2 || "" },
      { label: "Giai Ä‘oáº¡n 2 â€“ NhÃ³m 2", id: "desc-g2-phase2", value: descs.g2_phase2 || "" }
    ];

    blocks.forEach((block, index) => {
      container.innerHTML += `
        <div class="intervention-block" style="border:1px solid #ccc; padding:10px; margin-bottom:20px;">
          <h3>${block.label}</h3>
          <textarea id="${block.id}" rows="5" placeholder="Nháº­p mÃ´ táº£ can thiá»‡p..." oninput="saveData()">${block.value}</textarea><br><br>
          <label>Táº£i tÃ i liá»‡u PDF há»— trá»£:</label>
          <input type="file" id="file-${block.id}" accept=".pdf"><br><br>
          <button onclick="generateCrossoverIntervention('${block.id}')">ğŸ§  GPT gá»£i Ã½ mÃ´ táº£</button>
          <button onclick="evaluateCrossoverIntervention('${block.id}')">ğŸ§ GPT Ä‘Ã¡nh giÃ¡ mÃ´ táº£</button>
          <div id="suggest-${block.id}" style="margin-top:10px; background:#eef; padding:10px; white-space:pre-wrap; border:1px solid #99c;"></div>
          <div id="eval-${block.id}" style="margin-top:10px; background:#efe; padding:10px; white-space:pre-wrap; border:1px solid #9c9;"></div>
        </div>
      `;
    });
  }
}


async function generateGroupIntervention(index) {
  const data = JSON.parse(localStorage.getItem("rctWizardData") || "{}");
  const arms = data.design?.arms || [];
  const pico = data.pico || {};
  const groupName = arms[index] || `NhÃ³m ${index + 1}`;
  const fileInput = document.getElementById(`file-intervention-${index}`);
  const textareaId = `intervention-desc-${index}`;
  const resultDiv = document.getElementById(`suggest-intervention-${index}`);

  resultDiv.innerText = "Äang xá»­ lÃ½ GPT...";

  let fileText = "";
  if (fileInput?.files?.[0]) {
    fileText = await extractTextFromPDF(fileInput.files[0]);
  }

  const prompt = `${fileText ? "Ná»™i dung tá»« tÃ i liá»‡u:\n" + fileText + "\n\n" : ""}HÃ£y viáº¿t mÃ´ táº£ can thiá»‡p cho nhÃ³m: ${groupName}, pháº£i chi tiáº¿t, rÃµ rÃ ng, minh báº¡ch Ä‘Ãºng chuáº©n má»™t RCT cháº¥t lÆ°á»£ng cao, tá»‘i thiá»ƒu pháº£i cÃ³ thá»i gian, táº§n suáº¥t, cÃ¡ch thá»©c... trong nghiÃªn cá»©u cÃ³ thÃ´ng tin PICO nhÆ° sau:\nP: ${pico.p}\nI: ${pico.i}\nC: ${pico.c}\nO: ${pico.o}. Náº¿u can thiá»‡p lÃ  chÃ¢m cá»©u thÃ¬ pháº£i nÃªu rÃµ cÃ´ng thá»©c thuyá»‡t, cÃ¡ch chÃ¢m, thÃ´ng sá»‘ ká»¹ thuáº­t cá»§a kim, vá»‹ trÃ­ tá»«ng huyá»‡t. Náº¿u can thiá»‡p lÃ  dÃ¹ng thuá»‘c thang thÃ¬ pháº£i nÃªu rÃµ bÃ i thuá»‘c gá»“m nhá»¯ng vá»‹ thuá»‘c gÃ¬, liá»u lÆ°á»£ng má»—i vá»‹ bao nhiÃªu, vá»‹ thuá»‘c Ä‘Æ°á»£c cung cáº¥p bá»Ÿi Ä‘Æ¡n vá»‹/cÆ¡ quan nÃ o, tiÃªu chuáº©n dÆ°á»£c liá»‡u Ä‘áº¡t Ä‘Æ°á»£c lÃ  gÃ¬. Äáº£m báº£o Ä‘á»§ thÃ´ng tin can thiá»‡p Ä‘á»ƒ cÃ³ thá»ƒ tÃ¡i láº­p Ä‘Æ°á»£c. Náº¿u cÃ³ táº£i tÃ i liá»‡u lÃªn thÃ¬ khi sá»­ dá»¥ng thÃ´ng tin trong tÃ i liá»‡u nÃ o pháº£i Ä‘Ã¡nh sá»‘ trÃ­ch dáº«n vÃ  cuá»‘i cÃ¹ng pháº£i cho danh má»¥c tÃ i liá»‡u Ä‘Ã£ tham kháº£o theo AMA 11.`;

try {
  const response = await fetch("https://gpt-api-19xu.onrender.com/gpt.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ prompt })
  });

  const text = await response.text();

  try {
    const data = JSON.parse(text);
    const result = data.choices?.[0]?.message?.content || "GPT khÃ´ng tráº£ vá» pháº£n há»“i.";
    output.textContent = result;
  } catch (e) {
    output.textContent = "âŒ Lá»—i xá»­ lÃ½ JSON: " + text;
  }

} catch (error) {
  output.textContent = "âŒ Lá»—i khi gá»i GPT API: " + error.message;
}

async function evaluateGroupIntervention(index) {
  const content = document.getElementById(`intervention-desc-${index}`).value.trim();
  const evalDiv = document.getElementById(`eval-intervention-${index}`);
  if (!content) {
    evalDiv.innerText = "Vui lÃ²ng nháº­p mÃ´ táº£ Ä‘á»ƒ Ä‘Ã¡nh giÃ¡.";
    return;
  }

  const prompt = `ÄÃ¢y lÃ  mÃ´ táº£ can thiá»‡p nhÃ³m ${index + 1}. HÃ£y Ä‘Ã¡nh giÃ¡ cháº¥t lÆ°á»£ng mÃ´ táº£ nÃ y (Ä‘á»§ rÃµ rÃ ng, chi tiáº¿t, minh máº¡ch chÆ°a Ä‘á»ƒ cÃ³ thá»ƒ tÃ¡i láº­p Ä‘Æ°á»£c) trong nghiÃªn cá»©u RCT:\n\n${content}`;

  evalDiv.innerText = "GPT Ä‘ang Ä‘Ã¡nh giÃ¡...";

try {
  const response = await fetch("https://gpt-api-19xu.onrender.com/gpt.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ prompt })
  });

  const text = await response.text();

  try {
    const data = JSON.parse(text);
    const result = data.choices?.[0]?.message?.content || "GPT khÃ´ng tráº£ vá» pháº£n há»“i.";
    output.textContent = result;
  } catch (e) {
    output.textContent = "âŒ Lá»—i xá»­ lÃ½ JSON: " + text;
  }

} catch (error) {
  output.textContent = "âŒ Lá»—i khi gá»i GPT API: " + error.message;
}

async function generateCrossoverIntervention(id) {
  const textarea = document.getElementById(`crossover-desc-${id}`);
  const fileInput = document.getElementById(`file-crossover-${id}`);
  const suggestDiv = document.getElementById(`suggest-crossover-${id}`);

  suggestDiv.innerText = "ğŸ§  Äang sinh mÃ´ táº£ tá»« GPT...";

  let fileText = "";
  if (fileInput?.files?.[0]) {
    const file = fileInput.files[0];
    const reader = new FileReader();
    const fileLoaded = new Promise(resolve => {
      reader.onload = () => resolve(reader.result);
    });
    reader.readAsText(file);
    fileText = await fileLoaded;
  }

  const data = JSON.parse(localStorage.getItem("rctWizardData") || "{}");
  const pico = data.pico || {};

  const prompt = `
Báº¡n Ä‘ang viáº¿t mÃ´ táº£ can thiá»‡p cho má»™t nghiÃªn cá»©u RCT thiáº¿t káº¿ báº¯t chÃ©o.

ğŸ“Œ PICO:
- DÃ¢n sá»‘ (P): ${pico.p || "chÆ°a cÃ³"}
- Can thiá»‡p (I): ${pico.i || "chÆ°a cÃ³"}
- So sÃ¡nh (C): ${pico.c || "chÆ°a cÃ³"}
- Káº¿t cá»¥c (O): ${pico.o || "chÆ°a cÃ³"}

ğŸ“Œ ÄÃ¢y lÃ  mÃ´ táº£ cáº§n cho Ã´ sá»‘ ${id} (${["Giai Ä‘oáº¡n 1 â€“ NhÃ³m 1", "Giai Ä‘oáº¡n 1 â€“ NhÃ³m 2", "Giai Ä‘oáº¡n 2 â€“ NhÃ³m 1", "Giai Ä‘oáº¡n 2 â€“ NhÃ³m 2"][id]})
${fileText ? "ğŸ“„ TÃ i liá»‡u há»— trá»£:\n" + fileText.slice(0, 1000) : "âŒ KhÃ´ng cÃ³ tÃ i liá»‡u há»— trá»£"}

ğŸ‘‰ Viáº¿t mÃ´ táº£ ngáº¯n gá»n, chi tiáº¿t vá» ná»™i dung can thiá»‡p nhÃ³m tÆ°Æ¡ng á»©ng.
`;

try {
  const response = await fetch("https://gpt-api-19xu.onrender.com/gpt.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ prompt })
  });

  const text = await response.text();

  try {
    const data = JSON.parse(text);
    const result = data.choices?.[0]?.message?.content || "GPT khÃ´ng tráº£ vá» pháº£n há»“i.";
    output.textContent = result;
  } catch (e) {
    output.textContent = "âŒ Lá»—i xá»­ lÃ½ JSON: " + text;
  }

} catch (error) {
  output.textContent = "âŒ Lá»—i khi gá»i GPT API: " + error.message;
}

async function evaluateCrossoverIntervention(id) {
  const textarea = document.getElementById(`crossover-desc-${id}`);
  const evalDiv = document.getElementById(`eval-crossover-${id}`);
  const content = textarea.value.trim();

  if (!content) {
    evalDiv.innerText = "âš ï¸ ChÆ°a cÃ³ ná»™i dung Ä‘á»ƒ Ä‘Ã¡nh giÃ¡.";
    return;
  }

  const prompt = `
ÄÃ¢y lÃ  mÃ´ táº£ can thiá»‡p trong nghiÃªn cá»©u RCT báº¯t chÃ©o â€“ Ã´ sá»‘ ${id} (${["Giai Ä‘oáº¡n 1 â€“ NhÃ³m 1", "Giai Ä‘oáº¡n 1 â€“ NhÃ³m 2", "Giai Ä‘oáº¡n 2 â€“ NhÃ³m 1", "Giai Ä‘oáº¡n 2 â€“ NhÃ³m 2"][id]}):

"${content}"

ğŸ‘‰ ÄÃ¡nh giÃ¡ theo cÃ¡c tiÃªu chÃ­:
1. Má»¥c tiÃªu rÃµ rÃ ng khÃ´ng?
2. Quy trÃ¬nh thá»±c hiá»‡n Ä‘á»§ chÆ°a?
3. Táº§n suáº¥t, thá»i lÆ°á»£ng, hÃ¬nh thá»©c can thiá»‡p cÃ³ nÃªu khÃ´ng?
4. CÃ³ gÃ¬ cáº§n bá»• sung?

Viáº¿t pháº£n há»“i theo tá»«ng tiÃªu chÃ­.
`;

  evalDiv.innerText = "ğŸ§ GPT Ä‘ang Ä‘Ã¡nh giÃ¡...";

try {
  const response = await fetch("https://gpt-api-19xu.onrender.com/gpt.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ prompt })
  });

  const text = await response.text();

  try {
    const data = JSON.parse(text);
    const result = data.choices?.[0]?.message?.content || "GPT khÃ´ng tráº£ vá» pháº£n há»“i.";
    output.textContent = result;
  } catch (e) {
    output.textContent = "âŒ Lá»—i xá»­ lÃ½ JSON: " + text;
  }

} catch (error) {
  output.textContent = "âŒ Lá»—i khi gá»i GPT API: " + error.message;
}

//BÆ°á»›c 11

function removeVariable(event, name, role) {
  event.stopPropagation(); // trÃ¡nh gÃ¢y drag
  const list = document.querySelector(`.variable-selected[data-role="${role}"]`);
  const item = [...list.querySelectorAll("li")].find(li => li.dataset.name === name);
  if (item) item.remove();
  selectedVariables[role] = [...list.querySelectorAll("li")].map(li => ({
    name: li.dataset.name,
    role: li.dataset.role,
    type: li.textContent.match(/\(([^)]+)\)/)?.[1] || ""
  }));
}


function addNewVariable() {
  const newVar = {
    name: document.getElementById("new-name").value.trim(),
    role: document.getElementById("new-role").value.trim(),
    type: document.getElementById("new-type").value.trim(),
    unit: document.getElementById("new-unit").value.trim(),
    time: document.getElementById("new-time").value.trim(),
    measure: document.getElementById("new-measure").value.trim(),
    definition: document.getElementById("new-definition").value.trim(),
    source: document.getElementById("new-source").value.trim(),
    format: document.getElementById("new-format").value.trim(),
    range: document.getElementById("new-range").value.trim(),
    mcid_or_cutoff: document.getElementById("new-mcid").value.trim()
  };

  if (!newVar.name || !newVar.role || !newVar.type) {
    alert("Pháº£i cÃ³ Ã­t nháº¥t tÃªn, vai trÃ² vÃ  kiá»ƒu dá»¯ liá»‡u.");
    return;
  }

  allVariables.push(newVar);
  createVariableDragUI();
}

function exportVariables() {
  const csv = Papa.unparse(allVariables);
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.href = url;
  link.download = "updated_variables.csv";
  link.click();
}

async function suggestVariablesForRole(role) {
  const saved = JSON.parse(localStorage.getItem("rctWizardData") || "{}");
  const pico = saved.pico || {};
  const objective = saved.mainObjective || "";
  const interventions = saved.interventions || [];
  const fileInput = document.getElementById(`file-variable-${role}`);
  const output = document.getElementById(`suggest-variable-${role}`);
  output.innerText = "GPT Ä‘ang gá»£i Ã½...";

  let fileText = "";
  if (fileInput?.files?.[0]) {
    fileText = await extractTextFromPDF(fileInput.files[0]);
  }

  const prompt = `
ThÃ´ng tin nghiÃªn cá»©u RCT:
- P: ${pico.p || ""}
- I: ${pico.i || ""}
- C: ${pico.c || ""}
- O: ${pico.o || ""}
- Má»¥c tiÃªu: ${objective}
- MÃ´ táº£ can thiá»‡p: ${interventions.join("\n\n")}

YÃªu cáº§u: HÃ£y gá»£i Ã½ má»™t sá»‘ biáº¿n phÃ¹ há»£p cho nhÃ³m biáº¿n "${role}" (theo chá»©c nÄƒng nghiÃªn cá»©u). ÄÆ°a tÃªn biáº¿n vÃ  ngáº¯n gá»n lÃ½ do nÃªn Ä‘Æ°a vÃ o.
${fileText ? `\nTÃ i liá»‡u tham kháº£o:\n${fileText}` : ""}
`;

try {
  const response = await fetch("https://gpt-api-19xu.onrender.com/gpt.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ prompt })
  });

  const text = await response.text();

  try {
    const data = JSON.parse(text);
    const result = data.choices?.[0]?.message?.content || "GPT khÃ´ng tráº£ vá» pháº£n há»“i.";
    output.textContent = result;
  } catch (e) {
    output.textContent = "âŒ Lá»—i xá»­ lÃ½ JSON: " + text;
  }

} catch (error) {
  output.textContent = "âŒ Lá»—i khi gá»i GPT API: " + error.message;
}

async function evaluateVariablesForRole(role) {
  const list = document.querySelector(`.variable-list.variable-selected[data-role="${role}"]`);
  const items = [...list.querySelectorAll("li")];
  const output = document.getElementById(`eval-variable-${role}`);

  if (items.length === 0) {
    output.innerText = "âš ï¸ ChÆ°a cÃ³ biáº¿n nÃ o Ä‘Æ°á»£c chá»n.";
    return;
  }

  const selected = items.map(li => li.textContent).join(", ");
  const saved = JSON.parse(localStorage.getItem("rctWizardData") || "{}");
  const pico = saved.pico || {};
  const objective = saved.mainObjective || "";
  const interventions = saved.interventions || [];

  const prompt = `
ThÃ´ng tin nghiÃªn cá»©u RCT:
- P: ${pico.p || ""}
- I: ${pico.i || ""}
- C: ${pico.c || ""}
- O: ${pico.o || ""}
- Má»¥c tiÃªu: ${objective}
- MÃ´ táº£ can thiá»‡p: ${interventions.join("\n\n")}

CÃ¡c biáº¿n Ä‘Æ°á»£c chá»n cho nhÃ³m "${role}": ${selected}

HÃ£y Ä‘Ã¡nh giÃ¡ xem nhÃ³m biáº¿n nÃ y cÃ³ phÃ¹ há»£p vá»›i má»¥c tiÃªu nghiÃªn cá»©u khÃ´ng? CÃ³ thiáº¿u hoáº·c thá»«a khÃ´ng? Gá»£i Ã½ cáº£i thiá»‡n náº¿u cÃ³.
`;

  output.innerText = "GPT Ä‘ang Ä‘Ã¡nh giÃ¡...";

try {
  const response = await fetch("https://gpt-api-19xu.onrender.com/gpt.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ prompt })
  });

  const text = await response.text();

  try {
    const data = JSON.parse(text);
    const result = data.choices?.[0]?.message?.content || "GPT khÃ´ng tráº£ vá» pháº£n há»“i.";
    output.textContent = result;
  } catch (e) {
    output.textContent = "âŒ Lá»—i xá»­ lÃ½ JSON: " + text;
  }

} catch (error) {
  output.textContent = "âŒ Lá»—i khi gá»i GPT API: " + error.message;
}

//BÆ°á»›c 12
async function generateCollectSuggestion() {
  const saved = JSON.parse(localStorage.getItem("rctWizardData") || "{}");
  const pico = saved.pico || {};
  const objective = saved.mainObjective || "";
  const interventions = saved.interventions || [];
  const designType = saved.design?.type || "";
  const followupWeeks = saved.design?.followup || "";
  const crossover = saved.design?.crossover || {};

  // Biáº¿n Ä‘Ã£ chá»n tá»« bÆ°á»›c 11
  const selected = selectedVariables || {};
  const variableList = Object.entries(selected).flatMap(([role, vars]) =>
    vars.map(v => `${v.name} (${role})`)
  ).join(", ");

  // TrÃ­ch vÄƒn báº£n tá»« PDF náº¿u cÃ³
  const fileInput = document.getElementById("file-collect-pdf");
  let fileText = "";
  if (fileInput?.files?.[0]) {
    fileText = await extractTextFromPDF(fileInput.files[0]);
  }

  // Prompt khÃ¡c nhau theo thiáº¿t káº¿
  let designInfo = "";
  if (designType === "cross-over") {
    designInfo = `
Thiáº¿t káº¿: NghiÃªn cá»©u báº¯t chÃ©o (cross-over)
- Giai Ä‘oáº¡n 1: ${crossover.phase1 || "?"} tuáº§n
- Rá»­a trÃ´i: ${crossover.washout || "?"} tuáº§n
- Giai Ä‘oáº¡n 2: ${crossover.phase2 || "?"} tuáº§n
    `.trim();
  } else {
    designInfo = `Thiáº¿t káº¿: Song song; Thá»i gian theo dÃµi: ${followupWeeks || "?"} tuáº§n`;
  }

  const prompt = `
ThÃ´ng tin nghiÃªn cá»©u:
- P: ${pico.p || ""}
- I: ${pico.i || ""}
- C: ${pico.c || ""}
- O: ${pico.o || ""}
- Má»¥c tiÃªu: ${objective}
- Thiáº¿t káº¿ nghiÃªn cá»©u: ${designInfo}
- Can thiá»‡p: ${interventions.join("\n\n")}
- Biáº¿n Ä‘Ã£ chá»n: ${variableList}

HÃ£y gá»£i Ã½ káº¿ hoáº¡ch thu tháº­p dá»¯ liá»‡u, gá»“m:
- Thá»i Ä‘iá»ƒm thu
- Ai thu tháº­p
- Dá»¥ng cá»¥ Ä‘o
- PhÃ¢n loáº¡i biáº¿n theo nhÃ³m (ná»n, káº¿t cá»¥c chÃ­nh, phá»¥, an toÃ n, trung gian...)

${fileText ? `TÃ i liá»‡u há»— trá»£:\n${fileText}` : ""}
  `.trim();

  const output = document.getElementById("suggest-collect");
  output.innerText = "GPT Ä‘ang gá»£i Ã½...";

try {
  const response = await fetch("https://gpt-api-19xu.onrender.com/gpt.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ prompt })
  });

  const text = await response.text();

  try {
    const data = JSON.parse(text);
    const result = data.choices?.[0]?.message?.content || "GPT khÃ´ng tráº£ vá» pháº£n há»“i.";
    output.textContent = result;
  } catch (e) {
    output.textContent = "âŒ Lá»—i xá»­ lÃ½ JSON: " + text;
  }

} catch (error) {
  output.textContent = "âŒ Lá»—i khi gá»i GPT API: " + error.message;
}

async function evaluateCollectDescription() {
  const saved = JSON.parse(localStorage.getItem("rctWizardData") || "{}");
  const pico = saved.pico || {};
  const objective = saved.mainObjective || "";
  const interventions = saved.interventions || [];
  const designType = saved.design?.type || "";
  const followupWeeks = saved.design?.followup || "";
  const crossover = saved.design?.crossover || {};

  const desc = document.getElementById("collect-desc").value;

  const selected = selectedVariables || {};
  const variableList = Object.entries(selected).flatMap(([role, vars]) =>
    vars.map(v => `${v.name} (${role})`)
  ).join(", ");

  let designInfo = "";
  if (designType === "cross-over") {
    designInfo = `
Thiáº¿t káº¿: NghiÃªn cá»©u báº¯t chÃ©o (cross-over)
- Giai Ä‘oáº¡n 1: ${crossover.phase1 || "?"} tuáº§n
- Rá»­a trÃ´i: ${crossover.washout || "?"} tuáº§n
- Giai Ä‘oáº¡n 2: ${crossover.phase2 || "?"} tuáº§n
    `.trim();
  } else {
    designInfo = `Thiáº¿t káº¿: Song song; Thá»i gian theo dÃµi: ${followupWeeks || "?"} tuáº§n`;
  }

  const prompt = `
ThÃ´ng tin nghiÃªn cá»©u:
- P: ${pico.p || ""}
- I: ${pico.i || ""}
- C: ${pico.c || ""}
- O: ${pico.o || ""}
- Má»¥c tiÃªu: ${objective}
- Thiáº¿t káº¿ nghiÃªn cá»©u: ${designInfo}
- Can thiá»‡p: ${interventions.join("\n\n")}
- Biáº¿n Ä‘Ã£ chá»n: ${variableList}

NgÆ°á»i dÃ¹ng Ä‘Ã£ mÃ´ táº£ káº¿ hoáº¡ch thu tháº­p dá»¯ liá»‡u nhÆ° sau:
"${desc}"

HÃ£y Ä‘Ã¡nh giÃ¡ ná»™i dung nÃ y vá» má»©c Ä‘á»™ há»£p lÃ½, Ä‘áº§y Ä‘á»§, kháº£ thi vÃ  gá»£i Ã½ cáº£i thiá»‡n náº¿u cáº§n.
  `.trim();

  const output = document.getElementById("eval-collect");
  output.innerText = "GPT Ä‘ang Ä‘Ã¡nh giÃ¡...";

try {
  const response = await fetch("https://gpt-api-19xu.onrender.com/gpt.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ prompt })
  });

  const text = await response.text();

  try {
    const data = JSON.parse(text);
    const result = data.choices?.[0]?.message?.content || "GPT khÃ´ng tráº£ vá» pháº£n há»“i.";
    output.textContent = result;
  } catch (e) {
    output.textContent = "âŒ Lá»—i xá»­ lÃ½ JSON: " + text;
  }

} catch (error) {
  output.textContent = "âŒ Lá»—i khi gá»i GPT API: " + error.message;
}

//BÆ°á»›c 13

async function generateAnalysisPlan() {
  const saved = JSON.parse(localStorage.getItem("rctWizardData") || "{}");
  const pico = saved.pico || {};
  const objective = saved.mainObjective || "";
  const interventions = saved.interventions || [];
  const numArms = parseInt(localStorage.getItem("num-arms") || "0");
  const designType = saved.design?.type || "Song song";

  const selected = selectedVariables || {};
  const variableList = Object.entries(selected).flatMap(([role, vars]) =>
    vars.map(v => `${v.name} (${role})`)
  ).join(", ");

  const fileInput = document.getElementById("file-analysis-pdf");
  let fileText = "";
  if (fileInput?.files?.[0]) {
    fileText = await extractTextFromPDF(fileInput.files[0]);
  }

  let designExplain = "";
  switch (designType) {
    case "Báº¯t chÃ©o (cross-over)":
      designExplain = "Thiáº¿t káº¿ nghiÃªn cá»©u lÃ  báº¯t chÃ©o (cross-over), do Ä‘Ã³ cáº§n phÃ¢n tÃ­ch theo tá»«ng cÃ¡ thá»ƒ vá»›i kiá»ƒm tra carry-over effect.";
      break;
    case "RCT cá»¥m":
      designExplain = "Thiáº¿t káº¿ nghiÃªn cá»©u lÃ  cá»¥m (cluster RCT), cáº§n sá»­ dá»¥ng mÃ´ hÃ¬nh há»“i quy Ä‘a má»©c hoáº·c GEE.";
      break;
    case "Factorial":
      designExplain = "Thiáº¿t káº¿ nghiÃªn cá»©u lÃ  factorial, cáº§n phÃ¢n tÃ­ch hiá»‡u á»©ng chÃ­nh vÃ  tÆ°Æ¡ng tÃ¡c giá»¯a cÃ¡c yáº¿u tá»‘.";
      break;
    default:
      designExplain = "Thiáº¿t káº¿ nghiÃªn cá»©u lÃ  song song (parallel RCT).";
  }

  const prompt = `
Báº¡n lÃ  chuyÃªn gia phÃ¢n tÃ­ch sá»‘ liá»‡u lÃ¢m sÃ ng. HÃ£y viáº¿t káº¿ hoáº¡ch phÃ¢n tÃ­ch sá»‘ liá»‡u (SAP) cho nghiÃªn cá»©u sau:

- P: ${pico.p || ""}
- I: ${pico.i || ""}
- C: ${pico.c || ""}
- O: ${pico.o || ""}
- Má»¥c tiÃªu nghiÃªn cá»©u: ${objective}
- Thiáº¿t káº¿ nghiÃªn cá»©u: ${designType}
- ${designExplain}
- Sá»‘ nhÃ³m can thiá»‡p: ${numArms}
- MÃ´ táº£ can thiá»‡p: ${interventions.join("\n\n")}
- CÃ¡c biáº¿n sá»‘ Ä‘Ã£ chá»n: ${variableList}

YÃªu cáº§u: Viáº¿t káº¿ hoáº¡ch phÃ¢n tÃ­ch chuáº©n má»±c, bao gá»“m:
1. PhÃ¢n tÃ­ch mÃ´ táº£ ban Ä‘áº§u
2. PhÃ¢n tÃ­ch káº¿t cá»¥c chÃ­nh
3. PhÃ¢n tÃ­ch káº¿t cá»¥c phá»¥
4. PhÃ¢n tÃ­ch biáº¿n ná»n vÃ  yáº¿u tá»‘ gÃ¢y nhiá»…u
5. PhÃ¢n tÃ­ch an toÃ n
6. PhÃ¢n tÃ­ch nháº¡y cáº£m (náº¿u cáº§n)
7. Kiá»ƒm Ä‘á»‹nh thá»‘ng kÃª tÆ°Æ¡ng á»©ng
8. PhÆ°Æ¡ng phÃ¡p xá»­ lÃ½ missing data
9. Pháº§n má»m vÃ  tiÃªu chÃ­ thá»‘ng kÃª

${fileText ? `TÃ i liá»‡u há»— trá»£:\n${fileText}` : ""}
`;

  const output = document.getElementById("suggest-analysis");
  output.innerText = "GPT Ä‘ang gá»£i Ã½...";

try {
  const response = await fetch("https://gpt-api-19xu.onrender.com/gpt.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ prompt })
  });

  const text = await response.text();

  try {
    const data = JSON.parse(text);
    const result = data.choices?.[0]?.message?.content || "GPT khÃ´ng tráº£ vá» pháº£n há»“i.";
    output.textContent = result;
  } catch (e) {
    output.textContent = "âŒ Lá»—i xá»­ lÃ½ JSON: " + text;
  }

} catch (error) {
  output.textContent = "âŒ Lá»—i khi gá»i GPT API: " + error.message;
}

async function evaluateAnalysisPlan() {
  const saved = JSON.parse(localStorage.getItem("rctWizardData") || "{}");
  const pico = saved.pico || {};
  const objective = saved.mainObjective || "";
  const interventions = saved.interventions || [];
  const numArms = parseInt(localStorage.getItem("num-arms") || "0");
  const designType = saved.design?.type || "Song song";

  const desc = document.getElementById("analysis-desc").value;
  const selected = selectedVariables || {};
  const variableList = Object.entries(selected).flatMap(([role, vars]) =>
    vars.map(v => `${v.name} (${role})`)
  ).join(", ");

  const prompt = `
Báº¡n lÃ  chuyÃªn gia Ä‘Ã¡nh giÃ¡ Ä‘á» cÆ°Æ¡ng nghiÃªn cá»©u. HÃ£y Ä‘á»c ná»™i dung sau vÃ  cho nháº­n xÃ©t xem chiáº¿n lÆ°á»£c phÃ¢n tÃ­ch cÃ³ há»£p lÃ½ khÃ´ng, cÃ³ cáº§n bá»• sung hay cáº£i thiá»‡n khÃ´ng.

ThÃ´ng tin nghiÃªn cá»©u:
- P: ${pico.p || ""}
- I: ${pico.i || ""}
- C: ${pico.c || ""}
- O: ${pico.o || ""}
- Má»¥c tiÃªu nghiÃªn cá»©u: ${objective}
- Thiáº¿t káº¿ nghiÃªn cá»©u: ${designType}
- Sá»‘ nhÃ³m can thiá»‡p: ${numArms}
- MÃ´ táº£ can thiá»‡p: ${interventions.join("\n\n")}
- CÃ¡c biáº¿n sá»‘ Ä‘Ã£ chá»n: ${variableList}

Chiáº¿n lÆ°á»£c phÃ¢n tÃ­ch ngÆ°á»i dÃ¹ng Ä‘Ã£ viáº¿t:
"${desc}"

YÃªu cáº§u: Nháº­n xÃ©t rÃµ rÃ ng vá» Ä‘iá»ƒm máº¡nh, Ä‘iá»ƒm thiáº¿u sÃ³t, vÃ  Ä‘á» xuáº¥t Ä‘iá»u chá»‰nh náº¿u cÃ³.
`;

  const output = document.getElementById("eval-analysis");
  output.innerText = "GPT Ä‘ang Ä‘Ã¡nh giÃ¡...";

ctry {
  const response = await fetch("https://gpt-api-19xu.onrender.com/gpt.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ prompt })
  });

  const text = await response.text();

  try {
    const data = JSON.parse(text);
    const result = data.choices?.[0]?.message?.content || "GPT khÃ´ng tráº£ vá» pháº£n há»“i.";
    output.textContent = result;
  } catch (e) {
    output.textContent = "âŒ Lá»—i xá»­ lÃ½ JSON: " + text;
  }

} catch (error) {
  output.textContent = "âŒ Lá»—i khi gá»i GPT API: " + error.message;
}

//BÆ°á»›c 14

async function generateEthicsSection() {
  const saved = JSON.parse(localStorage.getItem("rctWizardData") || "{}");
  const pico = saved.pico || {};
  const objective = saved.mainObjective || "";
  const interventions = saved.interventions || [];
  const numArms = parseInt(localStorage.getItem("num-arms") || "0");

  // Náº¿u cÃ³ file PDF
  const fileInput = document.getElementById("file-ethics-pdf");
  let fileText = "";
  if (fileInput?.files?.[0]) {
    fileText = await extractTextFromPDF(fileInput.files[0]);
  }

  const prompt = `
Báº¡n lÃ  chuyÃªn gia Ä‘áº¡o Ä‘á»©c nghiÃªn cá»©u. HÃ£y viáº¿t pháº§n "Äáº¡o Ä‘á»©c nghiÃªn cá»©u" cho má»™t Ä‘á» cÆ°Æ¡ng RCT vá»›i cÃ¡c thÃ´ng tin sau:

- P: ${pico.p || ""}
- I: ${pico.i || ""}
- C: ${pico.c || ""}
- O: ${pico.o || ""}
- Má»¥c tiÃªu nghiÃªn cá»©u: ${objective}
- Sá»‘ nhÃ³m can thiá»‡p: ${numArms}
- MÃ´ táº£ can thiá»‡p: ${interventions.join("\n\n")}

Ná»™i dung Ä‘áº¡o Ä‘á»©c cáº§n trÃ¬nh bÃ y:
1. TuÃ¢n thá»§ cÃ¡c chuáº©n má»±c Ä‘áº¡o Ä‘á»©c (TuyÃªn bá»‘ Helsinki, GCP, quy Ä‘á»‹nh Ä‘á»‹a phÆ°Æ¡ngâ€¦)
2. TrÃ¬nh quy trÃ¬nh xin Ã½ kiáº¿n Há»™i Ä‘á»“ng Äáº¡o Ä‘á»©c
3. MÃ´ táº£ láº¥y Ä‘á»“ng thuáº­n ngÆ°á»i tham gia
4. Báº£o máº­t vÃ  quyá»n riÃªng tÆ°
5. Quyá»n rÃºt lui, theo dÃµi an toÃ n
6. Quáº£n lÃ½ dá»¯ liá»‡u vÃ  báº£o lÆ°u há»“ sÆ¡

${fileText ? `TÃ i liá»‡u há»— trá»£:\n${fileText}` : ""}
`;

  const output = document.getElementById("suggest-ethics");
  output.innerText = "GPT Ä‘ang gá»£i Ã½...";

try {
  const response = await fetch("https://gpt-api-19xu.onrender.com/gpt.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ prompt })
  });

  const text = await response.text();

  try {
    const data = JSON.parse(text);
    const result = data.choices?.[0]?.message?.content || "GPT khÃ´ng tráº£ vá» pháº£n há»“i.";
    output.textContent = result;
  } catch (e) {
    output.textContent = "âŒ Lá»—i xá»­ lÃ½ JSON: " + text;
  }

} catch (error) {
  output.textContent = "âŒ Lá»—i khi gá»i GPT API: " + error.message;
}

async function evaluateEthicsSection() {
  const desc = document.getElementById("ethics-desc").value;

  const prompt = `
Báº¡n lÃ  thÃ nh viÃªn Há»™i Ä‘á»“ng Äáº¡o Ä‘á»©c nghiÃªn cá»©u. HÃ£y Ä‘Ã¡nh giÃ¡ ná»™i dung sau cÃ³ Ä‘áº§y Ä‘á»§ vÃ  Ä‘Ãºng nguyÃªn táº¯c Ä‘áº¡o Ä‘á»©c nghiÃªn cá»©u khÃ´ng. Náº¿u thiáº¿u, hÃ£y gÃ³p Ã½ cá»¥ thá»ƒ:

"${desc}"
`;

  const output = document.getElementById("eval-ethics");
  output.innerText = "GPT Ä‘ang Ä‘Ã¡nh giÃ¡...";

try {
  const response = await fetch("https://gpt-api-19xu.onrender.com/gpt.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ prompt })
  });

  const text = await response.text();

  try {
    const data = JSON.parse(text);
    const result = data.choices?.[0]?.message?.content || "GPT khÃ´ng tráº£ vá» pháº£n há»“i.";
    output.textContent = result;
  } catch (e) {
    output.textContent = "âŒ Lá»—i xá»­ lÃ½ JSON: " + text;
  }

} catch (error) {
  output.textContent = "âŒ Lá»—i khi gá»i GPT API: " + error.message;
}

//BÆ°á»›c 15

async function checkLogic() {
  const saved = JSON.parse(localStorage.getItem("rctWizardData") || "{}");
  const pico = saved.pico || {};
  const objective = saved.mainObjective || "";
  const interventions = saved.interventions || [];
  const numArms = localStorage.getItem("num-arms") || "KhÃ´ng xÃ¡c Ä‘á»‹nh";

  const selected = selectedVariables || {};
  const variableList = Object.entries(selected).flatMap(([role, vars]) =>
    vars.map(v => `${v.name} (${role})`)
  ).join(", ");

  const analysis = document.getElementById("analysis-desc")?.value || "";
  const ethics = document.getElementById("ethics-desc")?.value || "";

  const prompt = `
Báº¡n lÃ  chuyÃªn gia Ä‘Ã¡nh giÃ¡ Ä‘á» cÆ°Æ¡ng RCT. HÃ£y kiá»ƒm tra tÃ­nh nháº¥t quÃ¡n vÃ  logic giá»¯a cÃ¡c pháº§n sau:

- P: ${pico.p || ""}
- I: ${pico.i || ""}
- C: ${pico.c || ""}
- O: ${pico.o || ""}
- Má»¥c tiÃªu nghiÃªn cá»©u: ${objective}
- Sá»‘ nhÃ³m can thiá»‡p: ${numArms}
- MÃ´ táº£ can thiá»‡p: ${interventions.join("\n\n")}
- Biáº¿n sá»‘ Ä‘Ã£ chá»n: ${variableList}
- MÃ´ táº£ phÃ¢n tÃ­ch sá»‘ liá»‡u: ${analysis}
- Pháº§n Ä‘áº¡o Ä‘á»©c nghiÃªn cá»©u: ${ethics}

HÃ£y nÃªu rÃµ:
1. CÃ³ pháº§n nÃ o bá»‹ thiáº¿u hoáº·c chÆ°a Ä‘iá»n khÃ´ng?
2. CÃ³ mÃ¢u thuáº«n giá»¯a cÃ¡c pháº§n khÃ´ng?
3. GÃ³p Ã½ cÃ¡ch chá»‰nh sá»­a Ä‘á»ƒ há»£p lÃ½ vÃ  nháº¥t quÃ¡n.

ÄÃ¡nh giÃ¡ tá»•ng quan Ä‘á» cÆ°Æ¡ng nÃ y.

`;

  const output = document.getElementById("logic-check-result");
  output.innerText = "GPT Ä‘ang kiá»ƒm tra...";

try {
  const response = await fetch("https://gpt-api-19xu.onrender.com/gpt.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ prompt })
  });

  const text = await response.text();

  try {
    const data = JSON.parse(text);
    const result = data.choices?.[0]?.message?.content || "GPT khÃ´ng tráº£ vá» pháº£n há»“i.";
    output.textContent = result;
  } catch (e) {
    output.textContent = "âŒ Lá»—i xá»­ lÃ½ JSON: " + text;
  }

} catch (error) {
  output.textContent = "âŒ Lá»—i khi gá»i GPT API: " + error.message;
}

//BÆ°á»›c 16
function downloadMermaidPNG() {
  const target = document.getElementById("consort-mermaid");
  html2canvas(target).then(canvas => {
    const link = document.createElement("a");
    link.download = "consort_diagram.png";
    link.href = canvas.toDataURL();
    link.click();
  });
}

function renderStudyFlowDiagram() {
  const saved = JSON.parse(localStorage.getItem("rctWizardData") || "{}");

  // BÆ°á»›c 6 â€“ Thiáº¿t káº¿
  const designType = saved.design?.type || "parallel";
  const arms = saved.design?.arms || ["NhÃ³m 1", "NhÃ³m 2"];
  const interventions = saved.interventions || [];
  const samplePerGroup = saved.sampleSize?.perGroup || "n=??";
  const crossover = saved.design?.crossover || {};
  const phase1Weeks = parseInt(crossover.phase1Weeks || "0");
  const washoutWeeks = parseInt(crossover.washout || "0");

  // BÆ°á»›c 7â€“8 â€“ TiÃªu chÃ­
  const inclusion = (saved.criteria?.inclusion || []).slice(0, 2).join("; ");
  const exclusion = (saved.criteria?.exclusion || []).slice(0, 2).join("; ");

  // BÆ°á»›c 11 â€“ Biáº¿n vÃ  thá»i gian Ä‘o
  const selected = saved.selectedVariables || {};
  const timeMap = {};
  for (const role in selected) {
  (selected[role] || []).forEach(v => {
    const varName = (v.name || "").trim();
    const timesRaw = (v.time || "").split(",").map(s => s.trim()).filter(Boolean);
    timesRaw.forEach(t => {
      if (!t || !varName) return;
      if (!timeMap[t]) timeMap[t] = [];
      if (!timeMap[t].includes(varName)) timeMap[t].push(varName);
    });
  });
}

  // TÃ¡ch giai Ä‘oáº¡n náº¿u lÃ  crossover
  const phase1Times = [], phase2Times = [];
  if (designType === "cross-over") {
    Object.keys(timeMap).forEach(t => {
      const match = t.match(/Tuáº§n\s*(\d+)/i);
      if (match) {
        const week = parseInt(match[1]);
        if (week <= phase1Weeks) phase1Times.push(t);
        else if (week > phase1Weeks + washoutWeeks) phase2Times.push(t);
      }
    });
  }

  const getVarsAt = times => {
  const merged = {}; // key = time, value = list biáº¿n

  times.forEach(t => {
    (timeMap[t] || []).forEach(v => {
      if (!merged[t]) merged[t] = new Set();
      merged[t].add(v);
    });
  });

  return Object.keys(merged)
    .sort((a, b) => {
      const n1 = parseInt(a.match(/\d+/)?.[0] || "0");
      const n2 = parseInt(b.match(/\d+/)?.[0] || "0");
      return n1 - n2;
    })
    .map(t => `ğŸ•’ ${t}: ${[...merged[t]].join(", ")}`)
    .join("<br>") || "ChÆ°a xÃ¡c Ä‘á»‹nh";
};

  // Báº¯t Ä‘áº§u Mermaid
  let diagram = `flowchart TD\n`;
  diagram += `  A["ğŸ“‹ Thu nháº­n ngÆ°á»i bá»‡nh<br>TiÃªu chÃ­ chá»n: ${inclusion || "..."}<br>TiÃªu chÃ­ loáº¡i: ${exclusion || "..."}"] --> B["ğŸ² Ngáº«u nhiÃªn hÃ³a (${designType})"]\n`;

  if (designType === "parallel") {
    arms.forEach((name, i) => {
      const C = `C${i}`;
      const D = `D${i}`;
      const E = `E${i}`;
      const intervention = interventions[i] || "Can thiá»‡p";
      const uniqueTimes = Object.keys(timeMap).filter(t => !!t);
      const timesBlock = getVarsAt(uniqueTimes);
      diagram += `  B --> ${C}["${name}<br>${intervention}<br>${samplePerGroup}"]\n`;
      diagram += `  ${C} --> ${D}["ğŸ“Š Thu tháº­p dá»¯ liá»‡u:<br>${timesBlock}"]\n`;
      diagram += `  ${D} --> ${E}["ğŸ“ˆ PhÃ¢n tÃ­ch káº¿t quáº£ nhÃ³m ${i + 1}"]\n`;
    });
    arms.forEach((_, i) => {
      diagram += `  E${i} --> F["ğŸ“ Tá»•ng há»£p & bÃ¡o cÃ¡o káº¿t quáº£"]\n`;
    });

  } else if (designType === "cross-over") {
    
    const g1_phase1 = crossover.g1_phase1?.trim() || "ChÆ°a rÃµ";
    const g2_phase1 = crossover.g2_phase1?.trim() || "ChÆ°a rÃµ";
    const g1_phase2 = crossover.g1_phase2?.trim() || "ChÆ°a rÃµ";
    const g2_phase2 = crossover.g2_phase2?.trim() || "ChÆ°a rÃµ";

    const phase1Block = getVarsAt(phase1Times);
    const phase2Block = getVarsAt(phase2Times);

    diagram += `  B --> C1["NhÃ³m 1<br>â±ï¸ Giai Ä‘oáº¡n 1 (${phase1Weeks} tuáº§n): ${g1_phase1}<br>${samplePerGroup}"]\n`;
    diagram += `  B --> C2["NhÃ³m 2<br>â±ï¸ Giai Ä‘oáº¡n 1 (${phase1Weeks} tuáº§n): ${g2_phase1}<br>${samplePerGroup}"]\n`;

    diagram += `  C1 --> D1["ğŸ“Š Thu tháº­p dá»¯ liá»‡u giai Ä‘oáº¡n 1:<br>${phase1Block}"]\n`;
    diagram += `  C2 --> D2["ğŸ“Š Thu tháº­p dá»¯ liá»‡u giai Ä‘oáº¡n 1:<br>${phase1Block}"]\n`;

    diagram += `  D1 --> E1["ğŸ§¼ Rá»­a trÃ´i (${washoutWeeks} tuáº§n)"] --> F1["â±ï¸ Giai Ä‘oáº¡n 2: ${g1_phase2}"] --> G1["ğŸ“Š Thu tháº­p dá»¯ liá»‡u giai Ä‘oáº¡n 2:<br>${phase2Block}"]\n`;
    diagram += `  D2 --> E2["ğŸ§¼ Rá»­a trÃ´i (${washoutWeeks} tuáº§n)"] --> F2["â±ï¸ Giai Ä‘oáº¡n 2: ${g2_phase2}"] --> G2["ğŸ“Š Thu tháº­p dá»¯ liá»‡u giai Ä‘oáº¡n 2:<br>${phase2Block}"]\n`;

    diagram += `  G1 --> H["ğŸ“ˆ PhÃ¢n tÃ­ch káº¿t quáº£"]\n`;
    diagram += `  G2 --> H\n`;
    diagram += `  H --> I["ğŸ“ Tá»•ng há»£p & bÃ¡o cÃ¡o"]\n`;
  }

  // Váº½ láº¡i
  const oldContainer = document.getElementById("studyflow-mermaid");
  const parent = oldContainer?.parentElement;
  if (oldContainer) oldContainer.remove();

  const newPre = document.createElement("pre");
  newPre.id = "studyflow-mermaid";
  newPre.className = "mermaid";
  newPre.textContent = diagram;
  newPre.style.padding = "20px";
  newPre.style.border = "1px solid #ccc";

  parent.insertBefore(newPre, parent.querySelector("br"));

  setTimeout(() => {
    try {
      mermaid.run();
    } catch (err) {
      newPre.innerHTML = `<pre style="color:red;">Lá»—i Mermaid: ${err.message || err}</pre>`;
      console.error("Mermaid error", err, diagram);
    }
  }, 50);
}

// ====================== PHáº¦N 2: HÃ m xá»­ lÃ½ dá»¯ liá»‡u ==================

function saveData() {
  const arms = Array.from(document.querySelectorAll(".arm-description")).map(el => el.value);
  localStorage.setItem("num-arms", arms.length);
  let ethics = {};
    if (
    document.getElementById("ethics-board") &&
    document.getElementById("ethics-approval-code") &&
    document.getElementById("ethics-date") &&
    document.getElementById("ethics-rights") &&
    document.getElementById("ethics-note")
    ) {
    ethics = {
    board: document.getElementById("ethics-board").value,
    approvalCode: document.getElementById("ethics-approval-code").value,
    date: document.getElementById("ethics-date").value,
    rights: document.getElementById("ethics-rights").value,
    note: document.getElementById("ethics-note").value
    };
  }
  const data = {
    // BÆ°á»›c 1: PICO
    pico: {
      p: document.getElementById("pico-p").value,
      i: document.getElementById("pico-i").value,
      c: document.getElementById("pico-c").value,
      o: document.getElementById("pico-o").value
    },

    // BÆ°á»›c 2: CÃ¢u há»i nghiÃªn cá»©u
    question: document.getElementById("question").value,

    // BÆ°á»›c 3: Má»¥c tiÃªu nghiÃªn cá»©u
    mainObjective: document.getElementById("main-objective").value,
    subObjectives: Array.from(document.querySelectorAll(".sub-objective")).map(el => el.value),

    // BÆ°á»›c 4: Má»Ÿ Ä‘áº§u (CaRS)
    introduction: {
      territory: document.getElementById("intro-territory")?.value || "",
      niche: document.getElementById("intro-niche")?.value || "",
      occupy: document.getElementById("intro-occupy")?.value || ""
    },

    // BÆ°á»›c 5: Tá»•ng quan tÃ i liá»‡u
    literature: Array.from(document.querySelectorAll(".literature-section")).map(div => ({
      title: div.querySelector(".literature-title").value,
      content: div.querySelector(".literature-content").value
    })),

    // BÆ°á»›c 6: Thiáº¿t káº¿ nghiÃªn cá»©u
    design: {
    type: document.getElementById("design-type").value,  // sáº½ lÃ : "parallel", "cross-over", "cluster", hoáº·c "factorial"
    randomization: document.getElementById("randomization").value,
    blinding: document.getElementById("blinding").value,
    followupWeeks: document.getElementById("followup-weeks")?.value || "",
    arms: Array.from(document.querySelectorAll(".arm-description")).map(el => el.value),
    interventionWeeks: document.getElementById("intervention-weeks")?.value || "",
    crossover: {
          g1_phase1: document.getElementById("crossover-g1-phase1")?.value || "",
          g2_phase1: document.getElementById("crossover-g2-phase1")?.value || "",
          washout: document.getElementById("crossover-washout")?.value || "",
          g1_phase2: document.getElementById("crossover-g1-phase2")?.value || "",
          g2_phase2: document.getElementById("crossover-g2-phase2")?.value || "",
          phase1Weeks: document.getElementById("crossover-phase1")?.value || "" 
        }
    },

    // BÆ°á»›c 7: Cá»¡ máº«u
    sampleSize: {
      method: document.getElementById("sample-size-method")?.value || "",
      alpha: document.getElementById("alpha")?.value || "",
      power: document.getElementById("power")?.value || "",
      sigma: document.getElementById("sigma")?.value || "",
      delta: document.getElementById("delta")?.value || "",
      deltaMean: document.getElementById("delta-mean")?.value || "",
      deltaMargin: document.getElementById("delta-margin")?.value || "",
      stdDev: document.getElementById("std-dev")?.value || "",
      p1: document.getElementById("p1")?.value || "",
      p2: document.getElementById("p2")?.value || "",
      pc: document.getElementById("pc")?.value || "",
      pt: document.getElementById("pt")?.value || "",
      rsquared: document.getElementById("rsquared")?.value || "",
      k: document.getElementById("k")?.value || "",
      effectF: document.getElementById("effect-f")?.value || "",
      effectW: document.getElementById("effect-w")?.value || "",
      kChisq: document.getElementById("k-chisq")?.value || "",
      pChisq: document.getElementById("p-chisq")?.value || "",
      perGroup: window.calculatedSampleSize || ""
    },

    // BÆ°á»›c 8: TiÃªu chÃ­ chá»n vÃ  loáº¡i
    criteria: {
      inclusion: Array.from(document.querySelectorAll(".inclusion-item")).map(el => el.value),
      exclusion: Array.from(document.querySelectorAll(".exclusion-item")).map(el => el.value)
    },

    // BÆ°á»›c 9: PhÃ¢n bá»• ngáº«u nhiÃªn
    randomization: {
      method: document.getElementById("random-method")?.value || "",
      blockSize: document.getElementById("block-size")?.value || "",
      strata: document.getElementById("strata-variables")?.value || "",
      adaptive: document.getElementById("adaptive-type")?.value || ""
    },

    // BÆ°á»›c 10: Can thiá»‡p
    interventions: Array.from(document.querySelectorAll(".intervention-item")).map(el => el.value),

    // BÆ°á»›c 11: Biáº¿n sá»‘
    selectedVariables: (() => {
  const result = {};
  document.querySelectorAll(".variable-selected").forEach(list => {
    const role = list.dataset.role;
    const vars = Array.from(list.querySelectorAll("li")).map(li => ({
      name: li.dataset.name,
      role: li.dataset.role,
      type: li.dataset.type || "",
      time: li.dataset.time || "",
      unit: li.dataset.unit || "",
      measure: li.dataset.measure || "",
      definition: li.dataset.definition || "",
      source: li.dataset.source || "",
      format: li.dataset.format || "",
      range: li.dataset.range || "",
      mcid_or_cutoff: li.dataset.mcid || ""
    }));
    result[role] = vars;
  });
  window.selectedVariables = result;  
  return result;
 })(),

    // BÆ°á»›c 12: Thu tháº­p sá»‘ liá»‡u
    collectPlans: Array.from(document.querySelectorAll(".collection-block")).map(div => ({
      time: div.querySelector(".collect-time").value,
      variables: div.querySelector(".collect-variables").value,
      method: div.querySelector(".collect-method").value,
      by: div.querySelector(".collect-by").value,
      note: div.querySelector(".collect-note").value
    })),

    // BÆ°á»›c 13: PhÃ¢n tÃ­ch sá»‘ liá»‡u
    analysisPlans: Array.from(document.querySelectorAll(".analysis-block")).map(div => ({
      variable: div.querySelector(".analysis-variable").value,
      method: div.querySelector(".analysis-method").value,
      software: div.querySelector(".analysis-software").value,
      threshold: div.querySelector(".analysis-threshold").value,
      note: div.querySelector(".analysis-note").value
    })),

    // BÆ°á»›c 14: Äáº¡o Ä‘á»©c nghiÃªn cá»©u
    
      ethics: ethics
    };
   localStorage.setItem("rctWizardData", JSON.stringify(data));
}


function loadData() {
  let data = JSON.parse(localStorage.getItem("rctWizardData"));
  if (!data) data = {};
  if (!data.pico) data.pico = {};

  // BÆ°á»›c 1: PICO
  document.getElementById("pico-p").value = data.pico.p || "";
  document.getElementById("pico-i").value = data.pico.i || "";
  document.getElementById("pico-c").value = data.pico.c || "";
  document.getElementById("pico-o").value = data.pico.o || "";

  // BÆ°á»›c 2: CÃ¢u há»i
  document.getElementById("question").value = data.question || "";

  // BÆ°á»›c 3: Má»¥c tiÃªu
  document.getElementById("main-objective").value = data.mainObjective || "";
  const container = document.getElementById("sub-objectives");
  container.innerHTML = "";
  (data.subObjectives || []).forEach(val => {
    const div = document.createElement("div");
    div.innerHTML = `<input type="text" class="sub-objective" value="${val}">`;
    container.appendChild(div);
  });

  // BÆ°á»›c 4: Má»Ÿ Ä‘áº§u
  if (data.introduction) {
    document.getElementById("intro-territory").value = data.introduction.territory || "";
    document.getElementById("intro-niche").value = data.introduction.niche || "";
    document.getElementById("intro-occupy").value = data.introduction.occupy || "";
  }

  // BÆ°á»›c 5: Tá»•ng quan tÃ i liá»‡u
  if (data.literature && Array.isArray(data.literature)) {
  const container = document.getElementById("literature-sections");
  if (container) {
    container.innerHTML = "";
    data.literature.forEach(sec => addLiteratureSection(sec.title, sec.content));
  }
}

  // BÆ°á»›c 6: Thiáº¿t káº¿ nghiÃªn cá»©u
  if (data.design) {
  const typeEl = document.getElementById("design-type");
  if (typeEl) {
    typeEl.value = data.design.type || "";
    updateDesignFields();
  }

  const randEl = document.getElementById("randomization");
  if (randEl) randEl.value = data.design.randomization || "";

  const blindEl = document.getElementById("blinding");
  if (blindEl) blindEl.value = data.design.blinding || "";

  const followupEl = document.getElementById("followup-weeks");
  if (followupEl) followupEl.value = data.design.followupWeeks || "";

  const numArmsEl = document.getElementById("num-arms");
  if (numArmsEl) numArmsEl.value = data.design.arms?.length || 2;

  renderArms();

  const armsInputs = document.querySelectorAll(".arm-description");
  (data.design.arms || []).forEach((desc, idx) => {
    if (armsInputs[idx]) armsInputs[idx].value = desc;
  });
}

  // BÆ°á»›c 7: Cá»¡ máº«u
  if (data.sampleSize) {
    document.getElementById("sample-size-method").value = data.sampleSize.method || "";
    renderSampleSizeForm();
    const f = (id, val) => { const el = document.getElementById(id); if (el) el.value = val || ""; };
    f("alpha", data.sampleSize.alpha);
    f("power", data.sampleSize.power);
    f("sigma", data.sampleSize.sigma);
    f("delta", data.sampleSize.delta);
    f("delta-mean", data.sampleSize.deltaMean);
    f("delta-margin", data.sampleSize.deltaMargin);
    f("std-dev", data.sampleSize.stdDev);
    f("p1", data.sampleSize.p1);
    f("p2", data.sampleSize.p2);
    f("pt", data.sampleSize.pt);
    f("pc", data.sampleSize.pc);
    f("rsquared", data.sampleSize.rsquared);
    f("k", data.sampleSize.k);
    f("effect-f", data.sampleSize.effectF);
    f("effect-w", data.sampleSize.effectW);
    f("k-chisq", data.sampleSize.kChisq);
    f("p-chisq", data.sampleSize.pChisq);
  }

  // BÆ°á»›c 8: TiÃªu chÃ­
  if (data.criteria) {
    const inclusionBox = document.getElementById("inclusion-criteria");
    const exclusionBox = document.getElementById("exclusion-criteria");
    inclusionBox.innerHTML = "";
    exclusionBox.innerHTML = "";
    (data.criteria.inclusion || []).forEach(item => addInclusionCriterion(item));
    (data.criteria.exclusion || []).forEach(item => addExclusionCriterion(item));
  }

  // BÆ°á»›c 9: PhÃ¢n bá»• ngáº«u nhiÃªn
  if (data.randomization) {
  const randomMethodEl = document.getElementById("random-method");
  if (randomMethodEl) {
    randomMethodEl.value = data.randomization.method || "";
    renderRandomOptions();

    if (data.randomization.blockSize) {
      const el = document.getElementById("block-size");
      if (el) el.value = data.randomization.blockSize;
    }

    if (data.randomization.strata) {
      const el = document.getElementById("strata-variables");
      if (el) el.value = data.randomization.strata;
    }

    if (data.randomization.adaptive) {
      const el = document.getElementById("adaptive-type");
      if (el) el.value = data.randomization.adaptive;
    }
  }
}

  // BÆ°á»›c 10: MÃ´ táº£ can thiá»‡p
  if (data.interventions && Array.isArray(data.interventions)) {
    const container = document.getElementById("intervention-descriptions");
    container.innerHTML = "";
    data.interventions.forEach(text => addIntervention(text));
  }

  // BÆ°á»›c 11: Biáº¿n sá»‘
  if (data.selectedVariables) {
    Object.entries(data.selectedVariables).forEach(([role, vars]) => {
      selectedVariables[role] = vars;
    });
    if (typeof createVariableDragUI === 'function') createVariableDragUI();
  }

  // BÆ°á»›c 14: Äáº¡o Ä‘á»©c
  if (data.ethics && typeof data.ethics === "string") {
  document.getElementById("ethics-desc").value = data.ethics;
  }
}

// ====================== PHáº¦N 3: HÃ m Ä‘iá»u hÆ°á»›ng =====================

let currentStep = 0;
function goToStep(step) {
      document.querySelectorAll('.step').forEach((el, i) => {
        el.classList.toggle('active', i === step);
      });
      document.querySelectorAll('.steps-nav button').forEach((btn, i) => {
        btn.classList.toggle('active', i === step);
      });
      currentStep = step;
      localStorage.setItem("currentStep", step);
      if (step === 8) loadRandomizationInfo();
      if (step === 9) renderInterventionBlocks();
      if (step === 10) createVariableDragUI();
      if (step === 14) {
      const logicResult = document.getElementById("logic-check-result");
      if (logicResult) logicResult.innerHTML = "";
      };
      if (step === 15) renderStudyFlowDiagram();
    }

window.addEventListener('load', function () {
  const savedStep = parseInt(localStorage.getItem("currentStep")) || 0;
  goToStep(savedStep);  
  loadData();
  loadRandomizationInfo();
  renderSampleSizeForm();
  renderRandomOptions();

  if (typeof createVariableDragUI === 'function') createVariableDragUI();
  if (typeof updateDropdowns === 'function') updateDropdowns();
  if (typeof loadCSVFiles === 'function') loadCSVFiles();
  if (typeof setupPdfUpload === 'function') setupPdfUpload();
  if (typeof renderStudyFlowDiagram === "function") renderStudyFlowDiagram();
  if (typeof updateDesignFields === 'function') updateDesignFields();
});

function resetWizard() {
  if (confirm("Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a toÃ n bá»™ dá»¯ liá»‡u vÃ  lÃ m láº¡i tá»« Ä‘áº§u?")) {
    localStorage.removeItem("rctWizardData");
    localStorage.removeItem("num-arms");
    location.reload();
  }
}

 window.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll("textarea, input[type='text']").forEach(el => {
      el.setAttribute("spellcheck", "false");
    });
  });

window.addEventListener("DOMContentLoaded", function () {
    const inputs = document.querySelectorAll("input, textarea, select");
    inputs.forEach(el => {
      el.addEventListener("input", () => {
        saveData();
      });
    });
  });

</script>
<footer style="margin-top: 50px; padding: 20px; text-align: center; font-size: 14px; color: #666; border-top: 1px solid #ccc;">
  á»¨ng dá»¥ng nÃ y Ä‘Æ°á»£c thiáº¿t káº¿ bá»Ÿi <strong>VÃµ Thanh Phong</strong> vá»›i sá»± há»— trá»£ tá»« <strong>ChatGPT</strong>.<br>
  Báº£n quyá»n thuá»™c vá» <strong>VÃµ Thanh Phong</strong> â€“ Má»i quyá»n Ä‘Æ°á»£c báº£o lÆ°u.<br>
  LiÃªn há»‡: <a href="mailto:phongvanltk@gmail.com">phongvanltk@gmail.com</a>
</footer>
</body>
</html>



